<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAlgo V6 - True Liquidity Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e0e0e0; overflow: hidden; user-select: none; }
        .mono { font-family: 'Roboto Mono', monospace; }
        .bg-panel { background-color: #111318; }
        .border-line { border-color: #2a2e39; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }

        /* Order Book Bars */
        .bar-bid { position: absolute; right:0; top:0; height:100%; background: rgba(34, 197, 94, 0.15); transition: width 0.1s; }
        .bar-ask { position: absolute; left:0; top:0; height:100%; background: rgba(239, 68, 68, 0.15); transition: width 0.1s; }
        
        /* Layout Fixes */
        .h-calc-chart { height: calc(100% - 140px); } /* Chart takes remaining space minus controls */
        .h-controls { height: 140px; }
    </style>
</head>
<body class="flex h-screen w-screen text-[12px]">

    <aside class="w-12 bg-[#0b0e11] border-r border-line flex flex-col items-center py-4 z-50">
        <div class="w-8 h-8 bg-blue-700 rounded flex items-center justify-center font-bold text-white mb-6">S</div>
        <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]" id="status-light"></div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">
        
        <header class="h-12 bg-[#0b0e11] border-b border-line flex items-center px-4 justify-between shrink-0">
            <div class="flex items-center gap-6">
                <div><span class="text-gray-500 text-[9px] uppercase font-bold">Symbol</span><div class="font-bold text-lg text-white">$BBCA</div></div>
                <div><span class="text-gray-500 text-[9px] uppercase font-bold">Last Price</span><div class="font-bold text-xl mono" id="head-price">0</div></div>
                <div class="pl-6 border-l border-gray-800"><span class="text-gray-500 text-[9px] uppercase font-bold">Cash</span><div class="font-bold mono text-yellow-500" id="head-cash">0</div></div>
            </div>
            <div class="flex items-center gap-4 text-right">
                <div><span class="text-gray-500 text-[9px] uppercase font-bold">Position</span><div class="font-bold mono text-blue-400" id="head-pos">0</div></div>
                <div><span class="text-gray-500 text-[9px] uppercase font-bold">Float P/L</span><div class="font-bold mono text-gray-400" id="head-pl">0</div></div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            
            <div class="flex-1 flex flex-col relative border-r border-line">
                <div class="h-calc-chart w-full relative bg-[#050709]">
                    <canvas id="chartCanvas" class="block w-full h-full"></canvas>
                    <div class="absolute top-2 left-2 flex gap-2 pointer-events-none opacity-70">
                        <span class="bg-black/50 px-2 py-1 rounded text-[10px] text-gray-300 border border-gray-800" id="mode-display">NORMAL MODE</span>
                    </div>
                </div>

                <div class="h-controls bg-panel border-t border-line p-3 shrink-0">
                    <div class="grid grid-cols-12 gap-3 h-full">
                        <div class="col-span-3 flex flex-col justify-between">
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase font-bold">Market Mode</label>
                                <select id="sim-mode" onchange="APP.setMode()" class="w-full bg-black border border-gray-700 text-white text-xs p-1.5 rounded outline-none focus:border-blue-500">
                                    <option value="normal">Normal (Liquid & Organic)</option>
                                    <option value="hard">Hard (Wall Defense)</option>
                                    <option value="war">War (Smart Money Fight)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase font-bold">Order Lot</label>
                                <input type="number" id="user-lot" value="1000" class="w-full bg-black border border-gray-700 text-white text-xs p-1.5 rounded text-center font-mono">
                            </div>
                        </div>
                        
                        <div class="col-span-9 grid grid-cols-3 gap-2">
                            <button onclick="APP.startAlgo('buy')" id="btn-buy" class="bg-green-800 hover:bg-green-700 text-white font-bold rounded flex flex-col items-center justify-center border-b-4 border-green-950 transition active:scale-95">
                                <span class="text-sm">HAKA (BUY)</span>
                                <span class="text-[9px] opacity-60 font-normal">Accumulate</span>
                            </button>
                            <button onclick="APP.startAlgo('sell')" id="btn-sell" class="bg-red-800 hover:bg-red-700 text-white font-bold rounded flex flex-col items-center justify-center border-b-4 border-red-950 transition active:scale-95">
                                <span class="text-sm">HAKI (SELL)</span>
                                <span class="text-[9px] opacity-60 font-normal">Distribute</span>
                            </button>
                            <button onclick="APP.stopAlgo()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold rounded flex flex-col items-center justify-center border-b-4 border-gray-900 transition active:scale-95">
                                <span>STOP</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-[420px] flex flex-row bg-panel border-l border-line shrink-0">
                
                <div class="flex-1 flex flex-col min-w-0 border-r border-line">
                    <div class="p-1.5 bg-[#0b0e11] text-center text-[10px] font-bold text-gray-500 border-b border-line uppercase">Order Book</div>
                    <div class="grid grid-cols-3 text-[9px] font-bold text-gray-500 text-center py-1 bg-black/20">
                        <span>Bid Vol</span><span>Price</span><span>Ask Vol</span>
                    </div>
                    <div id="book-container" class="flex-1 overflow-y-auto bg-[#080a0d] relative"></div>
                </div>

                <div class="w-[160px] flex flex-col shrink-0">
                    <div class="p-1.5 bg-[#0b0e11] text-center text-[10px] font-bold text-gray-500 border-b border-line uppercase">Trade Log</div>
                    <div id="tape-container" class="flex-1 overflow-y-auto bg-[#080a0d] font-mono text-[10px]"></div>
                </div>

            </div>
        </div>
    </main>

<script>
/**
 * SMARTALGO V6 - REALISTIC LIQUIDITY ENGINE
 * Core Logic: Price only moves if volume at best bid/ask is fully consumed.
 */
const APP = {
    state: {
        lastPrice: 9850,
        cash: 1000000000,
        portfolio: { pos: 0, avg: 0 },
        
        // Data Structures
        bids: [], // [{price: 9825, vol: 5000}, ...]
        asks: [], // [{price: 9850, vol: 4500}, ...]
        trades: [],
        candles: [],
        currCandle: null,

        // Engine Params
        mode: 'normal',
        tickSpeed: 200, 
        algoInterval: null,
        trendBias: 0, // -1 to 1 (Bearish to Bullish)
        volatility: 1
    },

    init() {
        console.log("Engine V6 Started...");
        
        // 1. Initialize Deep Order Book (Liquid Market)
        this.resetBook(9850);
        
        // 2. Initialize Chart
        this.initChartHistory();

        // 3. Start Loops
        setInterval(() => this.marketPulse(), this.state.tickSpeed); // Market Heartbeat
        setInterval(() => this.closeCandle(), 5000); // 5s Candle
        this.render(); // Loop Visual
        
        // UI Init
        this.updateHeader();
    },

    // --- CORE: ORDER BOOK LOGIC ---
    resetBook(centerPrice) {
        this.state.bids = [];
        this.state.asks = [];
        // Create huge liquid walls
        for(let i=1; i<=20; i++) {
            this.state.bids.push({
                price: centerPrice - (i * 25),
                vol: this.genLiquidVol()
            });
            this.state.asks.push({
                price: centerPrice + ((i-1) * 25), // Start Ask exactly at center or tick above? Let's say center is last done. 
                // Correction: Best Ask should be > Last Price usually, or Last Price is executed at Ask.
                // Let's set Best Ask = center + 25, Best Bid = center.
                vol: this.genLiquidVol()
            });
        }
        // Fix gap
        this.state.asks = this.state.asks.map((a, i) => ({...a, price: centerPrice + ((i+1)*25)}));
        this.state.bids = this.state.bids.map((b, i) => ({...b, price: centerPrice - (i*25)}));
        
        // Sort
        this.state.bids.sort((a,b) => b.price - a.price); // Desc High to Low
        this.state.asks.sort((a,b) => a.price - b.price); // Asc Low to High
    },

    genLiquidVol() {
        // Real liquid volume: 1000 - 15000 lots
        return Math.floor(Math.random() * 8000) + 1000;
    },

    // --- CORE: MATCHING ENGINE (THE REALISM) ---
    executeOrder(side, vol, isUser) {
        if (vol <= 0) return;
        
        let remaining = vol;
        let executedPrice = this.state.lastPrice;
        let totalVal = 0;
        let avgPriceCalc = 0;

        // MATCHING LOOP
        while (remaining > 0) {
            let targetBook = (side === 'BUY') ? this.state.asks : this.state.bids;
            
            // If book empty (unlikely in liquid mode), break
            if (targetBook.length === 0) break;

            let bestLevel = targetBook[0];
            let tradeVol = 0;

            if (remaining >= bestLevel.vol) {
                // EAT ENTIRE LEVEL
                tradeVol = bestLevel.vol;
                remaining -= bestLevel.vol;
                executedPrice = bestLevel.price;
                
                // Remove level from book
                targetBook.shift();
                
                // Generate new depth level at the back to keep book full
                if(side === 'BUY') {
                    let lastP = this.state.asks[this.state.asks.length-1].price;
                    this.state.asks.push({price: lastP + 25, vol: this.genLiquidVol()});
                } else {
                    let lastP = this.state.bids[this.state.bids.length-1].price;
                    this.state.bids.push({price: lastP - 25, vol: this.genLiquidVol()});
                }

            } else {
                // PARTIAL FILL
                tradeVol = remaining;
                bestLevel.vol -= remaining;
                executedPrice = bestLevel.price;
                remaining = 0;
            }

            // Update System Logic
            this.updateTicker(executedPrice, tradeVol, side, isUser);
            totalVal += (executedPrice * tradeVol);
        }

        // Handle Portfolio Logic for User
        if (isUser) {
            let filledVol = vol - remaining;
            if (filledVol > 0) {
                let avgP = totalVal / filledVol;
                this.updatePortfolio(side, filledVol, avgP);
            }
        }
    },

    // --- MARKET PULSE (AI BOT) ---
    marketPulse() {
        const S = this.state;
        
        // 1. Trend Logic (Slow Drift)
        // Every 50 ticks, change bias slightly
        if(Math.random() < 0.05) S.trendBias = (Math.random() * 2) - 1; 

        // 2. Decide Action
        let buyProb = 0.5 + (S.trendBias * 0.1); // Bias influences probability
        
        // Mode Modifiers
        if (S.mode === 'hard') {
            // Defend Resistance (10,000) / Support (9,700)
            if (S.lastPrice > 9950) buyProb = 0.1; // Big Selling at top
            if (S.lastPrice < 9750) buyProb = 0.9; // Big Buying at bottom
        }

        let isBuy = Math.random() < buyProb;
        
        // 3. Volume Logic (Normal Retail vs Big Player)
        // 90% trades are small (1-500 lots), 10% are big (1000-5000 lots)
        let isBig = Math.random() < 0.1; 
        let vol = isBig ? Math.floor(Math.random()*4000)+1000 : Math.floor(Math.random()*200)+1;

        // 4. Execute
        this.executeOrder(isBuy ? 'BUY' : 'SELL', vol, false);

        // 5. Replenish Liquidity (Market Makers)
        // Randomly add volume to existing Bid/Ask to simulate cancelling/amending
        if(Math.random() < 0.3) {
            let randBid = S.bids[Math.floor(Math.random()*5)];
            if(randBid) randBid.vol += Math.floor(Math.random()*500);
            
            let randAsk = S.asks[Math.floor(Math.random()*5)];
            if(randAsk) randAsk.vol += Math.floor(Math.random()*500);
        }
    },

    // --- HELPERS ---
    updateTicker(price, vol, side, isUser) {
        this.state.lastPrice = price;
        
        // Candle Update
        const C = this.state.currCandle;
        C.close = price;
        if(price > C.high) C.high = price;
        if(price < C.low) C.low = price;

        // Tape Add
        this.state.trades.unshift({
            time: new Date().toLocaleTimeString('id-ID', {hour12:false}),
            price: price,
            vol: vol,
            side: side,
            user: isUser
        });
        if(this.state.trades.length > 30) this.state.trades.pop();
    },

    updatePortfolio(side, vol, price) {
        const P = this.state.portfolio;
        const val = price * vol * 100;

        if (side === 'BUY') {
            if (this.state.cash >= val) {
                this.state.cash -= val;
                let oldVal = P.pos * P.avg * 100;
                P.pos += vol;
                P.avg = (oldVal + val) / (P.pos * 100);
            }
        } else {
            // Simple Sell Logic
            if (P.pos > 0) {
                let sellVol = Math.min(vol, P.pos);
                this.state.cash += price * sellVol * 100;
                P.pos -= sellVol;
                if (P.pos === 0) P.avg = 0;
            }
        }
        this.updateHeader();
    },

    // --- ALGO BUTTONS ---
    startAlgo(type) {
        if(this.state.algoInterval) clearInterval(this.state.algoInterval);
        const lot = parseInt(document.getElementById('user-lot').value);
        
        const btn = document.getElementById(type === 'buy' ? 'btn-buy' : 'btn-sell');
        btn.classList.add('ring-2', 'ring-white', 'animate-pulse');

        this.state.algoInterval = setInterval(() => {
            this.executeOrder(type.toUpperCase(), lot, true);
        }, 200); // 5x per second HAKA/HAKI
    },

    stopAlgo() {
        if(this.state.algoInterval) clearInterval(this.state.algoInterval);
        this.state.algoInterval = null;
        document.querySelectorAll('button').forEach(b => b.classList.remove('ring-2', 'ring-white', 'animate-pulse'));
    },

    setMode() {
        this.state.mode = document.getElementById('sim-mode').value;
        document.getElementById('mode-display').innerText = this.state.mode.toUpperCase() + " MODE";
    },

    // --- VISUALS ---
    updateHeader() {
        const S = this.state;
        const headPrice = document.getElementById('head-price');
        headPrice.innerText = S.lastPrice.toLocaleString();
        
        // Color update based on Candle Open
        let openP = S.currCandle ? S.currCandle.open : S.lastPrice;
        headPrice.className = `font-bold text-xl mono ${S.lastPrice > openP ? 'text-green-500' : S.lastPrice < openP ? 'text-red-500' : 'text-white'}`;

        document.getElementById('head-cash').innerText = "IDR " + (S.cash/1000000).toFixed(1) + " Jt";
        document.getElementById('head-pos').innerText = S.portfolio.pos.toLocaleString();

        const pl = (S.lastPrice - S.portfolio.avg) * S.portfolio.pos * 100;
        const plEl = document.getElementById('head-pl');
        plEl.innerText = pl.toLocaleString();
        plEl.className = `font-bold mono ${pl > 0 ? 'text-green-500' : pl < 0 ? 'text-red-500' : 'text-gray-400'}`;
    },

    render() {
        requestAnimationFrame(() => this.render());
        
        // 1. Render Order Book (OPTIMIZED)
        const bookEl = document.getElementById('book-container');
        let html = '';
        
        // Show 10 levels best Asks (reversed to be on top)
        let asks = this.state.asks.slice(0, 10).reverse();
        asks.forEach(a => {
            let w = Math.min((a.vol/10000)*100, 100); // Max bar at 10k lots
            html += `
            <div class="grid grid-cols-3 text-[11px] py-[1px] hover:bg-gray-800 relative cursor-pointer" onclick="APP.executeOrder('BUY', ${a.vol}, true)">
                <div class="bar-ask" style="width:${w}%"></div>
                <span class="text-right pr-2 z-10 text-gray-700 font-mono">-</span>
                <span class="text-center z-10 text-red-500 font-bold font-mono">${a.price.toLocaleString()}</span>
                <span class="text-left pl-2 z-10 text-gray-400 font-mono">${a.vol.toLocaleString()}</span>
            </div>`;
        });

        // Current Price Spread Separator
        html += `<div class="bg-[#1a1d26] text-center text-[9px] text-gray-500 py-0.5 border-y border-gray-800">SPREAD</div>`;

        // Show 10 levels best Bids
        let bids = this.state.bids.slice(0, 10);
        bids.forEach(b => {
            let w = Math.min((b.vol/10000)*100, 100);
            html += `
            <div class="grid grid-cols-3 text-[11px] py-[1px] hover:bg-gray-800 relative cursor-pointer" onclick="APP.executeOrder('SELL', ${b.vol}, true)">
                <div class="bar-bid" style="width:${w}%"></div>
                <span class="text-right pr-2 z-10 text-gray-300 font-mono">${b.vol.toLocaleString()}</span>
                <span class="text-center z-10 text-green-500 font-bold font-mono">${b.price.toLocaleString()}</span>
                <span class="text-left pl-2 z-10 text-gray-700 font-mono">-</span>
            </div>`;
        });
        bookEl.innerHTML = html;

        // 2. Render Tape
        const tapeEl = document.getElementById('tape-container');
        let tHtml = '';
        this.state.trades.forEach(t => {
            let col = t.side === 'BUY' ? 'text-green-500' : 'text-red-500';
            let bg = t.user ? 'bg-blue-900/30' : '';
            tHtml += `
            <div class="grid grid-cols-3 px-1 border-b border-gray-800 py-0.5 ${bg}">
                <span class="text-gray-500">${t.time.split('.')[0]}</span>
                <span class="${col} text-center">${t.price}</span>
                <span class="text-right text-white">${t.vol}</span>
            </div>`;
        });
        tapeEl.innerHTML = tHtml;

        // 3. Render Chart
        this.drawChart();
    },

    // --- CHART ENGINE ---
    initChartHistory() {
        let p = 9800;
        for(let i=0; i<50; i++) {
            let o = p;
            let c = p + (Math.random()-0.5)*20;
            this.state.candles.push({open:o, close:c, high: Math.max(o,c)+5, low: Math.min(o,c)-5});
            p = c;
        }
        this.startCandle(p);
    },
    startCandle(p) { this.state.currCandle = {open:p, close:p, high:p, low:p}; },
    closeCandle() {
        this.state.candles.push({...this.state.currCandle});
        if(this.state.candles.length > 80) this.state.candles.shift();
        this.startCandle(this.state.currCandle.close);
    },
    drawChart() {
        const c = document.getElementById('chartCanvas');
        const ctx = c.getContext('2d');
        
        // Auto Resize
        if(c.width !== c.parentElement.clientWidth) {
            c.width = c.parentElement.clientWidth;
            c.height = c.parentElement.clientHeight;
        }
        const w = c.width; 
        const h = c.height;

        // Bg
        ctx.fillStyle = '#050709';
        ctx.fillRect(0,0,w,h);

        // Grid
        ctx.strokeStyle = '#1e222d'; ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<h; i+=40) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
        ctx.stroke();

        // Data Scale
        const data = [...this.state.candles, this.state.currCandle];
        let vals = data.map(d=>[d.high, d.low]).flat();
        let min = Math.min(...vals) - 10;
        let max = Math.max(...vals) + 10;
        const getY = p => h - ((p-min)/(max-min))*h;
        const barW = (w-20) / data.length;

        // Draw Candles
        data.forEach((d, i) => {
            let x = 10 + (i*barW);
            let isUp = d.close >= d.open;
            ctx.strokeStyle = isUp ? '#22c55e' : '#ef4444';
            ctx.fillStyle = isUp ? '#22c55e' : '#ef4444';
            
            // Wick
            ctx.beginPath();
            ctx.moveTo(x + barW/2, getY(d.high));
            ctx.lineTo(x + barW/2, getY(d.low));
            ctx.stroke();

            // Body
            let bodyH = Math.max(1, Math.abs(getY(d.open) - getY(d.close)));
            ctx.fillRect(x + 1, getY(Math.max(d.open, d.close)), barW - 2, bodyH);
        });

        // Price Line
        let py = getY(this.state.lastPrice);
        ctx.strokeStyle = '#fff';
        ctx.setLineDash([2,4]);
        ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(w, py); ctx.stroke(); ctx.setLineDash([]);
    }
};

window.onload = () => APP.init();
</script>
</body>
</html>
