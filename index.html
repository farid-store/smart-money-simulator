<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL PRO v5.1 // TRADINGVIEW & STOCKBIT HYBRID</title>
    <style>
        :root {
            --bg-app: #0c0c0c;
            --bg-panel: #141414;
            --bg-hover: #1e1e1e;
            --border: #2a2a2a;
            --text-main: #d1d4dc;
            --text-dim: #808080;
            --up: #26a69a;
            --down: #ef5350;
            --accent: #2962ff;
            --font-ui: 'Inter', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        body { margin: 0; background: var(--bg-app); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; height: 100vh; }

        .app-grid {
            display: grid;
            grid-template-rows: 45px 1fr 28px;
            height: 100vh;
        }

        /* HEADER */
        header { display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--border); background: var(--bg-panel); }
        .ticker-info { display: flex; align-items: center; gap: 15px; }
        .symbol { font-weight: 800; font-size: 16px; color: #fff; }
        .price-display { font-family: var(--font-mono); font-size: 18px; font-weight: bold; }

        /* MAIN CONTENT */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 340px 300px;
            overflow: hidden;
        }

        /* CHART SECTION (TRADINGVIEW STYLE) */
        .chart-container { 
            position: relative; 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            background: #131722; 
        }
        .chart-toolbar { 
            height: 38px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            padding: 0 10px; 
            gap: 5px; 
            background: var(--bg-panel);
        }
        #chartCanvas { width: 100%; height: 100%; cursor: crosshair; }

        /* BID-OFFER (STOCKBIT STYLE) */
        .orderbook-panel { display: flex; flex-direction: column; border-right: 1px solid var(--border); background: var(--bg-panel); }
        .ob-header { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            text-align: center; 
            font-size: 11px; 
            font-weight: bold; 
            border-bottom: 1px solid var(--border);
            background: #1a1a1a;
        }
        .ob-side-header { padding: 8px; border-right: 1px solid var(--border); }
        .ob-columns { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; font-size: 10px; color: var(--text-dim); padding: 5px 0; border-bottom: 1px solid var(--border); }
        .ob-table { flex: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; position: relative; }
        .ob-column { display: flex; flex-direction: column; }
        .ob-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            height: 22px; 
            align-items: center; 
            font-family: var(--font-mono); 
            font-size: 12px; 
            border-bottom: 1px solid #1a1a1a;
            position: relative;
        }
        .vol-bar { position: absolute; height: 100%; top: 0; opacity: 0.15; z-index: 0; transition: width 0.3s; }
        .bid-bar { right: 0; background: var(--up); }
        .offer-bar { left: 0; background: var(--down); }
        .val { position: relative; z-index: 1; padding: 0 8px; }

        /* RIGHT PANEL: TAPE & EXECUTION */
        .right-panel { display: grid; grid-template-rows: 1fr 280px; }
        .tape-list { flex: 1; overflow-y: auto; font-family: var(--font-mono); font-size: 11px; padding: 5px; }
        .tape-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 3px 5px; border-bottom: 1px solid #1a1a1a; }
        
        /* CONTROLS */
        .controls { padding: 15px; background: var(--bg-panel); border-top: 1px solid var(--border); }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .inp { background: #000; border: 1px solid var(--border); color: #fff; padding: 8px; font-family: var(--font-mono); width: 100%; border-radius: 4px; }
        .btn { border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-buy { background: var(--up); color: #000; }
        .btn-sell { background: var(--down); color: #fff; }
        .btn-algo { background: #333; color: #fff; font-size: 10px; }
        .btn:hover { filter: brightness(1.2); }

        footer { background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 11px; color: var(--text-dim); }

        .tf-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .tf-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body>

<div class="app-grid">
    <header>
        <div class="ticker-info">
            <span class="symbol">BBCA</span>
            <span id="header-price" class="price-display">9,850</span>
            <span id="header-diff" style="font-size: 12px;">+75 (0.76%)</span>
        </div>
        <div style="color: var(--accent); font-weight: bold; font-size: 12px;">LIVE MARKET DATA</div>
    </header>

    <main class="main-content">
        <div class="chart-container">
            <div class="chart-toolbar">
                <button class="tf-btn active" onclick="setTF('M1')">1m</button>
                <button class="tf-btn" onclick="setTF('M5')">5m</button>
                <button class="tf-btn" onclick="setTF('D')">D</button>
            </div>
            <canvas id="chartCanvas"></canvas>
        </div>

        <div class="orderbook-panel">
            <div class="ob-header">
                <div class="ob-side-header" style="color: var(--up)">BID</div>
                <div class="ob-side-header" style="color: var(--down)">OFFER</div>
            </div>
            <div class="ob-columns">
                <span style="text-align:left; padding-left:10px">VOL</span>
                <span style="text-align:right; padding-right:10px">PRICE</span>
                <span style="text-align:left; padding-left:10px">PRICE</span>
                <span style="text-align:right; padding-right:10px">VOL</span>
            </div>
            <div class="ob-table" id="order-book-ui">
                </div>
        </div>

        <div class="right-panel">
            <div style="display:flex; flex-direction:column; border-bottom: 1px solid var(--border)">
                <div style="padding: 10px; font-size: 11px; font-weight: bold; border-bottom:1px solid var(--border)">TIME & SALES</div>
                <div class="tape-list" id="tape-list"></div>
            </div>
            <div class="controls">
                <div class="input-group">
                    <input type="number" id="qty-input" class="inp" value="100">
                    <input type="number" id="algo-speed" class="inp" value="500" placeholder="ms">
                </div>
                <div class="input-group">
                    <button class="btn btn-buy" onclick="manualOrder('BUY')">BUY</button>
                    <button class="btn btn-sell" onclick="manualOrder('SELL')">SELL</button>
                </div>
                <div style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <button class="btn btn-algo" onclick="startMM('accum')">ACCUMULATE</button>
                    <button class="btn btn-algo" onclick="startMM('dist')">DISTRIBUTE</button>
                    <button class="btn btn-algo" style="color: #ef5350" onclick="panic()">PANIC DUMP</button>
                    <button class="btn btn-algo" style="color: #ffc107" onclick="stopAlgo()">STOP ALGO</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div>SYSTEM READY // SERVER: SG-1</div>
        <div id="pl-display" class="font-mono">P/L: 0.00%</div>
    </footer>
</div>

<script>
    // --- GLOBAL STATE ---
    const STATE = {
        price: 9850,
        prevClose: 9775,
        candles: [],
        tf: 'M1',
        book: { bids: [], asks: [] },
        mouse: { x: 0, y: 0, active: false },
        algoId: null
    };

    const canvas = document.getElementById('chartCanvas');
    const ctx = canvas.getContext('2d');

    // --- ENGINE: DATA ---
    function init() {
        // Generate history
        let p = 9700;
        for(let i=0; i<100; i++) {
            let o = p;
            let c = p + (Math.random() - 0.45) * 40;
            STATE.candles.push({ o, h: Math.max(o,c)+5, l: Math.min(o,c)-5, c, v: Math.random()*1000 });
            p = c;
        }
        STATE.price = p;
        generateBook();
        resize();
        render();
        setInterval(marketMakerLogic, 2000); // Organic movement
    }

    function generateBook() {
        STATE.book.bids = [];
        STATE.book.asks = [];
        for(let i=0; i<15; i++) {
            STATE.book.bids.push({ p: STATE.price - (i * 25), v: Math.floor(Math.random()*5000) + 100 });
            STATE.book.asks.push({ p: STATE.price + ((i+1) * 25), v: Math.floor(Math.random()*5000) + 100 });
        }
        renderBook();
    }

    // --- ENGINE: CHART (TRADINGVIEW STYLE) ---
    function render() {
        if(!canvas.width) return;
        ctx.fillStyle = '#131722';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const marginR = 60;
        const chartW = canvas.width - marginR;
        const chartH = canvas.height - 30;

        let visible = STATE.candles.slice(-60);
        let min = Math.min(...visible.map(d => d.l));
        let max = Math.max(...visible.map(d => d.h));
        let range = max - min;
        
        // Grid
        ctx.strokeStyle = '#2a2e39';
        ctx.lineWidth = 0.5;
        for(let i=0; i<6; i++) {
            let y = (i * chartH/6);
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(chartW, y); ctx.stroke();
            // Price labels on Right
            ctx.fillStyle = '#9194a3';
            ctx.font = '10px Arial';
            let p = max - (i * range/6);
            ctx.fillText(p.toFixed(0), chartW + 5, y + 4);
        }

        // Candles
        const candleW = chartW / 60;
        visible.forEach((d, i) => {
            let x = i * candleW;
            let isUp = d.c >= d.o;
            ctx.fillStyle = isUp ? '#26a69a' : '#ef5350';
            ctx.strokeStyle = ctx.fillStyle;

            let yO = chartH - ((d.o - min) / range * chartH);
            let yC = chartH - ((d.c - min) / range * chartH);
            let yH = chartH - ((d.h - min) / range * chartH);
            let yL = chartH - ((d.l - min) / range * chartH);

            // Wick
            ctx.beginPath();
            ctx.moveTo(x + candleW/2, yH);
            ctx.lineTo(x + candleW/2, yL);
            ctx.stroke();

            // Body
            ctx.fillRect(x + 2, Math.min(yO, yC), candleW - 4, Math.max(Math.abs(yO - yC), 1));
        });

        // Last Price Line
        let lastY = chartH - ((STATE.price - min) / range * chartH);
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = '#fff';
        ctx.beginPath(); ctx.moveTo(0, lastY); ctx.lineTo(chartW, lastY); ctx.stroke();
        ctx.setLineDash([]);
        
        // Price Tag
        ctx.fillStyle = STATE.price >= STATE.prevClose ? '#26a69a' : '#ef5350';
        ctx.fillRect(chartW, lastY - 10, marginR, 20);
        ctx.fillStyle = '#fff';
        ctx.fillText(STATE.price.toFixed(0), chartW + 8, lastY + 4);

        // Crosshair
        if(STATE.mouse.active && STATE.mouse.x < chartW) {
            ctx.strokeStyle = '#758696';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(STATE.mouse.x, 0); ctx.lineTo(STATE.mouse.x, chartH);
            ctx.moveTo(0, STATE.mouse.y); ctx.lineTo(chartW, STATE.mouse.y);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        requestAnimationFrame(render);
    }

    // --- ENGINE: ORDERBOOK (STOCKBIT STYLE) ---
    function renderBook() {
        const container = document.getElementById('order-book-ui');
        let html = '<div class="ob-column">';
        
        // Max Volume for bar scaling
        let maxV = Math.max(...STATE.book.bids.map(b => b.v), ...STATE.book.asks.map(a => a.v));

        // Bid Side
        STATE.book.bids.forEach(b => {
            let w = (b.v / maxV) * 100;
            html += `
                <div class="ob-row">
                    <div class="vol-bar bid-bar" style="width: ${w}%"></div>
                    <div class="val" style="color:var(--text-dim)">${b.v.toLocaleString()}</div>
                    <div class="val" style="text-align:right; color:var(--up); font-weight:bold">${b.p.toLocaleString()}</div>
                </div>`;
        });
        html += '</div><div class="ob-column">';

        // Offer Side
        STATE.book.asks.forEach(a => {
            let w = (a.v / maxV) * 100;
            html += `
                <div class="ob-row">
                    <div class="vol-bar offer-bar" style="width: ${w}%"></div>
                    <div class="val" style="color:var(--down); font-weight:bold">${a.p.toLocaleString()}</div>
                    <div class="val" style="text-align:right; color:var(--text-dim)">${a.v.toLocaleString()}</div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
        updateHeader();
    }

    // --- LOGIC: TRADING ---
    function trade(side, qty) {
        if(side === 'BUY') {
            STATE.price = STATE.book.asks[0].p;
            STATE.book.asks[0].v -= qty;
            if(STATE.book.asks[0].v <= 0) {
                STATE.book.asks.shift();
                STATE.book.asks.push({p: STATE.book.asks[STATE.book.asks.length-1].p + 25, v: Math.floor(Math.random()*4000)});
                STATE.book.bids.unshift({p: STATE.price, v: Math.floor(Math.random()*2000)});
                STATE.book.bids.pop();
            }
        } else {
            STATE.price = STATE.book.bids[0].p;
            STATE.book.bids[0].v -= qty;
            if(STATE.book.bids[0].v <= 0) {
                STATE.book.bids.shift();
                STATE.book.bids.push({p: STATE.book.bids[STATE.book.bids.length-1].p - 25, v: Math.floor(Math.random()*4000)});
                STATE.book.asks.unshift({p: STATE.price, v: Math.floor(Math.random()*2000)});
                STATE.book.asks.pop();
            }
        }
        
        // Update Candle
        let last = STATE.candles[STATE.candles.length-1];
        last.c = STATE.price;
        last.h = Math.max(last.h, STATE.price);
        last.l = Math.min(last.l, STATE.price);
        last.v += qty;

        addToTape(side, STATE.price, qty);
        renderBook();
    }

    function addToTape(side, p, q) {
        const tape = document.getElementById('tape-list');
        const row = document.createElement('div');
        row.className = 'tape-row';
        row.style.color = side === 'BUY' ? 'var(--up)' : 'var(--down)';
        row.innerHTML = `<span>${new Date().toLocaleTimeString('en-GB')}</span><span style="text-align:center">${p}</span><span style="text-align:right">${q}</span>`;
        tape.prepend(row);
        if(tape.children.length > 30) tape.lastChild.remove();
    }

    function updateHeader() {
        const hp = document.getElementById('header-price');
        hp.innerText = STATE.price.toLocaleString();
        hp.style.color = STATE.price >= STATE.prevClose ? 'var(--up)' : 'var(--down)';
        
        let diff = STATE.price - STATE.prevClose;
        let pct = (diff / STATE.prevClose * 100).toFixed(2);
        document.getElementById('header-diff').innerText = `${diff > 0 ? '+':''}${diff} (${pct}%)`;
        document.getElementById('header-diff').style.color = hp.style.color;
    }

    // --- ALGO / MM TOOLS ---
    function manualOrder(side) {
        let q = parseInt(document.getElementById('qty-input').value);
        trade(side, q);
    }

    function startMM(type) {
        stopAlgo();
        let speed = parseInt(document.getElementById('algo-speed').value);
        STATE.algoId = setInterval(() => {
            let side = type === 'accum' ? 'BUY' : 'SELL';
            trade(side, Math.floor(Math.random() * 500));
        }, speed);
    }

    function panic() {
        stopAlgo();
        let count = 0;
        let int = setInterval(() => {
            trade('SELL', 2000);
            count++;
            if(count > 10) clearInterval(int);
        }, 50);
    }

    function stopAlgo() {
        if(STATE.algoId) clearInterval(STATE.algoId);
    }

    function marketMakerLogic() {
        // Natural drift
        if(!STATE.algoId) {
            let side = Math.random() > 0.5 ? 'BUY' : 'SELL';
            trade(side, Math.floor(Math.random() * 100));
        }
    }

    // --- UI HELPERS ---
    function resize() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }

    window.addEventListener('resize', resize);
    canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        STATE.mouse.x = e.clientX - rect.left;
        STATE.mouse.y = e.clientY - rect.top;
        STATE.mouse.active = true;
    });
    canvas.addEventListener('mouseleave', () => STATE.mouse.active = false);

    init();
</script>
</body>
</html>
