<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM PRO TERMINAL v7.0 - ARCHITECT EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- PROFESSIONAL THEME --- */
        :root {
            --bg-base: #0b0e11; --bg-panel: #151a1e; --border: #2a2e39;
            --text-pri: #eaecef; --text-sec: #848e9c;
            --buy: #0ecb81; --sell: #f6465d;
            --buy-dim: rgba(14, 203, 129, 0.15); --sell-dim: rgba(246, 70, 93, 0.15);
        }
        
        body { background: var(--bg-base); color: var(--text-pri); font-family: 'Inter', sans-serif; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .text-buy { color: var(--buy); } .text-sell { color: var(--sell); }
        .bg-buy { background-color: var(--buy); } .bg-sell { background-color: var(--sell); }
        
        /* Layout Grid */
        .grid-layout { display: grid; grid-template-columns: 280px 1fr 260px; grid-template-rows: 50px 1fr 200px; height: 100vh; w-full; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        
        /* Canvas Sharpness */
        canvas { image-rendering: crisp-edges; }
        
        /* Utilities */
        .panel { background: var(--bg-panel); border: 1px solid var(--border); }
        .blink-up { animation: flashGreen 0.2s; }
        .blink-down { animation: flashRed 0.2s; }
        @keyframes flashGreen { 0% { background: var(--buy); color:black; } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: var(--sell); color:white; } 100% { background: transparent; } }
    </style>
</head>
<body>

    <div class="grid-layout">
        <header class="col-span-3 bg-[#151a1e] border-b border-[#2a2e39] flex items-center justify-between px-4">
            <div class="flex items-center gap-6">
                <div class="flex flex-col">
                    <span class="text-lg font-black tracking-tight text-white">BTC/USDT</span>
                    <span class="text-[9px] text-gray-500 font-bold bg-[#2a2e39] px-1 rounded w-max">PERPETUAL</span>
                </div>
                <div class="h-8 w-[1px] bg-[#2a2e39]"></div>
                <div class="flex flex-col">
                    <span id="price-display" class="text-2xl font-bold mono tracking-tighter text-buy">45,250.00</span>
                    <span class="text-[10px] text-gray-400 mono">Vol: <span id="vol-display">2.4M</span></span>
                </div>
            </div>

            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-widest text-gray-500 font-bold mb-1">Market Micro-Structure</span>
                <div id="market-phase" class="px-3 py-1 bg-[#2a2e39] rounded text-[10px] font-bold text-blue-400 mono border border-blue-500/20">
                    PHASE: ACCUMULATION
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="text-right">
                    <span class="text-[9px] text-gray-500 block uppercase">Net Inventory</span>
                    <span id="mm-inventory" class="text-sm font-bold mono text-white">0</span>
                </div>
                <div class="text-right">
                    <span class="text-[9px] text-gray-500 block uppercase">Floating PnL</span>
                    <span id="mm-pnl" class="text-sm font-bold mono text-gray-500">$0.00</span>
                </div>
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#0ecb81]"></div>
            </div>
        </header>

        <aside class="row-span-2 border-r border-[#2a2e39] bg-[#0b0e11] flex flex-col">
            <div class="p-2 border-b border-[#2a2e39] flex justify-between text-[10px] text-gray-400 font-bold">
                <span>Price(USDT)</span>
                <span>Amount(BTC)</span>
            </div>
            
            <div id="ob-asks" class="flex-1 overflow-hidden flex flex-col-reverse font-mono text-[11px] relative"></div>
            
            <div id="spread-box" class="h-8 flex items-center justify-center text-[11px] font-bold text-gray-300 border-y border-[#2a2e39] bg-[#151a1e]">
                <span id="last-price" class="text-lg mr-2">45,250.00</span>
                <span class="text-[9px] text-gray-500">Spread: 0.5</span>
            </div>

            <div id="ob-bids" class="flex-1 overflow-hidden font-mono text-[11px] relative"></div>
        </aside>

        <main class="relative bg-[#0b0e11] cursor-crosshair overflow-hidden">
            <canvas id="chart" class="block w-full h-full"></canvas>
            
            <div class="absolute top-4 left-4 pointer-events-none">
                <div id="fib-status" class="text-[9px] text-yellow-500 font-mono hidden">FIB GOLDEN POCKET ACTIVE</div>
                <div id="pattern-status" class="text-[9px] text-blue-500 font-mono mt-1"></div>
            </div>

            <div id="toast" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 px-6 py-3 bg-[#1e2329] border border-[#2a2e39] text-white font-bold text-xs rounded shadow-2xl opacity-0 transition-opacity pointer-events-none z-50">
                MARKET UPDATE
            </div>
        </main>

        <aside class="row-span-2 border-l border-[#2a2e39] bg-[#151a1e] flex flex-col">
            <div class="p-3 border-b border-[#2a2e39]">
                <div class="flex justify-between text-[9px] text-gray-500 mb-2 uppercase font-bold">
                    <span>Retail Sentiment</span>
                    <span id="sentiment-val" class="text-white">50%</span>
                </div>
                <div class="w-full h-1 bg-[#2a2e39] rounded-full overflow-hidden">
                    <div id="sentiment-bar" class="h-full bg-blue-500 w-1/2 transition-all duration-500"></div>
                </div>
            </div>

            <div class="flex-1 flex flex-col min-h-0 bg-[#0b0e11]">
                <div class="px-2 py-1 text-[9px] font-bold text-gray-500 border-b border-[#2a2e39]">RECENT TRADES</div>
                <div id="tape" class="flex-1 overflow-hidden relative font-mono text-[10px]">
                    <div id="tape-content" class="absolute bottom-0 w-full flex flex-col-reverse"></div>
                </div>
            </div>
        </aside>

        <div class="col-start-2 border-t border-[#2a2e39] bg-[#151a1e] p-3 flex gap-4">
            
            <div class="w-48 border-r border-[#2a2e39] pr-4 flex flex-col justify-center">
                <div class="text-[9px] text-gray-500 font-bold uppercase mb-1">MM Action Panel</div>
                <div class="grid grid-cols-2 gap-2">
                    <button onmousedown="Engine.injectVolatility(1)" class="bg-[#2a2e39] hover:bg-gray-700 text-gray-300 text-[9px] py-2 rounded font-bold border border-gray-700">
                        VOLATILITY +
                    </button>
                    <button onmousedown="Engine.triggerLiquidityHunt()" class="bg-[#2a2e39] hover:bg-yellow-900/30 text-yellow-500 text-[9px] py-2 rounded font-bold border border-yellow-900/30">
                        LIQ HUNT
                    </button>
                </div>
            </div>

            <div class="flex-1 flex gap-2">
                <div class="flex-1 flex flex-col gap-1">
                    <button onclick="Engine.executeOrder('BUY')" class="flex-1 bg-buy hover:opacity-90 text-[#0b0e11] font-black rounded text-sm transition-transform active:scale-95 flex items-center justify-center gap-2">
                        <span>ACCUMULATE / PUMP</span>
                        <span class="text-[9px] opacity-70">(HKA)</span>
                    </button>
                    <div class="flex justify-between px-1 text-[9px] text-gray-500 font-bold">
                        <span>INV: <span id="btn-inv-buy" class="text-buy">0</span></span>
                    </div>
                </div>

                <div class="flex-1 flex flex-col gap-1">
                    <button onclick="Engine.executeOrder('SELL')" class="flex-1 bg-sell hover:opacity-90 text-white font-black rounded text-sm transition-transform active:scale-95 flex items-center justify-center gap-2">
                        <span>DISTRIBUTE / DUMP</span>
                        <span class="text-[9px] opacity-70">(HKI)</span>
                    </button>
                    <div class="flex justify-between px-1 text-[9px] text-gray-500 font-bold">
                        <span>INV: <span id="btn-inv-sell" class="text-sell">0</span></span>
                    </div>
                </div>
            </div>

            <div class="w-32 border-l border-[#2a2e39] pl-4 flex flex-col gap-2 justify-center">
                <span class="text-[8px] text-gray-500 font-bold uppercase">Force Pattern</span>
                <button onclick="Engine.setBias('BULL_FLAG')" class="bg-[#1e2329] hover:bg-blue-900/20 text-blue-400 text-[9px] py-1 px-2 rounded border border-blue-900/30">Bull Flag</button>
                <button onclick="Engine.setBias('BEAR_FLAG')" class="bg-[#1e2329] hover:bg-red-900/20 text-red-400 text-[9px] py-1 px-2 rounded border border-red-900/30">Bear Flag</button>
            </div>
        </div>
    </div>

    <script>
        // --- MATH & UTILS ---
        const rnd = (min, max) => Math.random() * (max - min) + min;
        const rndInt = (min, max) => Math.floor(rnd(min, max));
        const formatPrice = (p) => p.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // --- MARKET PHYSICS ENGINE ---
        const Engine = {
            price: 45250.00,
            targetPrice: 45250.00,
            velocity: 0,
            inventory: 0, // MM Net Position
            sentiment: 50, // 0-100 (Retail FOMO Meter)
            
            // Market Structure State
            state: 'RANGE', // RANGE, TREND_UP, TREND_DOWN, BULL_FLAG, BEAR_FLAG, SPIKE
            stateTimer: 0,
            
            // Technicals
            candles: [],
            currentCandle: null,
            fibLevels: { h: 0, l: 0, levels: [] },
            snrLevels: [],
            
            // Loop controls
            tick: 0,
            
            init() {
                // Pre-fill history
                let p = this.price;
                for(let i=0; i<100; i++) {
                    const o = p;
                    const c = o + rnd(-50, 50);
                    const h = Math.max(o, c) + rnd(0, 30);
                    const l = Math.min(o, c) - rnd(0, 30);
                    this.candles.push({o, h, l, c});
                    p = c;
                }
                this.price = p;
                this.startCandle();
                this.updateTechnicals();
                
                // Start Loop
                this.loop();
            },

            startCandle() {
                this.currentCandle = { o: this.price, h: this.price, l: this.price, c: this.price, v: 0 };
                this.tick = 0;
            },

            updateTechnicals() {
                // Calculate Fib based on last 100 candles
                const visible = this.candles.slice(-80);
                let max = -Infinity, min = Infinity;
                visible.forEach(c => {
                    if(c.h > max) max = c.h;
                    if(c.l < min) min = c.l;
                });
                
                // Only update fib if range is significant
                if(max - min > 200) {
                    const diff = max - min;
                    this.fibLevels = {
                        h: max, l: min,
                        levels: [
                            { val: min + diff * 0.5, label: '0.5' },
                            { val: min + diff * 0.618, label: '0.618' } // Golden Ratio
                        ]
                    };
                }
            },

            // --- THE BRAIN: MOVEMENT LOGIC ---
            calculateNextMove() {
                this.stateTimer++;
                
                // 1. STATE MANAGEMENT (Randomly switch behavior to simulate randomness)
                if(this.stateTimer > rndInt(50, 200)) {
                    this.stateTimer = 0;
                    const rand = Math.random();
                    if(rand < 0.4) this.state = 'RANGE'; // 40% Sideways
                    else if(rand < 0.6) this.state = 'TREND_UP';
                    else if(rand < 0.8) this.state = 'TREND_DOWN';
                    else this.state = Math.random() > 0.5 ? 'BULL_FLAG' : 'BEAR_FLAG';
                    
                    UI.updateState(this.state);
                }

                // 2. FORCE VECTORS
                let momentum = 0;
                let noise = (Math.random() - 0.5) * 5; // Basic volatility

                // State Bias
                if(this.state === 'TREND_UP') momentum = 1.5;
                if(this.state === 'TREND_DOWN') momentum = -1.5;
                if(this.state === 'SPIKE_UP') momentum = 8; // Violent Move
                if(this.state === 'SPIKE_DOWN') momentum = -8;
                
                // Flag Logic (Contraction)
                if(this.state === 'BULL_FLAG') {
                    momentum = -0.3; // Slight drift down
                    noise *= 0.5; // Lower volatility
                }

                // 3. TECHNICAL RESPECT (FIBONACCI GRAVITY)
                // If price is near Golden Ratio, pull it in (consolidation) or reject it
                let techGravity = 0;
                this.fibLevels.levels.forEach(lvl => {
                    const dist = lvl.val - this.price;
                    if(Math.abs(dist) < 50) { // Near level
                        techGravity = dist * 0.1; // Pull towards line
                        UI.showFibActive(true);
                    }
                });
                if(techGravity === 0) UI.showFibActive(false);

                // 4. INVENTORY PRESSURE (MM Logic)
                // If MM holds too much Long, price naturally wants to drop (supply overhang)
                const inventoryPressure = -this.inventory * 0.05;

                // 5. RETAIL SENTIMENT
                // If FOMO (>80), Momentum increases (Herd Mentality)
                const retailForce = (this.sentiment - 50) * 0.05;

                // FINAL VELOCITY CALCULATION
                const totalForce = momentum + techGravity + inventoryPressure + retailForce + noise;
                
                // Apply physics (Acceleration/Deceleration)
                this.velocity = (this.velocity + totalForce) * 0.9; // Friction
                this.price += this.velocity;
            },

            updateCandleLogic() {
                const c = this.currentCandle;
                c.c = this.price;
                if(c.c > c.h) c.h = c.c;
                if(c.c < c.l) c.l = c.c;
                
                // Volume Simulation
                const volTick = Math.abs(this.velocity) * rnd(1, 10);
                c.v += volTick;

                // Timeframe close (e.g., every 60 frames)
                this.tick++;
                if(this.tick > 60) {
                    this.candles.push({...c});
                    if(this.candles.length > 200) this.candles.shift();
                    this.startCandle();
                    this.updateTechnicals(); // Recalculate Fibs on candle close
                    this.tick = 0;
                }
            },

            // --- MM ACTIONS ---
            executeOrder(side) {
                const impact = side === 'BUY' ? 25 : -25;
                this.velocity += impact; // Impulse
                
                const lots = rndInt(5, 20);
                if(side === 'BUY') {
                    this.inventory += lots;
                    this.sentiment += 5; // Trigger FOMO
                } else {
                    this.inventory -= lots;
                    this.sentiment -= 5; // Trigger Panic
                }
                
                this.sentiment = Math.max(0, Math.min(100, this.sentiment));
                UI.showToast(side === 'BUY' ? 'INSTITUTIONAL PUMP' : 'INSTITUTIONAL DUMP');
            },

            injectVolatility(val) {
                this.velocity += (Math.random() - 0.5) * 50;
                UI.showToast("VOLATILITY INJECTED");
            },
            
            triggerLiquidityHunt() {
                // Rapidly go towards the nearest swing high/low then reverse
                this.state = Math.random() > 0.5 ? 'SPIKE_UP' : 'SPIKE_DOWN';
                this.stateTimer = -50; // Force short duration
                UI.showToast("⚠️ LIQUIDITY SWEEP DETECTED");
            },

            setBias(bias) {
                this.state = bias;
                this.stateTimer = 0; // Reset timer
                UI.showToast(`FORCED PATTERN: ${bias}`);
            },

            loop() {
                this.calculateNextMove();
                this.updateCandleLogic();
                
                // Updates
                Chart.draw();
                UI.update();
                Orderbook.update();
                
                requestAnimationFrame(this.loop.bind(this));
            }
        };

        // --- ORDERBOOK VISUALIZER ---
        const Orderbook = {
            update() {
                const p = Engine.price;
                let askHtml = '', bidHtml = '';
                
                // Generate dynamic depth
                // Asks
                for(let i=8; i>=1; i--) {
                    const price = p + (i * 2.5);
                    const vol = (Math.sin(Date.now()/1000 + i) + 2) * rnd(0.1, 2); // Dynamic breathing volume
                    const width = Math.min(vol * 20, 100);
                    askHtml += `
                        <div class="flex justify-between relative px-2 py-0.5">
                            <div class="absolute right-0 top-0 bottom-0 bg-sell-dim transition-all duration-75" style="width:${width}%"></div>
                            <span class="z-10 text-sell">${formatPrice(price)}</span>
                            <span class="z-10 text-gray-400">${vol.toFixed(3)}</span>
                        </div>`;
                }
                // Bids
                for(let i=1; i<=8; i++) {
                    const price = p - (i * 2.5);
                    const vol = (Math.cos(Date.now()/1000 + i) + 2) * rnd(0.1, 2);
                    const width = Math.min(vol * 20, 100);
                    bidHtml += `
                        <div class="flex justify-between relative px-2 py-0.5">
                            <div class="absolute right-0 top-0 bottom-0 bg-buy-dim transition-all duration-75" style="width:${width}%"></div>
                            <span class="z-10 text-buy">${formatPrice(price)}</span>
                            <span class="z-10 text-gray-400">${vol.toFixed(3)}</span>
                        </div>`;
                }

                document.getElementById('ob-asks').innerHTML = askHtml;
                document.getElementById('ob-bids').innerHTML = bidHtml;
                document.getElementById('last-price').innerHTML = formatPrice(p);
                document.getElementById('last-price').className = `text-lg mr-2 mono font-bold ${Engine.velocity >= 0 ? 'text-buy' : 'text-sell'}`;
            }
        };

        // --- CANVAS CHART ---
        const Chart = {
            canvas: document.getElementById('chart'),
            ctx: document.getElementById('chart').getContext('2d'),
            
            draw() {
                const { canvas, ctx } = this;
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                const w = canvas.width, h = canvas.height;

                // Background
                ctx.fillStyle = '#0b0e11'; ctx.fillRect(0,0,w,h);
                
                // Grid
                ctx.strokeStyle = '#1e2329'; ctx.lineWidth = 1;
                for(let x=0; x<w; x+=100) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
                for(let y=0; y<h; y+=60) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

                // Scaling
                const data = [...Engine.candles, Engine.currentCandle];
                const visible = data.slice(-80); // Zoom level
                
                // Get range including Fibs to keep context
                let min = Math.min(...visible.map(c=>c.l));
                let max = Math.max(...visible.map(c=>c.h));
                const range = max - min;
                const padding = range * 0.2;
                min -= padding; max += padding;

                const toY = (p) => h - ((p - min) / (max - min) * h);
                const cWidth = (w / 80) * 0.7;
                
                // Draw Fibonacci Lines (Logic Levels)
                Engine.fibLevels.levels.forEach(lvl => {
                    const y = toY(lvl.val);
                    if(y > 0 && y < h) {
                        ctx.strokeStyle = 'rgba(234, 179, 8, 0.3)'; // Gold low opacity
                        ctx.setLineDash([4, 4]);
                        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
                        ctx.fillStyle = '#eab308'; ctx.font = '10px JetBrains Mono';
                        ctx.fillText(`FIB ${lvl.label}`, w - 60, y - 4);
                    }
                });
                ctx.setLineDash([]);

                // Draw Candles
                visible.forEach((c, i) => {
                    const x = i * (w / 80) + 10;
                    const isUp = c.c >= c.o;
                    const color = isUp ? '#0ecb81' : '#f6465d';
                    
                    ctx.fillStyle = color; ctx.strokeStyle = color;
                    
                    // Wick
                    ctx.beginPath(); ctx.moveTo(x + cWidth/2, toY(c.h)); ctx.lineTo(x + cWidth/2, toY(c.l)); ctx.stroke();
                    
                    // Body
                    const yO = toY(c.o); const yC = toY(c.c);
                    const hBody = Math.max(1, Math.abs(yO - yC));
                    ctx.fillRect(x, Math.min(yO, yC), cWidth, hBody);
                });

                // Price Line (Pulsing)
                const yPrice = toY(Engine.price);
                ctx.strokeStyle = '#ffffff'; ctx.setLineDash([2, 2]);
                ctx.beginPath(); ctx.moveTo(0, yPrice); ctx.lineTo(w, yPrice); ctx.stroke();
                
                // Price Label
                ctx.fillStyle = Engine.velocity >= 0 ? '#0ecb81' : '#f6465d';
                ctx.fillRect(w-70, yPrice-10, 70, 20);
                ctx.fillStyle = '#fff'; ctx.fillText(formatPrice(Engine.price), w-65, yPrice+4);
            }
        };

        // --- UI UPDATER ---
        const UI = {
            update() {
                // Header
                document.getElementById('price-display').innerText = formatPrice(Engine.price);
                document.getElementById('price-display').className = `text-2xl font-bold mono tracking-tighter ${Engine.velocity >= 0 ? 'text-buy' : 'text-sell'}`;
                
                // MM Stats
                document.getElementById('mm-inventory').innerText = Engine.inventory + " BTC";
                const pnl = (Engine.price - 45250) * Engine.inventory;
                const elPnl = document.getElementById('mm-pnl');
                elPnl.innerText = (pnl>=0?'+':'') + "$" + pnl.toFixed(2);
                elPnl.className = `text-sm font-bold mono ${pnl>=0?'text-buy':'text-sell'}`;

                // Sentiment
                const s = Engine.sentiment;
                document.getElementById('sentiment-val').innerText = s.toFixed(0) + "%";
                document.getElementById('sentiment-val').className = s > 70 ? 'text-buy blink-up' : s < 30 ? 'text-sell blink-down' : 'text-white';
                document.getElementById('sentiment-bar').style.width = s + "%";
                document.getElementById('sentiment-bar').className = `h-full transition-all duration-500 ${s > 60 ? 'bg-buy' : s < 40 ? 'bg-sell' : 'bg-blue-500'}`;

                // Random Tape Simulation
                if(Math.random() > 0.7) {
                    this.addTapeItem();
                }
            },

            addTapeItem() {
                const el = document.getElementById('tape-content');
                const side = Math.random() > 0.5 ? 'BUY' : 'SELL';
                const price = Engine.price;
                const vol = (Math.random() * 0.5).toFixed(4);
                
                const div = document.createElement('div');
                div.className = `flex justify-between px-2 py-0.5 border-b border-[#2a2e39] ${side==='BUY'?'text-buy':'text-sell'}`;
                div.innerHTML = `<span>${formatPrice(price)}</span><span>${vol}</span><span class="text-right">${new Date().toLocaleTimeString().split(' ')[0]}</span>`;
                
                el.appendChild(div);
                if(el.children.length > 20) el.removeChild(el.firstChild);
            },

            updateState(state) {
                document.getElementById('market-phase').innerText = "PHASE: " + state.replace('_', ' ');
            },

            showFibActive(isActive) {
                const el = document.getElementById('fib-status');
                el.style.display = isActive ? 'block' : 'none';
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 1500);
            }
        };

        // --- START ---
        Engine.init();
    </script>
</body>
</html>
