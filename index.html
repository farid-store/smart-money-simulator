<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM Terminal - God Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020202; color: #d1d4dc; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        
        /* UI Elements */
        .btn-mm { @apply transition-all active:scale-95 shadow-lg border-b-2; }
        .glass-panel { background: rgba(13, 13, 13, 0.95); backdrop-filter: blur(4px); border: 1px solid #222; }
        
        /* Animations */
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanline::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, rgba(0, 255, 0, 0.05), transparent); animation: scanline 4s linear infinite; pointer-events: none; }
        
        @keyframes pulse-liquidity { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }
        .animate-liq { animation: pulse-liquidity 2s infinite; }
    </style>
</head>
<body class="flex h-screen w-screen text-[12px] select-none text-gray-400 bg-black">

    <aside class="w-20 bg-[#050505] border-r border-[#1e1e1e] flex flex-col items-center py-4 z-50 shadow-2xl">
        <div class="mb-6 font-black text-xs text-center text-gray-600 leading-tight">MASTER<br>CONTROL</div>
        
        <div class="space-y-4 flex flex-col w-full px-2">
            <button onmousedown="Director.override('PUMP')" onmouseup="Director.release()" class="group flex flex-col items-center gap-1">
                <div class="w-12 h-12 rounded-lg bg-[#0a1f0a] border border-green-900 group-hover:bg-green-600 group-hover:shadow-[0_0_15px_#22c55e] transition-all flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-500 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path></svg>
                </div>
                <span class="text-[9px] font-bold text-green-500">PUMP</span>
            </button>

            <button onmousedown="Director.override('DUMP')" onmouseup="Director.release()" class="group flex flex-col items-center gap-1">
                <div class="w-12 h-12 rounded-lg bg-[#1f0a0a] border border-red-900 group-hover:bg-red-600 group-hover:shadow-[0_0_15px_#ef4444] transition-all flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-500 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <span class="text-[9px] font-bold text-red-500">DUMP</span>
            </button>

            <button onclick="Director.toggleFreeze()" class="group flex flex-col items-center gap-1 mt-4">
                <div id="btn-freeze" class="w-10 h-10 rounded-full bg-gray-900 border border-gray-700 hover:border-blue-500 flex items-center justify-center transition-all">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <span class="text-[9px] font-bold text-gray-500">FREEZE</span>
            </button>
        </div>

        <div class="flex-1"></div>
        
        <button onclick="LiquidityMap.spawnWave()" class="mb-4 w-12 h-12 rounded bg-yellow-900/20 border border-yellow-700/50 hover:bg-yellow-600 hover:text-black text-yellow-600 font-bold text-[9px] flex flex-col items-center justify-center text-center leading-none transition-all">
            <span>GEN</span>
            <span>LIQ</span>
        </button>
    </aside>

    <main class="flex-1 flex flex-col relative">
        
        <header class="h-12 bg-[#080808] border-b border-[#1e1e1e] flex items-center px-4 justify-between shrink-0 z-40">
            <div class="flex items-center gap-6">
                <div class="flex items-baseline gap-2">
                    <span class="text-xl font-black text-white tracking-tighter">$XAUUSD</span>
                    <span class="text-[10px] text-yellow-500 bg-yellow-900/30 px-1 rounded">DEALER MODE</span>
                </div>
                <div class="h-6 w-[1px] bg-[#222]"></div>
                <div>
                    <span class="text-[9px] text-gray-500 uppercase font-bold">Current Price</span>
                    <div id="price-display" class="font-bold mono text-lg text-white">2030.50</div>
                </div>
                <div>
                    <span class="text-[9px] text-gray-500 uppercase font-bold">Liquidity Eaten</span>
                    <div id="liq-eaten" class="font-bold mono text-lg text-yellow-500">$0</div>
                </div>
            </div>

            <div class="flex items-center gap-4 text-right">
                <div>
                    <span class="text-[9px] text-gray-500 uppercase font-bold">Dealer Balance</span>
                    <div id="balance-display" class="font-bold mono text-lg text-gray-300">$50,000</div>
                </div>
                <div class="bg-[#111] px-3 py-1 rounded border border-[#333]">
                    <span class="text-[9px] text-gray-500 uppercase font-bold">Total PnL</span>
                    <div id="total-pnl" class="font-bold mono text-lg text-white">$0.00</div>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            
            <div class="flex-1 relative bg-[#030303] scanline cursor-crosshair">
                <canvas id="chartCanvas" class="w-full h-full block"></canvas>
                
                <div class="absolute top-4 left-4 pointer-events-none">
                    <div class="text-[10px] text-gray-500 font-mono">
                        BIAS: <span id="bias-indicator" class="text-white">NEUTRAL</span> | 
                        VOL: <span id="vol-indicator" class="text-white">LOW</span>
                    </div>
                </div>
            </div>

            <div class="w-[320px] bg-[#0a0a0a] border-l border-[#1e1e1e] flex flex-col z-30">
                
                <div class="p-4 border-b border-[#1e1e1e] bg-[#0f0f0f]">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-white uppercase">Dealer Execution</span>
                        <span class="text-[9px] text-green-500 animate-pulse">● LIVE</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="bg-black border border-[#333] p-1.5 rounded">
                            <span class="text-[9px] text-gray-500 block">Lot Size</span>
                            <input type="number" id="lot-size" value="1.0" step="0.1" class="w-full bg-transparent text-white font-mono font-bold outline-none text-right">
                        </div>
                        <div class="flex items-center justify-end">
                            <div class="text-right">
                                <div class="text-[9px] text-gray-500">MARGIN LEVEL</div>
                                <div class="font-bold text-white">UNLIMITED</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="Trader.openPosition('BUY')" class="h-10 bg-[#0f2815] hover:bg-[#163c1f] border border-green-800 text-green-400 font-bold rounded text-xs transition-colors">
                            LONG (BUY)
                        </button>
                        <button onclick="Trader.openPosition('SELL')" class="h-10 bg-[#2b0f0f] hover:bg-[#421414] border border-red-800 text-red-400 font-bold rounded text-xs transition-colors">
                            SHORT (SELL)
                        </button>
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0 bg-[#080808]">
                    <div class="px-3 py-2 bg-[#111] border-b border-[#222] flex justify-between items-center">
                        <span class="text-[10px] font-bold text-gray-400">ACTIVE POSITIONS</span>
                        <button onclick="Trader.closeAll()" class="text-[9px] bg-gray-800 px-2 py-0.5 rounded hover:bg-white hover:text-black transition-colors">CLOSE ALL</button>
                    </div>
                    <div id="positions-container" class="flex-1 overflow-y-auto p-2 space-y-1">
                        </div>
                </div>

                <div class="h-40 border-t border-[#1e1e1e] flex flex-col bg-[#050505]">
                    <div class="px-3 py-1 bg-[#0f0f0f] border-b border-[#222]">
                        <span class="text-[10px] font-bold text-gray-500">RETAIL FLOW (L2)</span>
                    </div>
                    <div id="dom-container" class="flex-1 relative overflow-hidden text-[10px] font-mono"></div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- AUDIO SYSTEM (SFX) ---
        const SFX = {
            ctx: null,
            init() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            play(type) {
                if (!this.ctx) this.init();
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                if (type === 'cash') { // Liquidity Hit
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, t);
                    osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                    osc.start(t); osc.stop(t + 0.3);
                } else if (type === 'entry') { // Trade Open
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, t);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                    osc.start(t); osc.stop(t + 0.1);
                } else if (type === 'pump') {
                    osc.frequency.setValueAtTime(100, t);
                    osc.frequency.linearRampToValueAtTime(300, t + 0.5);
                    gain.gain.setValueAtTime(0.05, t);
                    osc.start(t); osc.stop(t + 0.5);
                }
            }
        };

        // --- CORE STATE ---
        const State = {
            price: 2030.00,
            candles: [], // {open, high, low, close}
            positions: [], // {id, type, entry, lot, pnl}
            liquidity: [], // {price, volume, width}
            balance: 50000,
            liquidityEaten: 0,
            lastTick: Date.now()
        };

        // --- DIRECTOR (THE MARKET MAKER LOGIC) ---
        const Director = {
            bias: 0,
            volatility: 0.5,
            isFrozen: false,
            overrideMode: null, // 'PUMP', 'DUMP'

            loop() {
                if (this.isFrozen) return;

                let move = (Math.random() - 0.5) * this.volatility;
                
                // Manual Override Logic
                if (this.overrideMode === 'PUMP') {
                    move += 1.5; // Strong Up Push
                    SFX.play('pump');
                } else if (this.overrideMode === 'DUMP') {
                    move -= 1.5; // Strong Down Push
                    SFX.play('pump');
                } else {
                    // Normal drift
                    move += this.bias * 0.1;
                }

                State.price += move;
                Chart.update(State.price);
                LiquidityMap.checkCollisions(State.price);
                Trader.updatePnL();
                DOM.update();
                
                this.updateUI();
            },

            override(mode) {
                this.overrideMode = mode;
                this.volatility = 2.0; // High vol when manipulating
                document.getElementById('bias-indicator').innerText = "MANIPULATING...";
                document.getElementById('bias-indicator').className = "text-yellow-500 font-bold animate-pulse";
            },

            release() {
                this.overrideMode = null;
                this.volatility = 0.5;
                document.getElementById('bias-indicator').innerText = "NEUTRAL";
                document.getElementById('bias-indicator').className = "text-white";
            },

            toggleFreeze() {
                this.isFrozen = !this.isFrozen;
                const btn = document.getElementById('btn-freeze');
                if(this.isFrozen) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('bg-gray-900');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-900');
                }
            },

            updateUI() {
                const pEl = document.getElementById('price-display');
                pEl.innerText = State.price.toFixed(2);
                // Color tick
                const prev = State.candles.length > 0 ? State.candles[State.candles.length-1].close : State.price;
                pEl.className = `font-bold mono text-lg ${State.price >= prev ? 'text-[#22c55e]' : 'text-[#ef4444]'}`;
            }
        };

        // --- LIQUIDITY MAP (THE HEATMAP) ---
        const LiquidityMap = {
            spawnWave() {
                // Generate random blocks above and below current price
                const center = State.price;
                for(let i=0; i<5; i++) {
                    const isAbove = Math.random() > 0.5;
                    const dist = (Math.random() * 20) + 5;
                    const price = isAbove ? center + dist : center - dist;
                    State.liquidity.push({
                        y: price,
                        vol: Math.floor(Math.random() * 5000) + 1000, // Value in $
                        height: (Math.random() * 3) + 1
                    });
                }
            },

            checkCollisions(price) {
                // Check if price hits a liquidity block
                for (let i = State.liquidity.length - 1; i >= 0; i--) {
                    const liq = State.liquidity[i];
                    // Simple collision: if price is within the block
                    if (Math.abs(price - liq.y) < 1.0) {
                        // EAT LIQUIDITY
                        State.liquidityEaten += liq.vol;
                        State.balance += (liq.vol * 0.1); // MM fees/rebate
                        State.liquidity.splice(i, 1); // Remove block
                        SFX.play('cash');
                        
                        // Visual Feedback
                        const el = document.getElementById('liq-eaten');
                        el.innerText = `$${State.liquidityEaten.toLocaleString()}`;
                        el.classList.remove('scale-150');
                        void el.offsetWidth; // trigger reflow
                        el.classList.add('scale-150', 'text-white', 'transition-transform');
                        setTimeout(() => el.classList.remove('scale-150', 'text-white'), 200);
                    }
                }
            }
        };

        // --- TRADER ENGINE (HEDGING CAPABLE) ---
        const Trader = {
            posIdCounter: 1,

            openPosition(type) {
                const lot = parseFloat(document.getElementById('lot-size').value);
                const pos = {
                    id: this.posIdCounter++,
                    type: type,
                    entry: State.price,
                    lot: lot,
                    pnl: 0
                };
                State.positions.push(pos);
                this.renderPositions();
                SFX.play('entry');
            },

            closePosition(id) {
                const idx = State.positions.findIndex(p => p.id === id);
                if (idx !== -1) {
                    State.balance += State.positions[idx].pnl;
                    State.positions.splice(idx, 1);
                    this.renderPositions();
                }
            },

            closeAll() {
                State.positions.forEach(p => State.balance += p.pnl);
                State.positions = [];
                this.renderPositions();
            },

            updatePnL() {
                let totalPnL = 0;
                State.positions.forEach(p => {
                    const diff = State.price - p.entry;
                    // 1 Lot = $10 per point (Standard XAU contract simplified)
                    const val = diff * p.lot * 10; 
                    p.pnl = p.type === 'BUY' ? val : -val;
                    totalPnL += p.pnl;
                });
                
                document.getElementById('total-pnl').innerText = `$${totalPnL.toFixed(2)}`;
                document.getElementById('total-pnl').className = `font-bold mono text-lg ${totalPnL >= 0 ? 'text-green-500' : 'text-red-500'}`;
                document.getElementById('balance-display').innerText = `$${Math.round(State.balance).toLocaleString()}`;
                
                this.renderPositions(); // Update PnL text in list
            },

            renderPositions() {
                const container = document.getElementById('positions-container');
                container.innerHTML = State.positions.map(p => {
                    const pnlClass = p.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    const typeClass = p.type === 'BUY' ? 'bg-green-900/20 text-green-500 border-green-900' : 'bg-red-900/20 text-red-500 border-red-900';
                    return `
                        <div class="flex justify-between items-center bg-[#0e0e0e] border border-[#222] p-2 rounded text-[10px]">
                            <div>
                                <span class="px-1 py-0.5 rounded border ${typeClass} font-bold">${p.type}</span>
                                <span class="ml-1 text-gray-400 font-mono">${p.lot} Lot @ ${p.entry.toFixed(1)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono font-bold ${pnlClass}">$${p.pnl.toFixed(0)}</span>
                                <button onclick="Trader.closePosition(${p.id})" class="text-gray-600 hover:text-white">✕</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        // --- CHART & RENDERER ---
        const Chart = {
            canvas: document.getElementById('chartCanvas'),
            ctx: null,
            maxCandles: 100,
            
            init() {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // Seed some candles
                let p = State.price;
                for(let i=0; i<80; i++) State.candles.push({open:p, high:p, low:p, close:p});
                
                // Initial Liquidity
                LiquidityMap.spawnWave();
                
                this.loop();
            },

            resize() {
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = this.canvas.offsetHeight;
            },

            update(price) {
                const now = Date.now();
                const last = State.candles[State.candles.length-1];
                
                // New candle every 1s
                if (now - State.lastTick > 1000) {
                    State.candles.push({open: price, high: price, low: price, close: price});
                    if (State.candles.length > this.maxCandles) State.candles.shift();
                    State.lastTick = now;
                } else {
                    last.close = price;
                    if(price > last.high) last.high = price;
                    if(price < last.low) last.low = price;
                }
            },

            draw() {
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                // Calc Range
                let min = Infinity, max = -Infinity;
                State.candles.forEach(c => { min = Math.min(min, c.low); max = Math.max(max, c.high); });
                // Include liquidity in range calc so they are visible
                State.liquidity.forEach(l => { min = Math.min(min, l.y); max = Math.max(max, l.y); });
                
                const padding = (max - min) * 0.2;
                min -= padding; max += padding;
                const range = max - min;
                const toY = p => h - ((p - min) / range * h);
                const candleW = w / this.maxCandles;

                // Clear
                ctx.fillStyle = "#030303";
                ctx.fillRect(0,0,w,h);

                // Grid
                ctx.strokeStyle = "#111"; ctx.lineWidth = 1; ctx.beginPath();
                for(let i=0; i<h; i+=50) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
                ctx.stroke();

                // 1. DRAW HEATMAP (LIQUIDITY)
                State.liquidity.forEach(liq => {
                    const y = toY(liq.y);
                    const thickness = liq.height * 2; // visual thickness
                    const opacity = Math.min((liq.vol / 5000), 0.8); // More volume = brighter
                    
                    // Glow
                    const grad = ctx.createLinearGradient(0, y-10, 0, y+10);
                    grad.addColorStop(0, "rgba(234, 179, 8, 0)");
                    grad.addColorStop(0.5, `rgba(234, 179, 8, ${opacity})`);
                    grad.addColorStop(1, "rgba(234, 179, 8, 0)");
                    
                    ctx.fillStyle = grad;
                    ctx.fillRect(w/2, y - 10, w/2, 20); // Draw on right half
                    
                    // Line
                    ctx.fillStyle = '#eab308';
                    ctx.font = '9px monospace';
                    ctx.fillText(`LIQ $${(liq.vol/1000).toFixed(1)}K`, w - 60, y + 3);
                });

                // 2. DRAW CANDLES
                State.candles.forEach((c, i) => {
                    const x = i * candleW;
                    const isBull = c.close >= c.open;
                    ctx.fillStyle = isBull ? '#22c55e' : '#ef4444';
                    ctx.strokeStyle = ctx.fillStyle;
                    
                    ctx.beginPath();
                    ctx.moveTo(x + candleW/2, toY(c.high));
                    ctx.lineTo(x + candleW/2, toY(c.low));
                    ctx.stroke();
                    
                    const hBody = Math.max(Math.abs(toY(c.open) - toY(c.close)), 1);
                    ctx.fillRect(x + 1, Math.min(toY(c.open), toY(c.close)), candleW - 2, hBody);
                });

                // 3. DRAW POSITIONS (Dashed Lines)
                State.positions.forEach(pos => {
                    const y = toY(pos.entry);
                    const color = pos.type === 'BUY' ? '#22c55e' : '#ef4444';
                    
                    ctx.beginPath();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // Label
                    ctx.fillStyle = color;
                    ctx.font = 'bold 10px monospace';
                    ctx.fillText(`${pos.type} ${pos.lot}`, 5, y - 4);
                    
                    // PnL on Chart
                    const pnlTxt = pos.pnl >= 0 ? `+$${pos.pnl.toFixed(0)}` : `-$${Math.abs(pos.pnl).toFixed(0)}`;
                    ctx.fillText(pnlTxt, 60, y - 4);
                });

                // 4. PRICE LINE
                const yPrice = toY(State.price);
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(0, yPrice); ctx.lineTo(w, yPrice); ctx.stroke();
            },

            loop() {
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- DOM / ORDER BOOK ---
        const DOM = {
            el: document.getElementById('dom-container'),
            update() {
                // Generate fake L2 data
                let html = '';
                const center = State.price;
                // Asks
                for(let i=4; i>0; i--) html += this.row(center + (i*0.1), 'ASK');
                // Bids
                for(let i=0; i<4; i++) html += this.row(center - (i*0.1), 'BID');
                this.el.innerHTML = html;
            },
            row(price, type) {
                const vol = Math.floor(Math.random() * 50);
                const color = type === 'ASK' ? 'text-red-500' : 'text-green-500';
                return `<div class="flex justify-between px-2 py-0.5 hover:bg-[#111]">
                    <span class="text-gray-500">${vol}</span>
                    <span class="${color} font-bold">${price.toFixed(2)}</span>
                </div>`;
            }
        }

        window.onload = () => {
            Chart.init();
            setInterval(() => Director.loop(), 50); // High speed loop
            
            // Interaction to unlock audio
            document.body.onclick = () => SFX.init();
        };

    </script>
</body>
</html>
