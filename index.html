<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAlgo V5.0 - Battle Royale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* BASE STYLES */
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #e0e0e0; overflow: hidden; }
        .mono { font-family: 'Roboto Mono', monospace; }
        
        /* COLORS */
        .bg-dark { background-color: #0b0e11; }
        .bg-panel { background-color: #151924; }
        .border-line { border-color: #2a2e39; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #0b0e11; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* ANIMATIONS */
        @keyframes flashGreen { 0% { background-color: #22c55e; } 100% { background-color: transparent; } }
        @keyframes flashRed { 0% { background-color: #ef4444; } 100% { background-color: transparent; } }
        .flash-up { animation: flashGreen 0.3s ease-out; }
        .flash-down { animation: flashRed 0.3s ease-out; }
        
        /* ORDER BOOK BARS */
        .bar-bid { position: absolute; top:0; left:0; height:100%; background: rgba(34, 197, 94, 0.15); z-index:0; transition: width 0.2s; }
        .bar-ask { position: absolute; top:0; right:0; height:100%; background: rgba(239, 68, 68, 0.15); z-index:0; transition: width 0.2s; }
    </style>
</head>
<body class="flex h-screen w-screen text-[12px] select-none">

    <aside class="w-12 bg-dark border-r border-line flex flex-col items-center py-4 z-50">
        <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white mb-6 shadow-lg shadow-blue-500/50">S</div>
        <div class="space-y-6 flex flex-col items-center">
             <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">
        
        <header class="h-14 bg-dark border-b border-line flex items-center px-4 justify-between shrink-0 z-40">
            <div class="flex items-center gap-6">
                <div>
                    <div class="text-[10px] text-gray-500 uppercase font-bold">Symbol</div>
                    <div class="font-bold text-lg text-white tracking-wider">$BBCA</div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-500 uppercase font-bold">Last Price</div>
                    <div class="font-bold text-xl mono text-white" id="header-price">0</div>
                </div>
                <div class="pl-6 border-l border-line">
                    <div class="text-[10px] text-gray-500 uppercase font-bold">Buying Power</div>
                    <div class="font-bold mono text-yellow-500 text-sm" id="header-cash">IDR 0</div>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase font-bold">Position</div>
                    <div class="font-bold mono text-blue-400" id="header-pos">0 LOT</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase font-bold">Unrealized P/L</div>
                    <div class="font-bold mono text-gray-400 text-base" id="header-pl">IDR 0</div>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            
            <div class="flex-1 flex flex-col min-w-0 relative border-r border-line">
                <div class="flex-1 relative bg-[#050709] w-full">
                    <div class="absolute top-2 left-2 flex gap-2 z-10 opacity-80 pointer-events-none">
                        <span class="bg-gray-900 border border-line px-2 py-1 rounded text-[10px] text-red-400 font-mono">RES: 10,000</span>
                        <span class="bg-gray-900 border border-line px-2 py-1 rounded text-[10px] text-green-400 font-mono">SUP: 9,700</span>
                        <span id="mode-badge" class="bg-blue-900 border border-blue-700 px-2 py-1 rounded text-[10px] text-white font-bold uppercase">NORMAL</span>
                    </div>
                    
                    <canvas id="chartCanvas" class="block w-full h-full cursor-crosshair"></canvas>
                </div>

                <div class="h-[160px] min-h-[160px] shrink-0 bg-panel border-t border-line p-4 z-30">
                    <div class="grid grid-cols-12 gap-4 h-full">
                        
                        <div class="col-span-3 flex flex-col justify-between space-y-2">
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Battle Mode</label>
                                <select id="battle-mode" onchange="APP.setMode()" class="w-full bg-black border border-gray-600 text-white text-xs p-2 rounded focus:border-blue-500 outline-none">
                                    <option value="normal">1. NORMAL (Standard)</option>
                                    <option value="hard">2. HARD (Vs Big Retail)</option>
                                    <option value="aggro">3. AGGRESSIVE (War Zone)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Algo Volume (Lot)</label>
                                <input type="number" id="algo-lot" value="1000" class="w-full bg-black border border-gray-600 text-white text-xs p-2 rounded text-center font-mono">
                            </div>
                        </div>

                        <div class="col-span-9 grid grid-cols-3 gap-3 h-full">
                            <button onclick="APP.startAlgo('accum')" id="btn-buy" class="flex flex-col items-center justify-center bg-green-700 hover:bg-green-600 active:bg-green-800 rounded border-b-4 border-green-900 transition-all group">
                                <span class="text-sm font-black text-white uppercase tracking-widest group-hover:scale-110 transition">HAKA (BUY)</span>
                                <span class="text-[10px] text-green-200 mt-1 opacity-70">Accumulate Logic</span>
                            </button>
                            
                            <button onclick="APP.startAlgo('distrib')" id="btn-sell" class="flex flex-col items-center justify-center bg-red-700 hover:bg-red-600 active:bg-red-800 rounded border-b-4 border-red-900 transition-all group">
                                <span class="text-sm font-black text-white uppercase tracking-widest group-hover:scale-110 transition">HAKI (SELL)</span>
                                <span class="text-[10px] text-red-200 mt-1 opacity-70">Distribute Logic</span>
                            </button>
                            
                            <button onclick="APP.stopAlgo()" class="flex flex-col items-center justify-center bg-gray-700 hover:bg-gray-600 active:bg-gray-800 rounded border-b-4 border-gray-900 transition-all">
                                <span class="text-sm font-bold text-white uppercase">STOP ALGO</span>
                                <span class="text-[10px] text-gray-400 mt-1">Emergency Brake</span>
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="w-[420px] shrink-0 flex flex-col bg-panel border-l border-line">
                
                <div class="flex-1 flex flex-col min-h-0 border-b border-line">
                    <div class="p-2 bg-gray-900 border-b border-line text-center">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Order Book</span>
                    </div>
                    <div class="grid grid-cols-3 text-[9px] text-gray-500 font-bold uppercase text-center py-1 bg-black/40">
                        <span>Bid Lot</span><span>Price</span><span>Ask Lot</span>
                    </div>
                    <div id="book-container" class="flex-1 overflow-y-auto relative bg-[#0c0e14] scroll-smooth"></div>
                </div>

                <div class="h-[250px] shrink-0 flex flex-col">
                    <div class="p-2 bg-gray-900 border-b border-line text-center">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Running Trade</span>
                    </div>
                    <div class="grid grid-cols-3 text-[9px] text-gray-500 font-bold uppercase text-center py-1 bg-black/40">
                        <span>Time</span><span>Price</span><span>Vol</span>
                    </div>
                    <div id="tape-container" class="flex-1 overflow-y-auto bg-[#0c0e14] font-mono text-[11px]"></div>
                </div>

            </div>
        </div>
    </main>

<script>
/**
 * SMARTALGO PRO V5.0 - BATTLE READY
 */
const APP = {
    state: {
        price: 9850,
        cash: 5000000000, // 5 Milyar Start
        portfolio: { pos: 0, avg: 0 },
        candles: [],
        currentCandle: null,
        trades: [],
        book: { asks: [], bids: [] },
        
        // Battle Params
        mode: 'normal', // normal, hard, aggro
        resistance: 10000,
        support: 9700,
        algoTimer: null,
        algoType: null // 'accum' or 'distrib'
    },

    init() {
        // Init Fake History
        let p = 9800;
        for(let i=0; i<60; i++) {
            let o = p;
            let c = p + (Math.random()-0.5)*20;
            this.state.candles.push({open:o, close:c, high: Math.max(o,c)+5, low: Math.min(o,c)-5});
            p = c;
        }
        this.startCandle(p);
        this.resetBook(p);
        this.updateUI();

        // Loops
        setInterval(() => this.marketTick(), 300); // Market Heartbeat
        setInterval(() => this.closeCandle(), 5000); // Chart Candle
        this.renderLoop();
    },

    // --- LOGIC: MARKET ENGINE ---
    marketTick() {
        const S = this.state;
        let buyPressure = 0.5; // Neutral
        let volatility = 1;

        // --- BATTLE LOGIC ---
        if (S.mode === 'normal') {
            buyPressure = 0.5;
            volatility = 1;
        } 
        else if (S.mode === 'hard') {
            // Vs Big Retail: Reject Resistance, Bounce Support
            if(S.price >= S.resistance - 25) buyPressure = 0.2; // Sell Wall
            if(S.price <= S.support + 25) buyPressure = 0.8; // Buy Wall
            volatility = 1.5;
        }
        else if (S.mode === 'aggro') {
            // Vs Enemy Smart Money (Stop Hunter)
            // Jika User punya banyak barang (Pos > 0), musuh cenderung SELL untuk tekan harga
            if (S.portfolio.pos > 5000) {
                buyPressure = 0.3; // Musuh guyur
                volatility = 2.5; // Chaos
            } else if (S.portfolio.pos < -2000) { // Jika user short (not implemented fully but logic here)
                buyPressure = 0.7; // Musuh angkat
            }
        }

        // Random Trade Generation
        const isBuy = Math.random() < buyPressure;
        let vol = Math.floor(Math.random() * 500 * volatility) + 10;
        
        // Big Player Injection (Aggro Mode)
        if(S.mode === 'aggro' && Math.random() < 0.1) {
            vol *= 10; // Spikes order 5000 lot
        }

        this.executeMarketOrder(isBuy ? 'BUY' : 'SELL', vol, false);
        this.maintainBook();
    },

    executeMarketOrder(side, vol, isUser) {
        if(vol <= 0) return;
        const S = this.state;
        let books = side === 'BUY' ? S.book.asks : S.book.bids;
        
        // Simple Matching
        let execPrice = S.price;
        if(books.length > 0) {
            let best = books[0];
            execPrice = best.price;
            
            if(vol >= best.vol) {
                // Habiskan level ini
                books.shift(); 
                // Price Move
                S.price = execPrice; 
            } else {
                best.vol -= vol;
            }
        }

        // Update Candle
        S.currentCandle.close = execPrice;
        S.currentCandle.high = Math.max(S.currentCandle.high, execPrice);
        S.currentCandle.low = Math.min(S.currentCandle.low, execPrice);

        // Record
        this.addTrade(execPrice, vol, side, isUser);

        // Portfolio Logic
        if(isUser) {
            const val = execPrice * vol * 100;
            if(side === 'BUY') {
                if(S.cash >= val) {
                    S.cash -= val;
                    let oldVal = S.portfolio.pos * S.portfolio.avg * 100;
                    S.portfolio.pos += vol;
                    S.portfolio.avg = (oldVal + val) / (S.portfolio.pos * 100);
                }
            } else {
                let sellVol = Math.min(vol, S.portfolio.pos);
                if(sellVol > 0) {
                    S.cash += execPrice * sellVol * 100;
                    S.portfolio.pos -= sellVol;
                    if(S.portfolio.pos === 0) S.portfolio.avg = 0;
                }
            }
        }
        
        // UI Trigger handled by renderLoop
    },

    // --- ALGO CONTROLS ---
    startAlgo(type) {
        this.stopAlgo();
        this.state.algoType = type;
        const lot = parseInt(document.getElementById('algo-lot').value);
        
        // UI Feedback
        const btnId = type === 'accum' ? 'btn-buy' : 'btn-sell';
        document.getElementById(btnId).classList.add('ring-2', 'ring-white', 'animate-pulse');

        // Speed depends on mode
        const speed = this.state.mode === 'aggro' ? 100 : 250;

        this.state.algoTimer = setInterval(() => {
            const side = type === 'accum' ? 'BUY' : 'SELL';
            this.executeMarketOrder(side, lot, true);
        }, speed);
    },

    stopAlgo() {
        if(this.state.algoTimer) clearInterval(this.state.algoTimer);
        this.state.algoTimer = null;
        this.state.algoType = null;
        // Remove Classes
        document.getElementById('btn-buy').classList.remove('ring-2', 'ring-white', 'animate-pulse');
        document.getElementById('btn-sell').classList.remove('ring-2', 'ring-white', 'animate-pulse');
    },

    setMode() {
        this.state.mode = document.getElementById('battle-mode').value;
        const badges = {
            'normal': { text: 'NORMAL', class: 'bg-blue-900 border-blue-700 text-white' },
            'hard': { text: 'HARD (BIG RETAIL)', class: 'bg-yellow-900 border-yellow-700 text-yellow-200' },
            'aggro': { text: 'WAR ZONE', class: 'bg-red-900 border-red-700 text-red-200 animate-pulse' }
        };
        const b = badges[this.state.mode];
        const el = document.getElementById('mode-badge');
        el.innerText = b.text;
        el.className = `border px-2 py-1 rounded text-[10px] font-bold uppercase ${b.class}`;
        
        // Status Dot
        const dot = document.getElementById('status-dot');
        dot.className = `w-2 h-2 rounded-full shadow-[0_0_10px] ${this.state.mode === 'aggro' ? 'bg-red-500 shadow-red-500' : 'bg-green-500 shadow-green-500'}`;
    },

    // --- DATA HELPERS ---
    resetBook(p) {
        this.state.book.asks = [];
        this.state.book.bids = [];
        for(let i=1; i<=15; i++) {
            this.state.book.asks.push({price: p + (i*25), vol: Math.floor(Math.random()*1000)});
            this.state.book.bids.push({price: p - (i*25), vol: Math.floor(Math.random()*1000)});
        }
    },
    maintainBook() {
        const B = this.state.book;
        // Basic AI to fill gaps
        if(B.asks.length < 10) B.asks.push({price: B.asks[B.asks.length-1].price+25, vol: 500});
        if(B.bids.length < 10) B.bids.push({price: B.bids[B.bids.length-1].price-25, vol: 500});
        
        // Spread Fix
        if(B.asks[0].price - B.bids[0].price > 25) {
             B.asks.unshift({price: B.bids[0].price+25, vol: Math.random()*1000});
        }
        
        // Random Noise
        B.asks.forEach(a => a.vol += Math.floor(Math.random()*50 - 20));
        B.bids.forEach(b => b.vol += Math.floor(Math.random()*50 - 20));
    },
    addTrade(p, v, s, user) {
        const t = new Date().toLocaleTimeString('id-ID', {hour12:false});
        this.state.trades.unshift({time:t, price:p, vol:v, side:s, user});
        if(this.state.trades.length > 50) this.state.trades.pop();
    },
    startCandle(p) { this.state.currentCandle = {open:p, high:p, low:p, close:p}; },
    closeCandle() {
        this.state.candles.push({...this.state.currentCandle});
        if(this.state.candles.length > 100) this.state.candles.shift();
        this.startCandle(this.state.currentCandle.close);
    },

    // --- VISUAL RENDERER ---
    renderLoop() {
        requestAnimationFrame(() => this.renderLoop());
        const S = this.state;
        
        // 1. Chart
        this.drawChart();

        // 2. Order Book (Efficient DOM Update)
        const bookEl = document.getElementById('book-container');
        let htmlBook = '';
        // Asks (Reverse)
        [...S.book.asks].slice(0,12).reverse().forEach(a => {
            let w = Math.min(a.vol/50, 100);
            htmlBook += `<div class="grid grid-cols-3 py-[1px] relative hover:bg-gray-800 text-[11px] cursor-pointer" onclick="APP.executeMarketOrder('BUY', ${a.vol}, true)">
                <div class="bar-ask" style="width:${w}%"></div>
                <div class="text-left pl-2 text-gray-700">-</div>
                <div class="text-center text-red-500 font-bold z-10">${a.price.toLocaleString()}</div>
                <div class="text-right pr-2 text-gray-400 font-mono z-10">${a.vol.toLocaleString()}</div>
            </div>`;
        });
        // Bids
        S.book.bids.slice(0,12).forEach(b => {
            let w = Math.min(b.vol/50, 100);
            htmlBook += `<div class="grid grid-cols-3 py-[1px] relative hover:bg-gray-800 text-[11px] cursor-pointer" onclick="APP.executeMarketOrder('SELL', ${b.vol}, true)">
                <div class="bar-bid" style="width:${w}%"></div>
                <div class="text-left pl-2 text-gray-300 font-mono z-10">${b.vol.toLocaleString()}</div>
                <div class="text-center text-green-500 font-bold z-10">${b.price.toLocaleString()}</div>
                <div class="text-right pr-2 text-gray-700">-</div>
            </div>`;
        });
        bookEl.innerHTML = htmlBook;

        // 3. Tape
        const tapeEl = document.getElementById('tape-container');
        let htmlTape = '';
        S.trades.forEach(t => {
            let col = t.side==='BUY'?'text-green-500':'text-red-500';
            let bg = t.user ? 'bg-blue-900/30' : '';
            htmlTape += `<div class="grid grid-cols-3 px-2 ${bg}">
                <span class="text-gray-500">${t.time}</span>
                <span class="${col} font-bold text-center">${t.price}</span>
                <span class="text-right text-gray-300">${t.vol}</span>
            </div>`;
        });
        tapeEl.innerHTML = htmlTape;
        
        // 4. Update UI Labels logic is separated to avoid flicker? No, simple text is fast.
        this.updateUI();
    },

    updateUI() {
        const S = this.state;
        // Price
        const pEl = document.getElementById('header-price');
        pEl.innerText = S.price.toLocaleString();
        pEl.className = `font-bold text-xl mono ${S.price > S.candles[S.candles.length-1]?.close ? 'text-green-500' : 'text-red-500'}`;
        
        // PL
        const pl = (S.price - S.portfolio.avg) * S.portfolio.pos * 100;
        const plEl = document.getElementById('header-pl');
        plEl.innerText = "IDR " + Math.round(pl).toLocaleString();
        plEl.className = `font-bold mono text-base ${pl > 0 ? 'text-green-400' : pl < 0 ? 'text-red-400' : 'text-gray-400'}`;

        document.getElementById('header-cash').innerText = "IDR " + (S.cash/1000000).toFixed(0) + " Jt";
        document.getElementById('header-pos').innerText = S.portfolio.pos.toLocaleString() + " LOT";
    },

    drawChart() {
        const cvs = document.getElementById('chartCanvas');
        const ctx = cvs.getContext('2d');
        if(cvs.width !== cvs.parentElement.clientWidth) {
            cvs.width = cvs.parentElement.clientWidth;
            cvs.height = cvs.parentElement.clientHeight;
        }
        const w = cvs.width, h = cvs.height;
        ctx.fillStyle = '#050709'; ctx.fillRect(0,0,w,h);
        
        // Grid
        ctx.strokeStyle = '#1e222d'; ctx.lineWidth = 1;
        ctx.beginPath(); for(let i=0; i<h; i+=50){ ctx.moveTo(0,i); ctx.lineTo(w,i); } ctx.stroke();

        // Scale
        const data = [...this.state.candles, this.state.currentCandle];
        let prices = data.map(d=>[d.high,d.low]).flat();
        prices.push(this.state.resistance, this.state.support);
        let min = Math.min(...prices)-10, max = Math.max(...prices)+10;
        const getY = p => h - ((p-min)/(max-min))*h;
        const barW = w / 100;

        // Zones
        let ry = getY(this.state.resistance), sy = getY(this.state.support);
        ctx.fillStyle = 'rgba(255,0,0,0.1)'; ctx.fillRect(0,ry,w,1);
        ctx.fillStyle = 'rgba(0,255,0,0.1)'; ctx.fillRect(0,sy,w,1);

        // Candles
        data.slice(-100).forEach((c,i)=>{
            let x = i*barW;
            let col = c.close >= c.open ? '#22c55e' : '#ef4444';
            ctx.fillStyle = col; ctx.strokeStyle = col;
            ctx.beginPath(); ctx.moveTo(x+barW/2, getY(c.high)); ctx.lineTo(x+barW/2, getY(c.low)); ctx.stroke();
            let bodyH = Math.max(1, Math.abs(getY(c.open)-getY(c.close)));
            ctx.fillRect(x+1, getY(Math.max(c.open,c.close)), barW-2, bodyH);
        });
        
        // Current Price Line
        let py = getY(this.state.price);
        ctx.strokeStyle = '#fff'; ctx.setLineDash([2,4]); 
        ctx.beginPath(); ctx.moveTo(0,py); ctx.lineTo(w,py); ctx.stroke(); ctx.setLineDash([]);
    }
};

window.onload = () => APP.init();
</script>
</body>
</html>
