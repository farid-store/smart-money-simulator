<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAlgo Pro V4.0 - Stable Realtime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050709; color: #d1d4dc; overflow: hidden; }
        .mono { font-family: 'Roboto Mono', monospace; }
        .bg-sidebar { background-color: #0c0e14; }
        .bg-panel { background-color: #111318; }
        .border-line { border-color: #1e222d; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0c0e14; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Animations */
        .flash-green { animation: flashG 0.5s ease-out; }
        .flash-red { animation: flashR 0.5s ease-out; }
        @keyframes flashG { 0% { background-color: rgba(34, 197, 94, 0.4); } 100% { background-color: transparent; } }
        @keyframes flashR { 0% { background-color: rgba(239, 68, 68, 0.4); } 100% { background-color: transparent; } }

        /* Table Utilities */
        .cell-up { color: #22c55e; }
        .cell-down { color: #ef4444; }
        .bar-bid { background: rgba(34, 197, 94, 0.15); height: 100%; position: absolute; left: 0; top:0; z-index: 0; transition: width 0.2s; }
        .bar-ask { background: rgba(239, 68, 68, 0.15); height: 100%; position: absolute; right: 0; top:0; z-index: 0; transition: width 0.2s; }
    </style>
</head>
<body class="flex h-screen w-screen text-[12px]">

    <aside class="w-12 bg-sidebar border-r border-line flex flex-col items-center py-4 z-20">
        <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white mb-6">S</div>
        <div class="space-y-4">
            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]" id="connection-dot"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">
        
        <header class="h-14 bg-sidebar border-b border-line flex items-center px-4 justify-between shrink-0">
            <div class="flex items-center gap-6">
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Symbol</div>
                    <div class="font-bold text-lg text-white">$BBCA</div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Last Price</div>
                    <div class="font-bold text-xl mono text-white" id="header-price">0</div>
                </div>
                <div class="pl-6 border-l border-line">
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Cash Available</div>
                    <div class="font-bold mono text-yellow-500" id="header-cash">IDR 0</div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase">My Position</div>
                    <div class="font-bold mono text-blue-400" id="header-pos">0 LOT</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase">Floating P/L</div>
                    <div class="font-bold mono text-gray-400" id="header-pl">IDR 0</div>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <div class="flex-1 relative bg-[#050709] border-r border-line flex flex-col">
                <div class="absolute top-2 left-2 z-10 flex gap-2">
                    <div class="bg-black/60 px-2 py-1 rounded border border-line text-[10px]">
                        RES: <span class="text-red-400 font-mono">10,000</span>
                    </div>
                    <div class="bg-black/60 px-2 py-1 rounded border border-line text-[10px]">
                        SUP: <span class="text-green-400 font-mono">9,700</span>
                    </div>
                </div>
                <canvas id="chartCanvas" class="w-full h-full cursor-crosshair block"></canvas>
                
                <div class="h-auto p-3 bg-panel border-t border-line grid grid-cols-4 gap-3">
                     <div class="flex flex-col gap-1">
                        <label class="text-[9px] uppercase text-gray-500 font-bold">Mode</label>
                        <select id="sim-mode" class="bg-black border border-line text-white p-1 rounded text-xs outline-none">
                            <option value="normal">NORMAL</option>
                            <option value="hard">HARD (War Zone)</option>
                        </select>
                     </div>
                     <div class="flex flex-col gap-1">
                        <label class="text-[9px] uppercase text-gray-500 font-bold">Lot Size</label>
                        <input type="number" id="algo-lot" value="1000" class="bg-black border border-line text-white p-1 rounded text-xs text-center outline-none">
                     </div>
                     <div class="col-span-2 grid grid-cols-3 gap-2">
                        <button onclick="APP.startAlgo('accum')" id="btn-buy" class="bg-green-700 hover:bg-green-600 text-white font-bold rounded text-xs uppercase transition">HAKA (BUY)</button>
                        <button onclick="APP.startAlgo('distrib')" id="btn-sell" class="bg-red-700 hover:bg-red-600 text-white font-bold rounded text-xs uppercase transition">HAKI (SELL)</button>
                        <button onclick="APP.stopAlgo()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold rounded text-xs uppercase border border-gray-500">STOP</button>
                     </div>
                </div>
            </div>

            <div class="w-[450px] flex flex-row bg-panel">
                
                <div class="flex-1 flex flex-col border-r border-line min-w-[220px]">
                    <div class="p-2 border-b border-line bg-sidebar font-bold text-[10px] text-gray-400 uppercase text-center">Order Book</div>
                    <div class="grid grid-cols-3 text-[9px] text-gray-600 font-bold uppercase text-center py-1 border-b border-line bg-black/20">
                        <span>Bid Vol</span><span>Price</span><span>Ask Vol</span>
                    </div>
                    <div id="orderbook-container" class="flex-1 overflow-y-auto relative bg-[#0c0e14]">
                        </div>
                </div>

                <div class="w-[200px] flex flex-col bg-sidebar">
                    <div class="p-2 border-b border-line font-bold text-[10px] text-gray-400 uppercase text-center">Running Trade</div>
                    <div class="grid grid-cols-3 text-[9px] text-gray-600 font-bold uppercase text-center py-1 border-b border-line bg-black/20">
                        <span>Time</span><span>Price</span><span>Vol</span>
                    </div>
                    <div id="tape-container" class="flex-1 overflow-y-auto font-mono text-[11px]">
                        </div>
                </div>

            </div>
        </div>
    </main>

<script>
/**
 * SMARTALGO PRO V4.0 - CORE ENGINE
 * Single Object Architecture for Stability
 */

const APP = {
    // --- STATE ---
    state: {
        price: 9850,
        lastPrice: 9850,
        cash: 1000000000,
        portfolio: { pos: 0, avg: 0 },
        book: { bids: [], asks: [] }, // Array of {price, vol}
        trades: [], // Array of {time, price, vol, side}
        candles: [], // Array of {open, high, low, close}
        currentCandle: null,
        
        // Settings
        resistance: 10000,
        support: 9700,
        algoId: null,
        mode: 'normal'
    },

    // --- CONFIG ---
    config: {
        tickRate: 200, // Speed of simulation (ms)
        candleTime: 5000, // 5 seconds per candle (fast simulation)
        maxHistory: 100
    },

    // --- INITIALIZATION ---
    init() {
        console.log("Initializing SmartAlgo Pro V4...");
        
        // 1. Setup Order Book
        this.resetOrderBook(this.state.price);
        
        // 2. Setup Chart History
        this.generateFakeHistory();
        
        // 3. Start Loops
        this.loops = {
            market: setInterval(() => this.marketTick(), this.config.tickRate),
            chart: setInterval(() => this.finalizeCandle(), this.config.candleTime),
            render: requestAnimationFrame(() => this.renderLoop())
        };

        // 4. Initial Render
        this.updateUIValues();
    },

    // --- LOGIC: ORDER BOOK MANAGEMENT ---
    resetOrderBook(centerPrice) {
        this.state.book.bids = [];
        this.state.book.asks = [];
        for (let i = 1; i <= 10; i++) {
            this.state.book.asks.push({ price: centerPrice + (i * 25), vol: this.randVol() });
            this.state.book.bids.push({ price: centerPrice - (i * 25), vol: this.randVol() });
        }
    },

    maintainOrderBook() {
        // Ensure book follows price
        const bestBid = this.state.book.bids[0].price;
        const bestAsk = this.state.book.asks[0].price;
        const spread = bestAsk - bestBid;

        // If spread too wide, fill it
        if (spread > 25) {
            this.state.book.bids.unshift({ price: bestAsk - 25, vol: this.randVol() });
            this.state.book.asks.unshift({ price: bestBid + 25, vol: this.randVol() });
        }

        // If ran out of depth
        if (this.state.book.bids.length < 10) {
            let last = this.state.book.bids[this.state.book.bids.length-1].price;
            this.state.book.bids.push({ price: last - 25, vol: this.randVol() });
        }
        if (this.state.book.asks.length < 10) {
            let last = this.state.book.asks[this.state.book.asks.length-1].price;
            this.state.book.asks.push({ price: last + 25, vol: this.randVol() });
        }
        
        // Sort Correctly
        this.state.book.bids.sort((a,b) => b.price - a.price); // Descending
        this.state.book.asks.sort((a,b) => a.price - b.price); // Ascending
    },

    // --- LOGIC: MARKET ENGINE ---
    marketTick() {
        this.state.mode = document.getElementById('sim-mode').value;
        
        // 1. Determine Direction (Supply/Demand Logic)
        let buyProb = 0.5;
        
        // HARD MODE: Reject at Resistance, Bounce at Support
        if (this.state.mode === 'hard') {
            if (this.state.price >= this.state.resistance - 50) buyProb = 0.1; // Heavy Sell Pressure
            if (this.state.price <= this.state.support + 50) buyProb = 0.9; // Heavy Buy Pressure
        }

        // 2. Random Retail Action
        const side = Math.random() < buyProb ? 'BUY' : 'SELL';
        const vol = Math.floor(Math.random() * 500) + 1; // Retail Volume
        
        this.executeTrade(side, vol, false);

        // 3. Volatility (Book Replenish)
        this.state.book.bids.forEach(b => b.vol += Math.floor(Math.random()*20));
        this.state.book.asks.forEach(a => a.vol += Math.floor(Math.random()*20));
        
        this.maintainOrderBook();
    },

    executeTrade(side, vol, isSmartMoney) {
        if (vol <= 0) return;
        
        let execPrice = this.state.price;
        let books = side === 'BUY' ? this.state.book.asks : this.state.book.bids;

        // Match Logic
        if (books.length > 0) {
            let topOrder = books[0];
            execPrice = topOrder.price;
            
            // Consume Volume
            if (vol >= topOrder.vol) {
                books.shift(); // Eat level
                // Logic: If ate level, price moves
                this.state.price = execPrice; 
            } else {
                topOrder.vol -= vol;
            }
        }

        // Update State
        this.state.lastPrice = execPrice;
        
        // Update Candle
        if (!this.state.currentCandle) this.startNewCandle(execPrice);
        const c = this.state.currentCandle;
        c.close = execPrice;
        c.high = Math.max(c.high, execPrice);
        c.low = Math.min(c.low, execPrice);

        // Record Trade
        this.recordTrade(execPrice, vol, side, isSmartMoney);

        // Update Portfolio if User
        if (isSmartMoney) this.updatePortfolio(side, execPrice, vol);
    },

    recordTrade(price, vol, side, isSmartMoney) {
        const time = new Date().toLocaleTimeString('id-ID', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
        this.state.trades.unshift({ time, price, vol, side, smart: isSmartMoney });
        if (this.state.trades.length > 30) this.state.trades.pop();
    },

    updatePortfolio(side, price, vol) {
        const p = this.state.portfolio;
        const val = price * vol * 100;

        if (side === 'BUY') {
            if (this.state.cash < val) return; // Insufficient funds
            this.state.cash -= val;
            let oldVal = p.pos * p.avg * 100;
            p.pos += vol;
            p.avg = (oldVal + val) / (p.pos * 100);
        } else {
            if (p.pos < vol) vol = p.pos; // Sell max
            this.state.cash += val;
            p.pos -= vol;
            if (p.pos === 0) p.avg = 0;
        }
        this.updateUIValues();
    },

    // --- USER ACTIONS ---
    startAlgo(type) {
        this.stopAlgo(); // Safety clear
        const lot = parseInt(document.getElementById('algo-lot').value);
        const speed = this.state.mode === 'hard' ? 100 : 300;
        
        // Visual Feedback
        const btn = document.getElementById(type === 'accum' ? 'btn-buy' : 'btn-sell');
        btn.classList.add('ring-2', 'ring-white', 'animate-pulse');

        this.state.algoId = setInterval(() => {
            const side = type === 'accum' ? 'BUY' : 'SELL';
            this.executeTrade(side, lot, true);
        }, speed);
    },

    stopAlgo() {
        if (this.state.algoId) clearInterval(this.state.algoId);
        this.state.algoId = null;
        // Remove visuals
        document.querySelectorAll('button').forEach(b => b.classList.remove('ring-2', 'ring-white', 'animate-pulse'));
    },

    // --- CHARTING ---
    generateFakeHistory() {
        let p = 9800;
        for (let i = 0; i < 60; i++) {
            let o = p;
            let c = p + (Math.random()-0.5)*20;
            this.state.candles.push({ open: o, close: c, high: Math.max(o,c)+5, low: Math.min(o,c)-5 });
            p = c;
        }
        this.startNewCandle(p);
    },

    startNewCandle(p) {
        this.state.currentCandle = { open: p, close: p, high: p, low: p };
    },

    finalizeCandle() {
        if (this.state.currentCandle) {
            this.state.candles.push({...this.state.currentCandle});
            if (this.state.candles.length > this.config.maxHistory) this.state.candles.shift();
            // Start next candle at previous close
            this.startNewCandle(this.state.currentCandle.close);
        }
    },

    // --- RENDERER (VISUALS) ---
    renderLoop() {
        this.drawChart();
        this.drawOrderBook();
        this.drawTape();
        this.updateUIValues();
        requestAnimationFrame(() => this.renderLoop());
    },

    drawChart() {
        const cvs = document.getElementById('chartCanvas');
        const ctx = cvs.getContext('2d');
        
        // Resize check
        if (cvs.width !== cvs.parentElement.clientWidth || cvs.height !== cvs.parentElement.clientHeight) {
            cvs.width = cvs.parentElement.clientWidth;
            cvs.height = cvs.parentElement.clientHeight;
        }

        const w = cvs.width;
        const h = cvs.height;
        
        // Clear
        ctx.fillStyle = '#050709';
        ctx.fillRect(0, 0, w, h);

        // Grid
        ctx.strokeStyle = '#1e222d';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<h; i+=40) { ctx.moveTo(0, i); ctx.lineTo(w, i); }
        ctx.stroke();

        // Data Prep
        const data = [...this.state.candles, this.state.currentCandle];
        const prices = data.map(c => [c.high, c.low]).flat();
        // Add zones to scaling
        prices.push(this.state.resistance, this.state.support);
        
        const minP = Math.min(...prices) - 20;
        const maxP = Math.max(...prices) + 20;
        const range = maxP - minP || 1;
        
        const getY = (p) => h - ((p - minP) / range) * h;
        const barW = (w - 60) / 80; // Fixed candle width logic

        // Draw Zones
        const rY = getY(this.state.resistance);
        const sY = getY(this.state.support);
        
        ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
        ctx.fillRect(0, rY, w, 2); // Res Line
        ctx.fillStyle = 'rgba(34, 197, 94, 0.1)';
        ctx.fillRect(0, sY, w, 2); // Sup Line

        // Draw Candles
        data.slice(-80).forEach((c, i) => {
            const x = 10 + i * barW;
            const color = c.close >= c.open ? '#22c55e' : '#ef4444';
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            
            // Wick
            ctx.beginPath();
            ctx.moveTo(x + barW/2, getY(c.high));
            ctx.lineTo(x + barW/2, getY(c.low));
            ctx.stroke();

            // Body
            const bY = getY(Math.max(c.open, c.close));
            const bH = Math.max(Math.abs(getY(c.open) - getY(c.close)), 1);
            ctx.fillRect(x, bY, barW-1, bH);
        });

        // Current Price Line
        const cY = getY(this.state.price);
        ctx.strokeStyle = '#fff';
        ctx.setLineDash([2, 4]);
        ctx.beginPath(); ctx.moveTo(0, cY); ctx.lineTo(w, cY); ctx.stroke();
        ctx.setLineDash([]);
    },

    drawOrderBook() {
        const container = document.getElementById('orderbook-container');
        let html = '';

        // ASKS (Reversed)
        [...this.state.book.asks].reverse().forEach(a => {
            const width = Math.min((a.vol/2000)*100, 100);
            html += `
            <div class="grid grid-cols-3 py-[2px] relative hover:bg-gray-800 cursor-pointer">
                <div class="bar-ask" style="width:${width}%"></div>
                <div class="text-left pl-2 z-10 text-gray-700">-</div>
                <div class="text-center z-10 text-red-500 font-bold font-mono">${a.price.toLocaleString()}</div>
                <div class="text-right pr-2 z-10 text-gray-400 font-mono">${a.vol.toLocaleString()}</div>
            </div>`;
        });

        // SPREAD
        html += `<div class="bg-gray-900 border-y border-line text-center text-[10px] text-gray-500 py-1 font-mono">
            SPREAD: ${this.state.book.asks[0].price - this.state.book.bids[0].price}
        </div>`;

        // BIDS
        this.state.book.bids.forEach(b => {
            const width = Math.min((b.vol/2000)*100, 100);
            html += `
            <div class="grid grid-cols-3 py-[2px] relative hover:bg-gray-800 cursor-pointer">
                <div class="bar-bid" style="width:${width}%"></div>
                <div class="text-left pl-2 z-10 text-gray-300 font-mono">${b.vol.toLocaleString()}</div>
                <div class="text-center z-10 text-green-500 font-bold font-mono">${b.price.toLocaleString()}</div>
                <div class="text-right pr-2 z-10 text-gray-700">-</div>
            </div>`;
        });

        // Only update if changes to prevent heavy DOM thrashing (Simple check)
        // For V4 stability, we use innerHTML but optimized in browser
        container.innerHTML = html;
    },

    drawTape() {
        const container = document.getElementById('tape-container');
        let html = '';
        this.state.trades.forEach(t => {
            const color = t.side === 'BUY' ? 'text-green-500' : 'text-red-500';
            const bg = t.smart ? 'bg-yellow-900/20' : ''; // Highlight Smart Money
            html += `
            <div class="grid grid-cols-3 py-1 px-2 border-b border-gray-800 ${bg}">
                <span class="text-gray-500">${t.time.split('.')[0]}</span>
                <span class="${color} font-bold text-center">${t.price}</span>
                <span class="text-white text-right">${t.vol}</span>
            </div>`;
        });
        container.innerHTML = html;
    },

    updateUIValues() {
        // Price
        const pEl = document.getElementById('header-price');
        pEl.innerText = this.state.price.toLocaleString();
        pEl.className = `font-bold text-xl mono ${this.state.price >= this.state.candles[this.state.candles.length-1].close ? 'text-green-500' : 'text-red-500'}`;
        
        // Portfolio
        document.getElementById('header-cash').innerText = this.formatIDR(this.state.cash);
        document.getElementById('header-pos').innerText = `${this.state.portfolio.pos.toLocaleString()} LOT`;
        
        // PL
        const pl = (this.state.price - this.state.portfolio.avg) * this.state.portfolio.pos * 100;
        const plEl = document.getElementById('header-pl');
        plEl.innerText = this.formatIDR(pl);
        plEl.className = `font-bold mono ${pl > 0 ? 'text-green-500' : pl < 0 ? 'text-red-500' : 'text-gray-400'}`;
    },

    // --- UTILS ---
    randVol: () => Math.floor(Math.random() * 3000) + 50,
    formatIDR: (n) => {
        if (Math.abs(n) >= 1000000000) return (n/1000000000).toFixed(2) + ' M';
        if (Math.abs(n) >= 1000000) return (n/1000000).toFixed(1) + ' Jt';
        return parseInt(n).toLocaleString();
    }
};

// START ENGINE
window.onload = () => APP.init();

</script>
</body>
</html>
