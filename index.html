<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM Trainer - Dynamic Market Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #d1d4dc; overflow: hidden; }
        .mono { font-family: 'Roboto Mono', monospace; }
        
        /* Custom Scrollbar & Inputs */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        input { background: #000; color: #0f0; border: 1px solid #333; text-align: center; outline: none; }

        /* Animation Classes */
        .flash-up { animation: flashGreen 0.4s ease-out; }
        .flash-down { animation: flashRed 0.4s ease-out; }
        @keyframes flashGreen { 0% { color: #fff; text-shadow: 0 0 10px #0f0; } 100% { color: #22c55e; } }
        @keyframes flashRed { 0% { color: #fff; text-shadow: 0 0 10px #f00; } 100% { color: #ef4444; } }
        
        .row-enter { animation: slideIn 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="flex h-screen w-screen text-[13px] select-none text-gray-300">

    <aside class="w-16 bg-[#080a0f] border-r border-[#1e222d] flex flex-col items-center py-6 space-y-6 z-50">
        <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center font-black text-white text-xs shadow-lg shadow-blue-900/50">MM</div>
        <div class="flex-1"></div>
        <div class="text-[9px] text-gray-600 rotate-180" style="writing-mode: vertical-rl;">AI DIRECTOR ACTIVE</div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#020406]">
        
        <header class="h-14 bg-[#080a0f] border-b border-[#1e222d] flex items-center px-6 justify-between shrink-0">
            <div class="flex items-center space-x-10">
                <div>
                    <span class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Instrument</span>
                    <span class="font-black text-lg text-white">$XAUUSD <span class="text-yellow-500 text-[10px] ml-1 bg-yellow-500/10 px-1.5 py-0.5 rounded">GOLD</span></span>
                </div>
                <div>
                    <span class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Market Price</span>
                    <div class="font-black mono text-xl tracking-tight text-white" id="price-display">2030.50</div>
                </div>
                <div class="border-l border-[#1e222d] pl-6">
                    <span class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Regime (Phase)</span>
                    <div id="market-phase" class="font-bold text-sm text-blue-400 uppercase tracking-wider animate-pulse">ANALYZING...</div>
                </div>
            </div>

            <div class="text-right">
                <span class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Inventory P/L</span>
                <div id="pnl-display" class="font-black mono text-lg text-gray-500">IDR 0</div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            
            <div class="flex-1 relative flex flex-col">
                <div class="absolute top-4 left-4 z-10 space-y-1 pointer-events-none">
                    <div class="text-[10px] bg-black/50 backdrop-blur border border-white/10 px-2 py-1 rounded text-gray-400">
                        Vol: <span id="vol-display" class="text-white font-mono">Low</span>
                    </div>
                    <div class="text-[10px] bg-black/50 backdrop-blur border border-white/10 px-2 py-1 rounded text-gray-400">
                        Trend Bias: <span id="bias-display" class="text-white font-mono">0.0</span>
                    </div>
                </div>

                <canvas id="chartCanvas" class="w-full h-full block cursor-crosshair"></canvas>
            </div>

            <div class="w-[380px] bg-[#0b0d14] border-l border-[#1e222d] flex flex-col shrink-0 z-20">
                
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="p-2 border-b border-[#1e222d] bg-[#12151e] flex justify-between">
                        <span class="text-[10px] font-bold text-gray-400">DEPTH OF MARKET</span>
                        <span class="text-[10px] text-blue-500 font-mono">L2 DATA</span>
                    </div>
                    
                    <div class="grid grid-cols-3 text-[9px] text-gray-500 px-3 py-1 font-bold uppercase border-b border-[#1e222d]">
                        <span>Bid Vol</span>
                        <span class="text-center">Price</span>
                        <span class="text-right">Ask Vol</span>
                    </div>

                    <div id="dom-container" class="flex-1 overflow-hidden relative bg-[#050608]">
                        </div>
                </div>

                <div class="h-40 border-t border-[#1e222d] flex flex-col bg-[#080a0f]">
                    <div class="px-3 py-1 border-b border-[#1e222d] bg-[#12151e]">
                        <span class="text-[10px] font-bold text-gray-400">TAPE</span>
                    </div>
                    <div id="tape-container" class="flex-1 overflow-hidden font-mono text-[10px] p-1 space-y-0.5"></div>
                </div>

                <div class="p-4 bg-[#0e1118] border-t border-[#1e222d] space-y-3 shadow-2xl">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[9px] uppercase text-gray-500 font-bold">Qty (Lot)</label>
                            <input type="number" id="trade-qty" value="10" class="w-full p-1.5 rounded text-sm font-bold bg-black border-gray-800 focus:border-blue-500 transition-colors">
                        </div>
                        <div class="flex items-end">
                             <div class="text-[10px] text-gray-400 w-full text-center pb-2">NET POS: <span id="net-pos" class="text-white font-bold">0</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="Trader.execute('BUY')" class="bg-[#1e222d] border border-green-900/50 hover:bg-green-600 hover:text-white text-green-500 py-3 rounded font-black text-xs transition-all active:scale-95 shadow-lg">BID (BUY)</button>
                        <button onclick="Trader.execute('SELL')" class="bg-[#1e222d] border border-red-900/50 hover:bg-red-600 hover:text-white text-red-500 py-3 rounded font-black text-xs transition-all active:scale-95 shadow-lg">OFFER (SELL)</button>
                    </div>
                    
                    <button onclick="Director.forceIntervention()" class="w-full bg-orange-900/20 border border-orange-600/50 text-orange-500 hover:bg-orange-600 hover:text-white py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all">
                        ⚠️ FORCE SHAKEOUT
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIG & STATE ---
        const Config = {
            tickRate: 100,      // Speed of simulation
            candleTime: 2000,   // New candle every 2s (simulating M1 compressed)
            pointValue: 100000, // Value per point for PnL
        };

        const State = {
            price: 2030.50,
            candles: [],
            lastCandleTime: 0,
            inventory: { pos: 0, avgPrice: 0 },
            snrLevels: { resistance: null, support: null },
            isPlaying: true
        };

        // --- MARKET DIRECTOR (THE BRAIN) ---
        const Director = {
            regime: 'RANGING',
            bias: 0,          // -1 (Bear) to 1 (Bull)
            volatility: 1,    // Multiplier for price moves
            timer: 0,
            duration: 0,

            init() {
                this.changeRegime();
                setInterval(() => this.loop(), 500); // Director thinks every 0.5s
            },

            loop() {
                this.timer++;
                if (this.timer >= this.duration) {
                    this.changeRegime();
                }
                
                // Random event: Sudden Spike (News)
                if (Math.random() < 0.02) { 
                    this.regime = Math.random() > 0.5 ? 'SPIKE_UP' : 'SPIKE_DOWN';
                    this.duration = 5; // Short duration
                    this.updateParams();
                }
            },

            changeRegime() {
                // Markov Chain-like logic for realistic transitions
                const types = ['RANGING', 'RANGING', 'WEAK_BULL', 'WEAK_BEAR', 'STRONG_BULL', 'STRONG_BEAR', 'CONSOLIDATION'];
                this.regime = types[Math.floor(Math.random() * types.length)];
                
                // Duration in "Director ticks"
                this.duration = Math.floor(Math.random() * 40) + 10; 
                this.timer = 0;
                this.updateParams();
                
                // UI Update
                const el = document.getElementById('market-phase');
                el.innerText = this.regime.replace('_', ' ');
                el.className = `font-bold text-sm uppercase tracking-wider animate-pulse ${this.getRegimeColor()}`;
            },

            updateParams() {
                switch(this.regime) {
                    case 'RANGING':
                        this.bias = 0; this.volatility = 0.5; break;
                    case 'WEAK_BULL':
                        this.bias = 0.3; this.volatility = 0.8; break; // Trending with pullbacks
                    case 'WEAK_BEAR':
                        this.bias = -0.3; this.volatility = 0.8; break;
                    case 'STRONG_BULL':
                        this.bias = 0.8; this.volatility = 1.5; break; // Parabolic
                    case 'STRONG_BEAR':
                        this.bias = -0.8; this.volatility = 1.5; break; // Crash
                    case 'CONSOLIDATION':
                        this.bias = 0.05; this.volatility = 0.2; break; // Flag Pattern (very tight)
                    case 'SPIKE_UP':
                        this.bias = 2.0; this.volatility = 3.0; break;
                    case 'SPIKE_DOWN':
                        this.bias = -2.0; this.volatility = 3.0; break;
                }
                document.getElementById('bias-display').innerText = this.bias.toFixed(2);
                document.getElementById('vol-display').innerText = this.volatility > 1 ? "HIGH" : "NORMAL";
            },

            getRegimeColor() {
                if(this.regime.includes('BULL') || this.regime.includes('UP')) return 'text-green-500';
                if(this.regime.includes('BEAR') || this.regime.includes('DOWN')) return 'text-red-500';
                return 'text-blue-400';
            },

            forceIntervention() {
                this.regime = Math.random() > 0.5 ? 'SPIKE_UP' : 'SPIKE_DOWN';
                this.duration = 8;
                this.timer = 0;
                this.updateParams();
                
                // Visual Feedback
                const el = document.getElementById('market-phase');
                el.innerText = "!!! LIQUIDITY HUNT !!!";
                el.className = "font-black text-sm text-orange-500 uppercase tracking-widest animate-bounce";
            }
        };

        // --- CHART ENGINE ---
        const Chart = {
            canvas: document.getElementById('chartCanvas'),
            ctx: null,
            
            init() {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // Initialize Seed Data
                let p = State.price;
                for(let i=0; i<60; i++) {
                    State.candles.push({ open: p, high: p, low: p, close: p });
                }
                
                this.loop();
            },

            resize() {
                this.canvas.width = this.canvas.parentElement.clientWidth;
                this.canvas.height = this.canvas.parentElement.clientHeight;
            },

            updateCandle(price) {
                const now = Date.now();
                let last = State.candles[State.candles.length-1];

                if (now - State.lastCandleTime > Config.candleTime) {
                    // New Candle
                    State.candles.push({ open: price, high: price, low: price, close: price });
                    if (State.candles.length > 80) State.candles.shift();
                    State.lastCandleTime = now;
                    
                    // Recalculate SNR on new candle close
                    this.calculateSNR();
                } else {
                    // Update existing
                    last.close = price;
                    if (price > last.high) last.high = price;
                    if (price < last.low) last.low = price;
                }
            },

            calculateSNR() {
                // Simple Pivot Logic: Find highest high and lowest low of last 30 candles
                const lookback = State.candles.slice(-30);
                const high = Math.max(...lookback.map(c => c.high));
                const low = Math.min(...lookback.map(c => c.low));
                
                State.snrLevels.resistance = high;
                State.snrLevels.support = low;
            },

            draw() {
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                // Scale
                const allPrices = State.candles.map(c => [c.high, c.low]).flat();
                let min = Math.min(...allPrices, State.snrLevels.support || Infinity);
                let max = Math.max(...allPrices, State.snrLevels.resistance || -Infinity);
                const padding = (max - min) * 0.2; // 20% padding
                min -= padding; max += padding;
                const range = max - min;
                
                const toY = (p) => h - ((p - min) / range * h);
                const candleW = w / 80;

                ctx.clearRect(0, 0, w, h);

                // Draw Dynamic SNR Zones
                if (State.snrLevels.resistance) {
                    const yR = toY(State.snrLevels.resistance);
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
                    ctx.fillRect(0, yR - 10, w, 20);
                    ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath(); ctx.moveTo(0, yR); ctx.lineTo(w, yR); ctx.stroke();
                    ctx.fillStyle = '#ef4444'; ctx.fillText('SUPPLY / RESISTANCE', w - 120, yR - 5);
                }
                if (State.snrLevels.support) {
                    const yS = toY(State.snrLevels.support);
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.1)';
                    ctx.fillRect(0, yS - 10, w, 20);
                    ctx.strokeStyle = 'rgba(34, 197, 94, 0.5)';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath(); ctx.moveTo(0, yS); ctx.lineTo(w, yS); ctx.stroke();
                    ctx.fillStyle = '#22c55e'; ctx.fillText('DEMAND / SUPPORT', w - 110, yS + 12);
                }

                ctx.setLineDash([]);

                // Draw Candles
                State.candles.forEach((c, i) => {
                    const x = i * candleW;
                    const isBull = c.close >= c.open;
                    ctx.strokeStyle = isBull ? '#22c55e' : '#ef4444';
                    ctx.fillStyle = isBull ? '#22c55e' : '#ef4444';
                    
                    // Wick
                    ctx.beginPath(); ctx.moveTo(x + candleW/2, toY(c.high)); ctx.lineTo(x + candleW/2, toY(c.low)); ctx.stroke();
                    
                    // Body
                    const yO = toY(c.open); const yC = toY(c.close);
                    const height = Math.abs(yO - yC);
                    ctx.fillRect(x + 1, Math.min(yO, yC), candleW - 2, Math.max(height, 1));
                });

                // Current Price Line
                const yCur = toY(State.price);
                ctx.strokeStyle = '#fff';
                ctx.beginPath(); ctx.moveTo(0, yCur); ctx.lineTo(w, yCur); ctx.stroke();
            },

            loop() {
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- DOM ENGINE (ORDER BOOK) ---
        const DOM = {
            container: document.getElementById('dom-container'),
            
            render() {
                const center = Math.round(State.price * 10) / 10;
                let html = '';
                
                // Asks
                for(let i=6; i>0; i--) {
                    const p = (center + (i * 0.1)).toFixed(1);
                    const v = this.getVol('ASK');
                    html += this.row(p, v, 'ASK');
                }
                
                // Spread
                html += `<div class="bg-white/5 py-0.5 border-y border-white/5"></div>`;
                
                // Bids
                for(let i=0; i<6; i++) {
                    const p = (center - (i * 0.1)).toFixed(1);
                    const v = this.getVol('BID');
                    html += this.row(p, v, 'BID');
                }
                
                this.container.innerHTML = html;
            },

            getVol(side) {
                // Dynamic Volume based on Regime
                let base = Math.floor(Math.random() * 50) + 10;
                
                // Logic MM: Jika Bullish, Offer menipis (sedikit yang jual), Bid menebal (banyak yang antri beli)
                if (Director.regime.includes('BULL')) {
                    if (side === 'BID') base *= 2; 
                    else base *= 0.5;
                }
                // Logic MM: Jika Bearish, Offer menebal, Bid menipis
                if (Director.regime.includes('BEAR')) {
                    if (side === 'ASK') base *= 2;
                    else base *= 0.5;
                }
                // Logic Spike: Liquidity Drying Up (Order book bolong/tipis)
                if (Director.regime.includes('SPIKE')) {
                    base = Math.floor(Math.random() * 5); // Very thin liquidity
                }

                return Math.floor(base);
            },

            row(price, vol, type) {
                const color = type === 'ASK' ? 'text-red-500' : 'text-green-500';
                const bg = type === 'ASK' ? 'bg-red-500/10' : 'bg-green-500/10';
                const barW = Math.min(vol * 2, 100);
                
                return `
                    <div class="grid grid-cols-3 text-[10px] mono py-0.5 relative hover:bg-white/5 cursor-pointer">
                        <div class="absolute top-0 ${type === 'ASK' ? 'right-0' : 'left-0'} h-full ${bg} opacity-30" style="width:${barW}%"></div>
                        <span class="${type === 'BID' ? 'font-bold text-gray-300' : 'text-transparent'} pl-2 relative z-10">${type==='BID'?vol:''}</span>
                        <span class="text-center font-bold ${color} relative z-10">${price}</span>
                        <span class="text-right ${type === 'ASK' ? 'font-bold text-gray-300' : 'text-transparent'} pr-2 relative z-10">${type==='ASK'?vol:''}</span>
                    </div>
                `;
            }
        };

        // --- TRADER ENGINE (EXECUTION) ---
        const Trader = {
            execute(side) {
                const qty = parseInt(document.getElementById('trade-qty').value);
                const px = State.price;
                
                if (side === 'BUY') {
                    const cost = (State.inventory.pos * State.inventory.avgPrice) + (qty * px);
                    State.inventory.pos += qty;
                    State.inventory.avgPrice = cost / State.inventory.pos;
                } else {
                    State.inventory.pos -= qty;
                    if(State.inventory.pos === 0) State.inventory.avgPrice = 0;
                }
                
                this.addTape(side, px, qty, true);
                this.updateUI();
            },

            addTape(side, price, qty, isUser) {
                const el = document.getElementById('tape-container');
                const color = side === 'BUY' ? 'text-green-500' : 'text-red-500';
                const bg = isUser ? 'bg-blue-900/30 border-l-2 border-blue-500' : '';
                
                const html = `
                    <div class="grid grid-cols-3 row-enter ${bg} ${color}">
                        <span>${new Date().toLocaleTimeString().split(' ')[0]}</span>
                        <span class="text-center">${price.toFixed(1)}</span>
                        <span class="text-right font-bold ${isUser ? 'text-blue-400' : ''}">${qty}</span>
                    </div>
                `;
                el.insertAdjacentHTML('afterbegin', html);
                if(el.children.length > 15) el.lastChild.remove();
            },

            updateUI() {
                const pos = State.inventory.pos;
                const pl = (State.price - State.inventory.avgPrice) * pos * Config.pointValue; // Simplified multiplier
                
                document.getElementById('net-pos').innerText = pos;
                const plEl = document.getElementById('pnl-display');
                plEl.innerText = `IDR ${Math.round(pl).toLocaleString()}`;
                plEl.className = `font-black mono text-lg ${pl >= 0 ? 'text-green-500' : 'text-red-500'}`;
            }
        };

        // --- MAIN LOOP ---
        function MarketLoop() {
            // Calculate movement
            // Formula: Random Walk + Director Bias + Volatility Noise
            const noise = (Math.random() - 0.5) * Director.volatility; 
            const trend = Director.bias * 0.2; 
            
            // Logic: Price gravitates towards trend but has noise
            State.price += noise + trend;
            
            // UI Updates
            const disp = document.getElementById('price-display');
            disp.innerText = State.price.toFixed(2);
            
            // Animation Color
            if (noise + trend > 0) {
                disp.classList.remove('text-red-500', 'flash-down');
                disp.classList.add('text-green-500', 'flash-up');
            } else {
                disp.classList.remove('text-green-500', 'flash-up');
                disp.classList.add('text-red-500', 'flash-down');
            }

            Chart.updateCandle(State.price);
            DOM.render();
            Trader.updateUI();
            
            // Fake Retail Tape Flow
            if(Math.random() < 0.3) {
                const side = Math.random() > 0.5 ? 'BUY' : 'SELL';
                const qty = Math.floor(Math.random() * 5) + 1;
                Trader.addTape(side, State.price, qty, false);
            }
        }

        // --- INIT ---
        window.onload = () => {
            Director.init();
            Chart.init();
            setInterval(MarketLoop, Config.tickRate);
        };

    </script>
</body>
</html>
