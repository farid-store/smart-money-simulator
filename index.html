<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAlgo Pro MM - Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; background-color: #0b0e11; color: #e1e4e8; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .sb-card { background-color: #151921; border: 1px solid #2a2e39; }
        .sb-border { border-color: #2a2e39; }
        .text-buy { color: #26a69a; }
        .text-sell { color: #ef5350; }
        .bg-buy { background-color: rgba(38, 166, 154, 0.15); }
        .bg-sell { background-color: rgba(239, 83, 80, 0.15); }
        input[type="number"] { background: #000; border: 1px solid #333; color: #00ff00; text-align: center; border-radius: 4px; }
        .market-depth-bar { height: 100%; position: absolute; right: 0; top: 0; opacity: 0.2; transition: width 0.3s ease; }
    </style>
</head>
<body x-data="mmEngine()" x-init="init()">

    <header class="h-14 bg-[#151921] border-b sb-border flex items-center justify-between px-6">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-green-600 rounded flex items-center justify-center font-bold text-white">S</div>
                <span class="font-bold tracking-tight">STOCKBIT <span class="text-green-500 italic">MM-PRO</span></span>
            </div>
            <div class="h-6 w-[1px] bg-gray-700"></div>
            <div>
                <span class="text-[10px] text-gray-500 block uppercase font-bold">Ticker</span>
                <span class="text-lg font-bold">BBCA <span class="text-xs font-normal text-gray-400">PT Bank Central Asia Tbk.</span></span>
            </div>
        </div>

        <div class="flex items-center space-x-10">
            <div class="text-right">
                <span class="text-[10px] text-gray-500 block uppercase font-bold">Unrealized P/L</span>
                <span :class="pnl >= 0 ? 'text-buy' : 'text-sell'" class="text-lg font-bold mono" x-text="formatCurrency(pnl)"></span>
            </div>
            <div class="bg-black/40 px-4 py-2 rounded border sb-border">
                <span class="text-[10px] text-gray-400 mr-2 uppercase">Market:</span>
                <select x-model="marketMode" class="bg-transparent text-yellow-500 font-bold outline-none text-xs">
                    <option value="normal">NORMAL VOLATILITY</option>
                    <option value="chaos">CHAOS MODE (Retail Panic)</option>
                </select>
            </div>
        </div>
    </header>

    <div class="flex h-[calc(100vh-56px)] overflow-hidden">
        
        <div class="flex-1 flex flex-col p-2 space-y-2">
            <div class="sb-card flex-grow rounded-lg relative overflow-hidden">
                <div id="chartContainer" class="w-full h-full"></div>
            </div>
            
            <div class="h-40 sb-card rounded-lg p-3 overflow-hidden flex flex-col">
                <div class="text-[10px] text-gray-500 font-bold uppercase mb-2 flex justify-between">
                    <span>Engine Activity Logs</span>
                    <span class="text-green-500">System Live</span>
                </div>
                <div class="flex-1 overflow-y-auto space-y-1 mono text-[11px] text-gray-400" id="logs">
                    <template x-for="log in logs">
                        <div class="flex space-x-2">
                            <span class="text-gray-600" x-text="log.time"></span>
                            <span :class="log.color" x-text="log.msg"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div class="w-[420px] p-2 flex flex-col space-y-2 overflow-y-auto">
            
            <div class="sb-card p-4 rounded-lg grid grid-cols-2 gap-4">
                <div>
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Net Inventory</p>
                    <p class="text-xl font-bold mono" :class="inventory > 0 ? 'text-buy' : inventory < 0 ? 'text-sell' : ''" x-text="inventory + ' LOT'"></p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Avg. Price</p>
                    <p class="text-xl font-bold mono text-blue-400" x-text="Math.round(avgPrice)"></p>
                </div>
            </div>

            <div class="sb-card p-4 rounded-lg border-t-4 border-green-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xs uppercase tracking-widest flex items-center">
                        <i data-lucide="zap" class="w-3 h-3 mr-2 text-yellow-500"></i> Algo Quoting Engine
                    </h3>
                    <button @click="toggleAlgo()" 
                            :class="algoActive ? 'bg-red-600' : 'bg-green-600'"
                            class="px-4 py-1 rounded text-[10px] font-bold transition-all shadow-lg uppercase"
                            x-text="algoActive ? 'Stop Engine' : 'Start Engine'">
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="flex flex-col">
                        <label class="text-[9px] text-gray-500 uppercase mb-1">Spread Ticks</label>
                        <input type="number" x-model="config.spread" min="1">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[9px] text-gray-500 uppercase mb-1">Lot Size Per Quote</label>
                        <input type="number" x-model="config.lotSize">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1">
                    <button @click="config.strategy = 'passive'" :class="config.strategy === 'passive' ? 'bg-blue-600 border-blue-400' : 'bg-gray-800'" class="py-2 rounded text-[9px] font-bold border border-transparent uppercase">Passive</button>
                    <button @click="config.strategy = 'accum'" :class="config.strategy === 'accum' ? 'bg-green-600 border-green-400' : 'bg-gray-800'" class="py-2 rounded text-[9px] font-bold border border-transparent uppercase">Accum</button>
                    <button @click="config.strategy = 'distrib'" :class="config.strategy === 'distrib' ? 'bg-red-600 border-red-400' : 'bg-gray-800'" class="py-2 rounded text-[9px] font-bold border border-transparent uppercase">Distrib</button>
                </div>
            </div>

            <div class="sb-card flex-grow rounded-lg overflow-hidden flex flex-col min-h-[400px]">
                <div class="grid grid-cols-4 text-[10px] font-bold text-gray-500 p-2 border-b sb-border uppercase text-center">
                    <span>Freq</span><span>Bid Vol</span><span>Price</span><span>Offer Vol</span>
                </div>
                
                <div class="flex-grow overflow-y-auto scrollbar-hide">
                    <div class="flex flex-col-reverse">
                        <template x-for="(ask, i) in asks" :key="ask.price">
                            <div class="grid grid-cols-4 py-[3px] px-2 text-[11px] mono relative hover:bg-white/5 cursor-pointer">
                                <div class="absolute right-0 top-0 bg-sell market-depth-bar" :style="`width: ${calculateBar(ask.vol)}%`"></div>
                                <span class="text-gray-600 text-[10px]" x-text="ask.freq"></span>
                                <span></span>
                                <span class="text-sell font-bold text-center" x-text="ask.price"></span>
                                <span class="text-right pr-2" x-text="formatVol(ask.vol)"></span>
                            </div>
                        </template>
                    </div>

                    <div class="bg-black/50 py-2 border-y sb-border flex justify-center items-center space-x-4">
                        <span class="text-lg font-bold" :class="lastPrice > prevPrice ? 'text-buy' : 'text-sell'" x-text="lastPrice"></span>
                        <span class="text-[10px] text-gray-500">SPREAD: <span class="text-white" x-text="asks[0].price - bids[0].price"></span></span>
                    </div>

                    <div>
                        <template x-for="(bid, i) in bids" :key="bid.price">
                            <div class="grid grid-cols-4 py-[3px] px-2 text-[11px] mono relative hover:bg-white/5 cursor-pointer">
                                <div class="absolute left-0 top-0 bg-buy market-depth-bar" :style="`width: ${calculateBar(bid.vol)}%`"></div>
                                <span class="text-left pl-2" x-text="formatVol(bid.vol)"></span>
                                <span class="text-buy font-bold text-center" x-text="bid.price"></span>
                                <span></span>
                                <span class="text-gray-600 text-right text-[10px]" x-text="bid.freq"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button @click="manualTrade('BUY')" class="bg-buy border border-buy text-buy py-3 rounded font-bold hover:bg-green-500/20 uppercase text-xs">Haka Market</button>
                <button @click="manualTrade('SELL')" class="bg-sell border border-sell text-sell py-3 rounded font-bold hover:bg-red-500/20 uppercase text-xs">Haki Market</button>
            </div>
        </div>
    </div>

    <script>
        function mmEngine() {
            return {
                lastPrice: 9850,
                prevPrice: 9850,
                inventory: 0,
                avgPrice: 0,
                totalCost: 0,
                pnl: 0,
                marketMode: 'normal',
                algoActive: false,
                bids: [],
                asks: [],
                logs: [],
                config: {
                    spread: 2,
                    lotSize: 500,
                    strategy: 'passive', // passive, accum, distrib
                },
                chartSeries: null,

                init() {
                    lucide.createIcons();
                    this.initChart();
                    this.generateInitialBook();
                    this.startMarketSimulation();
                    this.addLog("Terminal Initialized. Ready for Market Making.", "text-white font-bold");
                },

                initChart() {
                    const chart = LightweightCharts.createChart(document.getElementById('chartContainer'), {
                        layout: { backgroundColor: 'transparent', textColor: '#808a9d', fontSize: 10 },
                        grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                        rightPriceScale: { borderVisible: false },
                        timeScale: { borderVisible: false, timeVisible: true },
                    });
                    this.chartSeries = chart.addCandlestickSeries({
                        upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
                        wickUpColor: '#26a69a', wickDownColor: '#ef5350'
                    });
                    
                    // Initial Dummy Data
                    let base = 9800;
                    let data = [];
                    for(let i=0; i<50; i++) {
                        let open = base + Math.random()*20;
                        let close = open + (Math.random()-0.5)*40;
                        data.push({ time: Date.now()/1000 - (50-i)*60, open, high: Math.max(open,close)+10, low: Math.min(open,close)-10, close });
                        base = close;
                    }
                    this.chartSeries.setData(data);
                },

                generateInitialBook() {
                    for(let i=0; i<15; i++) {
                        this.asks.push({ price: this.lastPrice + (i+1)*25, vol: this.rand(100, 5000), freq: this.rand(1, 20) });
                        this.bids.push({ price: this.lastPrice - (i)*25, vol: this.rand(100, 5000), freq: this.rand(1, 20) });
                    }
                },

                startMarketSimulation() {
                    setInterval(() => {
                        // Retail / Noise Simulation
                        const side = Math.random() > 0.5 ? 'BUY' : 'SELL';
                        const size = this.marketMode === 'chaos' ? this.rand(500, 2000) : this.rand(10, 200);
                        this.executeTrade(side, size, false);

                        // Replenish passive orders
                        this.bids.forEach(b => b.vol += this.rand(0, 50));
                        this.asks.forEach(a => a.vol += this.rand(0, 50));

                        // Algo Cycle
                        if(this.algoActive) this.runAlgoCycle();

                    }, 800);
                },

                runAlgoCycle() {
                    // MM Logic: Rebalancing & Quoting
                    this.addLog(`Algo Quoting... Strategy: ${this.config.strategy}`, "text-blue-400");
                    
                    if(this.config.strategy === 'passive') {
                        // Maintain Spread
                        this.bids[0].vol += parseInt(this.config.lotSize);
                        this.asks[0].vol += parseInt(this.config.lotSize);
                    } else if(this.config.strategy === 'accum') {
                        this.executeTrade('BUY', this.config.lotSize, true);
                    } else if(this.config.strategy === 'distrib') {
                        this.executeTrade('SELL', this.config.lotSize, true);
                    }
                },

                executeTrade(side, size, isAlgo) {
                    this.prevPrice = this.lastPrice;
                    if(side === 'BUY') {
                        let target = this.asks[0];
                        if(size >= target.vol) {
                            this.lastPrice = target.price;
                            this.asks.shift();
                            this.asks.push({ price: this.asks[this.asks.length-1].price + 25, vol: this.rand(500, 5000), freq: 1 });
                        } else {
                            target.vol -= size;
                            this.lastPrice = target.price;
                        }
                        if(isAlgo) this.updateInventory('BUY', this.lastPrice, size);
                    } else {
                        let target = this.bids[0];
                        if(size >= target.vol) {
                            this.lastPrice = target.price;
                            this.bids.shift();
                            this.bids.push({ price: this.bids[this.bids.length-1].price - 25, vol: this.rand(500, 5000), freq: 1 });
                        } else {
                            target.vol -= size;
                            this.lastPrice = target.price;
                        }
                        if(isAlgo) this.updateInventory('SELL', this.lastPrice, size);
                    }
                    this.updatePNL();
                },

                updateInventory(side, price, lot) {
                    if(side === 'BUY') {
                        this.totalCost += (price * lot);
                        this.inventory += parseInt(lot);
                    } else {
                        this.inventory -= parseInt(lot);
                        if(this.inventory === 0) this.totalCost = 0;
                    }
                    this.avgPrice = this.inventory === 0 ? 0 : this.totalCost / this.inventory;
                },

                updatePNL() {
                    if(this.inventory === 0) {
                        this.pnl = 0;
                    } else {
                        this.pnl = (this.lastPrice - this.avgPrice) * this.inventory * 100;
                    }
                },

                manualTrade(side) {
                    const size = parseInt(this.config.lotSize);
                    this.executeTrade(side, size, true);
                    this.addLog(`MANUAL ${side} EXECUTED: ${size} LOT at ${this.lastPrice}`, side === 'BUY' ? 'text-buy' : 'text-sell');
                },

                toggleAlgo() {
                    this.algoActive = !this.algoActive;
                    this.addLog(`System: Algo Engine ${this.algoActive ? 'STARTED' : 'STOPPED'}`, this.algoActive ? 'text-green-500' : 'text-red-500');
                },

                addLog(msg, color) {
                    const time = new Date().toLocaleTimeString([], { hour12: false });
                    this.logs.unshift({ time, msg, color });
                    if(this.logs.length > 50) this.logs.pop();
                },

                formatCurrency(v) {
                    return "IDR " + new Intl.NumberFormat('id-ID').format(Math.round(v));
                },

                formatVol(v) {
                    return new Intl.NumberFormat('id-ID').format(v);
                },

                calculateBar(vol) {
                    const max = 10000;
                    return Math.min((vol / max) * 100, 100);
                },

                rand(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
            }
        }
    </script>
</body>
</html>
