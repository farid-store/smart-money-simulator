<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM Terminal: Smart Money Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #050505; --bg-panel: #0B0E11; --border: #1E2329;
            --up: #0ECB81; --down: #F6465D; --accent: #F0B90B;
            --liq: #FF9800;
        }
        body { background: var(--bg-body); color: #EAECEF; font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .border-c { border-color: var(--border); }
        .text-up { color: var(--up); } .text-down { color: var(--down); } .text-liq { color: var(--liq); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Animations */
        @keyframes flash-green { 0% { background-color: rgba(14, 203, 129, 0.5); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(246, 70, 93, 0.5); } 100% { background-color: transparent; } }
        .flash-up { animation: flash-green 0.3s ease-out; }
        .flash-down { animation: flash-red 0.3s ease-out; }

        /* UI Elements */
        .btn-mm { @apply w-full py-2 text-[10px] font-bold uppercase tracking-wider border border-c rounded transition hover:brightness-110 active:scale-95; }
        .bar-vol { height: 100%; position: absolute; opacity: 0.2; transition: width 0.1s; }
    </style>
</head>
<body class="flex flex-col h-screen w-screen text-[12px]">

    <header class="h-[50px] bg-panel border-b border-c flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <div class="flex flex-col">
                <span class="text-[9px] text-gray-500 font-bold uppercase">MARKET MAKER ID</span>
                <span class="text-xs font-bold text-accent">CITADEL-ALGO-01</span>
            </div>
            <div class="h-6 w-px bg-gray-800"></div>
            <div class="flex flex-col w-[180px]">
                <span class="text-[9px] text-gray-500 font-bold uppercase flex justify-between">
                    <span>RETAIL SENTIMENT</span>
                    <span id="sentiment-text" class="text-white">Neutral</span>
                </span>
                <div class="w-full h-1.5 bg-gray-800 rounded-full mt-1 overflow-hidden">
                    <div id="sentiment-bar" class="h-full bg-gray-500 transition-all duration-500" style="width: 50%"></div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-8 text-right">
            <div>
                <span class="text-[9px] text-gray-500 block font-bold">NET INVENTORY (RISK)</span>
                <span class="text-sm font-bold mono" id="head-inv">0 LOT</span>
            </div>
            <div>
                <span class="text-[9px] text-gray-500 block font-bold">REALIZED PNL</span>
                <span class="text-sm font-bold mono" id="head-pnl">$0.00</span>
            </div>
            <div class="text-right">
                 <span class="text-[9px] text-gray-500 block font-bold">AVAILABLE LIQUIDITY</span>
                 <span class="text-sm font-bold mono text-accent" id="head-cash">$1,000,000</span>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="flex-1 flex flex-col bg-[#000] relative border-r border-c">
            <div class="absolute top-3 left-3 z-10 flex gap-2 pointer-events-none">
                <div class="px-2 py-1 bg-panel border border-c rounded text-xs font-bold text-white shadow-lg">
                    <span class="text-gray-500 mr-1">BTC/USD</span>
                    <span id="chart-price" class="mono text-lg">0.00</span>
                </div>
                <div class="px-2 py-1 bg-black/60 border border-liq/50 rounded text-[10px] text-liq flex items-center gap-1">
                    <div class="w-2 h-2 rounded-full bg-liq animate-pulse"></div>
                    LIQUIDITY POOLS DETECTED
                </div>
            </div>
            <canvas id="chartCanvas" class="w-full h-full cursor-crosshair"></canvas>
        </div>

        <div class="w-[380px] flex flex-col bg-panel shrink-0 border-l border-c">
            
            <div class="h-[40%] flex flex-col border-b border-c bg-[#050505]">
                <div class="px-2 py-1 bg-[#161A25] border-b border-c flex justify-between items-center">
                    <span class="text-[10px] font-bold text-gray-400">ORDER BOOK (L2)</span>
                    <span class="text-[9px] mono text-gray-600">Active Spoofing: <span id="spoof-status" class="text-gray-500">OFF</span></span>
                </div>
                <div id="book-asks" class="flex-1 overflow-hidden flex flex-col-reverse justify-end pb-1"></div>
                <div class="py-1 border-y border-c bg-[#111] text-center text-[10px] text-gray-500 font-mono flex justify-between px-4">
                    <span>SPREAD</span><span id="spread-val" class="text-white">0.00</span>
                </div>
                <div id="book-bids" class="flex-1 overflow-hidden pt-1"></div>
            </div>

            <div class="h-[20%] flex flex-col border-b border-c bg-[#050505]">
                <div class="px-2 py-1 bg-[#161A25] border-b border-c">
                    <span class="text-[10px] font-bold text-gray-400">TAPE (TIME & SALES)</span>
                </div>
                <div id="tape" class="flex-1 overflow-y-hidden font-mono text-[10px]"></div>
            </div>

            <div class="flex-1 flex flex-col p-3 gap-3 overflow-y-auto bg-panel">
                
                <div>
                    <label class="text-[9px] text-gray-500 font-bold mb-1 block">MANUAL INTERVENTION</label>
                    <div class="flex gap-2 mb-2">
                        <input type="number" id="input-qty" value="1.0" class="w-1/3 bg-black border border-c text-white px-2 py-1 text-right mono font-bold rounded focus:border-accent outline-none">
                        <button onclick="MM.execute('BUY')" class="flex-1 bg-[#0ECB81]/10 border border-[#0ECB81] text-[#0ECB81] hover:bg-[#0ECB81] hover:text-black font-bold rounded transition">BUY</button>
                        <button onclick="MM.execute('SELL')" class="flex-1 bg-[#F6465D]/10 border border-[#F6465D] text-[#F6465D] hover:bg-[#F6465D] hover:text-white font-bold rounded transition">SELL</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[9px] text-accent font-bold mb-1 block tracking-widest text-center border-b border-c pb-1">--- ALGO STRATEGIES ---</label>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="ALGO.toggleSpoof('BID')" id="btn-spoof-bid" class="btn-mm bg-gray-800 text-gray-400 border-gray-700">
                            üõ°Ô∏è SPOOF BID WALL
                        </button>
                        <button onclick="ALGO.toggleSpoof('ASK')" id="btn-spoof-ask" class="btn-mm bg-gray-800 text-gray-400 border-gray-700">
                            üõ°Ô∏è SPOOF ASK WALL
                        </button>
                    </div>
                    <p class="text-[9px] text-gray-600 leading-tight">*Create fake orders to push retail price. Will vanish if hit.</p>

                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="ALGO.triggerIceberg('BUY')" class="btn-mm bg-blue-900/30 border-blue-800 text-blue-400">
                            üßä ICEBERG BUY
                        </button>
                        <button onclick="ALGO.triggerIceberg('SELL')" class="btn-mm bg-blue-900/30 border-blue-800 text-blue-400">
                            üßä ICEBERG SELL
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <button onclick="ALGO.liquidityGrab()" class="btn-mm bg-orange-900/20 border-orange-600 text-orange-500 animate-pulse border-dashed">
                            üéØ TRIGGER STOP HUNT (GRAB LIQ)
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

<script>
/**
 * MARKET MAKER SIMULATOR CORE
 * Focus: Liquidity, Inventory Management, Manipulation
 */

const $ = (id) => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// --- CONFIGURATION ---
const CONFIG = {
    pair: 'BTC/USD',
    tickSize: 0.5,
    initialPrice: 97500.00,
    lotSize: 100000 // Multiplier for realism
};

// --- GLOBAL STATE ---
const STATE = {
    price: CONFIG.initialPrice,
    cash: 1000000,
    inventory: 0, // Net position (Positive = Long, Negative = Short)
    avgEntry: 0,
    realizedPnL: 0,
    
    // Market Data
    bids: [], 
    asks: [],
    trades: [], // Tape
    candles: [],
    liquidityZones: [], // Price levels where stops are
    
    // Algo State
    spoofing: { active: false, side: null, id: null },
    iceberg: { active: false, remaining: 0, side: null },
    retailSentiment: 50 // 0 (Fear) - 100 (Greed)
};

// --- CHART & VISUALS ---
const VIEW = {
    canvas: $('chartCanvas'),
    ctx: $('chartCanvas').getContext('2d'),

    init() {
        this.resize();
        window.onresize = () => this.resize();
        this.generateHistory();
        this.renderLoop();
    },

    resize() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
    },

    generateHistory() {
        let p = STATE.price;
        let now = Date.now();
        for(let i=100; i>0; i--) {
            let change = (Math.random()-0.5) * 50;
            let o = p;
            let c = p + change;
            let h = Math.max(o,c) + Math.random()*20;
            let l = Math.min(o,c) - Math.random()*20;
            STATE.candles.push({t: now-(i*60000), o, h, l, c});
            p = c;
        }
        STATE.price = p;
        // Generate initial Liquidity Pools (Highs/Lows)
        this.updateLiquidityZones();
    },

    updateLiquidityZones() {
        // Simple logic: Local Highs and Lows are Liquidity Pools
        STATE.liquidityZones = [];
        const data = STATE.candles.slice(-50);
        let max = Math.max(...data.map(d=>d.h));
        let min = Math.min(...data.map(d=>d.l));
        STATE.liquidityZones.push({price: max + 5, type: 'BUY_STOPS', hit: false});
        STATE.liquidityZones.push({price: min - 5, type: 'SELL_STOPS', hit: false});
    },

    renderLoop() {
        const ctx = this.ctx;
        const w = this.canvas.width, h = this.canvas.height;
        ctx.fillStyle = '#050505'; ctx.fillRect(0,0,w,h);

        // Draw Candles
        const data = STATE.candles.slice(-80); // View last 80
        if(data.length === 0) return requestAnimationFrame(()=>this.renderLoop());

        let prices = data.map(d=>[d.h,d.l]).flat();
        let min = Math.min(...prices, ...STATE.liquidityZones.map(z=>z.price));
        let max = Math.max(...prices, ...STATE.liquidityZones.map(z=>z.price));
        let pad = (max-min)*0.1; min-=pad; max+=pad;
        
        const getY = p => h - ((p-min)/(max-min))*h;
        const getX = i => i * (w/80);
        const barW = (w/80) * 0.7;

        // Grid
        ctx.strokeStyle = '#1E2329'; ctx.lineWidth = 1;
        ctx.beginPath();
        for(let p=Math.floor(min/100)*100; p<max; p+=100) {
            let y = getY(p); ctx.moveTo(0,y); ctx.lineTo(w,y);
        }
        ctx.stroke();

        // Liquidity Lines (The Hunter's Targets)
        STATE.liquidityZones.forEach(z => {
            if(z.hit) return;
            let y = getY(z.price);
            ctx.strokeStyle = '#FF9800'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
            ctx.fillStyle = '#FF9800'; ctx.font = '10px Inter';
            ctx.fillText(z.type === 'BUY_STOPS' ? 'LIQ POOL (BUY STOPS)' : 'LIQ POOL (SELL STOPS)', w-130, y-5);
        });
        ctx.setLineDash([]);

        // Candles
        data.forEach((d, i) => {
            let x = getX(i);
            let color = d.c >= d.o ? '#0ECB81' : '#F6465D';
            ctx.fillStyle = color; ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(x+barW/2, getY(d.h)); ctx.lineTo(x+barW/2, getY(d.l)); ctx.stroke();
            ctx.fillRect(x, getY(Math.max(d.o,d.c)), barW, Math.abs(getY(d.o)-getY(d.c))||1);
        });

        // Current Price Line
        let cy = getY(STATE.price);
        ctx.strokeStyle = '#fff'; ctx.setLineDash([2,2]);
        ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(w,cy); ctx.stroke();
        
        requestAnimationFrame(()=>this.renderLoop());
    }
};

// --- ENGINE: ORDER BOOK & MATCHING ---
const MM = {
    init() {
        this.fillBook();
        this.uiTicker();
        setInterval(() => this.marketDynamics(), 500); // Retail Reaction Loop
        setInterval(() => this.updateCandle(), 1000);
    },

    fillBook() {
        STATE.bids = []; STATE.asks = [];
        for(let i=1; i<=15; i++) {
            STATE.asks.push({price: STATE.price + (i*CONFIG.tickSize), vol: Math.random()*2});
            STATE.bids.push({price: STATE.price - (i*CONFIG.tickSize), vol: Math.random()*2});
        }
    },

    execute(side, qtyOverride=null, isMaker=true) {
        let qty = qtyOverride || parseFloat($('input-qty').value);
        if(!qty || qty <= 0) return;

        let book = side === 'BUY' ? STATE.asks : STATE.bids;
        let filled = 0;
        let avgPrice = 0;
        let totalCost = 0;

        // Matching Logic
        while(qty > 0 && book.length > 0) {
            let best = book[0];
            
            // Check for Spoofing Walls (Fake Liquidity)
            if(STATE.spoofing.active && ((side==='BUY' && STATE.spoofing.side==='ASK') || (side==='SELL' && STATE.spoofing.side==='BID'))) {
                // If price hits spoof wall, remove wall instantly (User cancels to avoid fill)
                if(Math.abs(best.price - STATE.price) < CONFIG.tickSize*3) {
                    ALGO.toggleSpoof(STATE.spoofing.side); // Turn off
                    book[0].vol = Math.random(); // Reset to normal
                }
            }

            let tradeVol = Math.min(qty, best.vol);
            
            best.vol -= tradeVol;
            qty -= tradeVol;
            filled += tradeVol;
            totalCost += (best.price * tradeVol);

            // Update Price
            STATE.price = best.price;

            // Remove empty levels
            if(best.vol <= 0.01) {
                book.shift();
                // Refill book edge
                let lastP = book[book.length-1].price;
                let newP = side === 'BUY' ? lastP + CONFIG.tickSize : lastP - CONFIG.tickSize;
                book.push({price: newP, vol: Math.random()*2});
            }
        }

        // Update State
        if(filled > 0) {
            avgPrice = totalCost / filled;
            
            // Update Inventory (User Side)
            if(isMaker) {
                if(side === 'BUY') {
                    STATE.inventory += filled;
                    STATE.cash -= totalCost;
                } else {
                    STATE.inventory -= filled;
                    STATE.cash += totalCost;
                }
            }

            // Tape Print
            let time = new Date().toLocaleTimeString().split(' ')[0];
            STATE.trades.unshift({time, price: avgPrice, vol: filled, side});
            if(STATE.trades.length > 20) STATE.trades.pop();

            this.checkLiquidityPools();
            this.updateUI();
        }
    },

    checkLiquidityPools() {
        STATE.liquidityZones.forEach(z => {
            if(z.hit) return;
            let hit = (z.type === 'BUY_STOPS' && STATE.price >= z.price) || 
                      (z.type === 'SELL_STOPS' && STATE.price <= z.price);
            
            if(hit) {
                z.hit = true;
                // Liquidity Grab Effect! Price accelerates
                let push = z.type === 'BUY_STOPS' ? 1 : -1;
                STATE.retailSentiment = z.type === 'BUY_STOPS' ? 90 : 10; // Extreme FOMO/Panic
                
                // Cascade Effect (Stop Loss triggers more orders)
                let cascade = setInterval(() => {
                    this.execute(z.type==='BUY_STOPS'?'BUY':'SELL', 5, false); // Bot orders
                }, 100);
                setTimeout(() => { 
                    clearInterval(cascade); 
                    VIEW.updateLiquidityZones(); // Generate new targets
                }, 1000);
            }
        });
    },

    updateCandle() {
        let last = STATE.candles[STATE.candles.length-1];
        if(Date.now() - last.t > 60000) {
            STATE.candles.push({t: Date.now(), o: STATE.price, h: STATE.price, l: STATE.price, c: STATE.price});
            if(STATE.candles.length > 100) STATE.candles.shift();
        } else {
            last.c = STATE.price;
            if(STATE.price > last.h) last.h = STATE.price;
            if(STATE.price < last.l) last.l = STATE.price;
        }
    },

    marketDynamics() {
        // 1. Retail Sentiment Reaction
        // If price moves up fast, retail gets FOMO (Buys)
        // If Inventory is heavy, Market Maker (User) wants to manipulate price against retail.
        
        let retailAction = Math.random();
        
        // If Spoof Wall exists, Price tends to move AWAY from it
        if(STATE.spoofing.active) {
            if(STATE.spoofing.side === 'BID') {
                // Fake support -> Retail buys -> Price Up
                if(Math.random() < 0.7) this.execute('BUY', Math.random()*0.5, false);
            } else {
                // Fake resistance -> Retail sells -> Price Down
                if(Math.random() < 0.7) this.execute('SELL', Math.random()*0.5, false);
            }
        } else {
            // Random Noise
            if(Math.random() < 0.3) {
                let side = Math.random() > 0.5 ? 'BUY' : 'SELL';
                this.execute(side, Math.random()*0.3, false);
            }
        }

        // Iceberg Execution
        if(STATE.iceberg.active) {
            if(STATE.iceberg.remaining > 0) {
                let chunk = Math.random() * 0.5;
                this.execute(STATE.iceberg.side, chunk, true);
                STATE.iceberg.remaining -= chunk;
            } else {
                STATE.iceberg.active = false;
            }
        }
    },

    uiTicker() {
        requestAnimationFrame(() => this.uiTicker());
        
        // DOM Rendering
        const renderRow = (item, side) => {
            let width = Math.min((item.vol / 5) * 100, 100); // 5 BTC max visual
            let color = side === 'ask' ? 'bg-[#F6465D]' : 'bg-[#0ECB81]';
            let isSpoof = item.vol > 10; // Visual cue for spoof wall
            return `<div class="relative flex justify-between px-2 py-0.5 text-[10px] hover:bg-white/5 cursor-pointer" onclick="MM.execute('${side==='ask'?'BUY':'SELL'}', ${item.vol})">
                <div class="${color} bar-vol" style="width: ${width}%"></div>
                <span class="z-10 text-gray-400 font-mono">${isSpoof ? 'üõ°Ô∏è' : ''} ${item.vol.toFixed(2)}</span>
                <span class="z-10 font-bold font-mono ${side==='ask'?'text-down':'text-up'}">${item.price.toFixed(1)}</span>
            </div>`;
        }

        $('book-asks').innerHTML = STATE.asks.slice(0,8).reverse().map(i => renderRow(i, 'ask')).join('');
        $('book-bids').innerHTML = STATE.bids.slice(0,8).map(i => renderRow(i, 'bid')).join('');
        $('spread-val').innerText = (STATE.asks[0].price - STATE.bids[0].price).toFixed(1);

        // Tape Rendering
        $('tape').innerHTML = STATE.trades.map(t => 
            `<div class="grid grid-cols-3 px-2 ${t.side==='BUY'?'text-up':'text-down'} border-b border-c/20">
                <span>${t.time}</span><span class="text-center">${t.price.toFixed(1)}</span><span class="text-right">${t.vol.toFixed(2)}</span>
            </div>`
        ).join('');

        // Header Stats
        $('head-inv').innerText = STATE.inventory.toFixed(2) + " BTC";
        $('head-inv').className = `text-sm font-bold mono ${STATE.inventory > 0 ? 'text-up' : STATE.inventory < 0 ? 'text-down' : 'text-white'}`;
        
        // Sentiment
        $('sentiment-bar').style.width = STATE.retailSentiment + "%";
        $('sentiment-text').innerText = STATE.retailSentiment > 70 ? "EXTREME GREED" : STATE.retailSentiment < 30 ? "PANIC SELLING" : "NEUTRAL";
        
        // Chart Header
        $('chart-price').innerText = STATE.price.toFixed(2);
    }
};

// --- ALGORITHMS (THE WEAPONS) ---
const ALGO = {
    toggleSpoof(side) {
        // Toggle Logic
        if(STATE.spoofing.active && STATE.spoofing.side === side) {
            STATE.spoofing.active = false;
            $('spoof-status').innerText = "OFF";
            $('spoof-status').className = "text-gray-500";
            $('btn-spoof-bid').classList.remove('border-accent', 'text-accent');
            $('btn-spoof-ask').classList.remove('border-accent', 'text-accent');
            // Remove fake volume
            MM.fillBook(); 
            return;
        }

        // Activate Spoofing
        STATE.spoofing.active = true;
        STATE.spoofing.side = side;
        $('spoof-status').innerText = `ACTIVE (${side})`;
        $('spoof-status').className = "text-accent animate-pulse font-bold";
        
        // Visual Button Feedback
        if(side==='BID') $('btn-spoof-bid').classList.add('border-accent', 'text-accent');
        else $('btn-spoof-ask').classList.add('border-accent', 'text-accent');

        // Inject Fake Volume
        let book = side === 'BID' ? STATE.bids : STATE.asks;
        // Add huge volume 3 ticks away
        book[2].vol = 50 + Math.random()*20; 
        book[3].vol = 50 + Math.random()*20;
    },

    triggerIceberg(side) {
        STATE.iceberg.active = true;
        STATE.iceberg.side = side;
        STATE.iceberg.remaining = 20.0; // Executing 20 BTC stealthily
        alert(`üßä ICEBERG ALGO ACTIVATED: Accumulating 20 BTC (${side})`);
    },

    liquidityGrab() {
        // Find nearest zone
        let target = STATE.liquidityZones.find(z => !z.hit);
        if(!target) return alert("No Liquidity Pools visible nearby!");

        let side = target.type === 'BUY_STOPS' ? 'BUY' : 'SELL';
        alert(`üéØ INITIATING STOP HUNT to ${target.price}`);
        
        // Aggressive buying/selling to push price
        let hunt = setInterval(() => {
            MM.execute(side, 2.0, true);
            if(side === 'BUY' && STATE.price >= target.price) clearInterval(hunt);
            if(side === 'SELL' && STATE.price <= target.price) clearInterval(hunt);
        }, 100);
    }
};

window.onload = () => { VIEW.init(); MM.init(); };
</script>
</body>
</html>
