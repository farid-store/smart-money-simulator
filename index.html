<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANDAR OS: Market Maker Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b; --bg-card: #121214; --bg-hover: #1c1c1f;
            --border: #27272a;
            --up: #22c55e; --down: #ef4444; --neutral: #94a3b8;
            --bandar: #8b5cf6; /* Warna Ungu untuk Bandar */
            --retail: #fbbf24; /* Warna Kuning untuk Retail/YP */
        }
        
        body { background: var(--bg-dark); color: #e4e4e7; font-family: 'Inter', sans-serif; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .text-up { color: var(--up); } .text-down { color: var(--down); }
        .bg-up-dim { background: rgba(34, 197, 94, 0.1); } .bg-down-dim { background: rgba(239, 68, 68, 0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 2px; }

        /* Animation */
        .flash-bg-green { animation: flashG 0.5s; }
        .flash-bg-red { animation: flashR 0.5s; }
        @keyframes flashG { 0% { background: rgba(34, 197, 94, 0.3); } 100% { background: transparent; } }
        @keyframes flashR { 0% { background: rgba(239, 68, 68, 0.3); } 100% { background: transparent; } }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none; position: absolute; inset: 0; z-index: 50; opacity: 0.3;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-xs">

    <header class="h-12 bg-[#121214] border-b border-[#27272a] flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-6">
            <div>
                <h1 class="font-black text-lg tracking-tighter italic text-white flex items-center gap-2">
                    <span class="text-purple-500">BANDAR</span>OS <span class="text-[9px] px-1.5 py-0.5 bg-purple-900/30 text-purple-400 rounded">DEV_BUILD_V9</span>
                </h1>
            </div>
            <div class="h-6 w-px bg-[#27272a]"></div>
            <div class="flex flex-col">
                <span class="font-bold text-gray-400 text-[10px] tracking-widest">EMITEN</span>
                <span class="font-bold text-base text-yellow-500 tracking-tight">GORENGAN.JK</span>
            </div>
            <div class="flex flex-col">
                <span class="font-bold text-gray-400 text-[10px]">LAST PRICE</span>
                <span id="header-price" class="font-black text-lg mono text-white">200</span>
            </div>
            <div class="flex flex-col">
                <span class="font-bold text-gray-400 text-[10px]">% CHG</span>
                <span id="header-chg" class="font-bold mono text-white">0.00%</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="text-right">
                <div class="text-[10px] text-gray-500 font-bold">TOTAL INVENTORY (LOT)</div>
                <div id="mm-inventory" class="text-purple-400 font-black mono text-base">0</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-500 font-bold">AVG PRICE</div>
                <div id="mm-avg" class="text-white font-bold mono">0</div>
            </div>
            <div class="h-8 w-px bg-[#27272a]"></div>
            <div class="flex items-center gap-2 px-3 py-1 bg-purple-900/20 border border-purple-500/30 rounded">
                <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                <span class="font-bold text-purple-400">MM ACTIVE</span>
            </div>
        </div>
    </header>

    <main class="flex-1 grid grid-cols-[300px_1fr_320px] overflow-hidden bg-[#09090b]">
        
        <aside class="border-r border-[#27272a] flex flex-col bg-[#0c0c0e]">
            <div class="p-3 border-b border-[#27272a] font-bold text-gray-500 uppercase tracking-widest text-[10px]">Manipulation Console</div>
            
            <div class="p-4 flex flex-col gap-6 overflow-y-auto">
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white">Fake Wall (Spoofing)</span>
                        <div class="w-2 h-2 rounded-full bg-gray-600" id="ind-fake"></div>
                    </div>
                    <p class="text-[10px] text-gray-500 leading-tight">Menciptakan tembok Offer 500k lot. Otomatis hilang jika harga mendekat 1 tick.</p>
                    <button onclick="Bandar.toggleFakeWall()" id="btn-fake" class="w-full py-2 bg-[#27272a] hover:bg-red-900/30 text-gray-300 font-bold border border-gray-600 hover:border-red-500 hover:text-red-400 rounded transition-all text-[11px]">
                        ACTIVATE FAKE OFFER
                    </button>
                </div>

                <div class="h-px bg-[#27272a]"></div>

                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white">Ghost Bid (Iceberg)</span>
                        <div class="w-2 h-2 rounded-full bg-gray-600" id="ind-ghost"></div>
                    </div>
                    <p class="text-[10px] text-gray-500 leading-tight">Menahan harga di Best Bid. Bid terlihat tipis, tapi refill otomatis saat dihajar kiri.</p>
                    <button onclick="Bandar.toggleGhostBid()" id="btn-ghost" class="w-full py-2 bg-[#27272a] hover:bg-green-900/30 text-gray-300 font-bold border border-gray-600 hover:border-green-500 hover:text-green-400 rounded transition-all text-[11px]">
                        ACTIVATE GHOST BID
                    </button>
                </div>

                <div class="h-px bg-[#27272a]"></div>

                <div class="space-y-3">
                    <span class="font-bold text-white">Aggressive Sweep</span>
                    <div class="grid grid-cols-2 gap-2">
                        <button onmousedown="Bandar.hajarKanan()" class="py-4 bg-green-600 hover:bg-green-500 text-black font-black text-sm rounded shadow-[0_0_15px_rgba(34,197,94,0.4)] active:scale-95 transition-transform">
                            HAKA
                            <span class="block text-[9px] font-normal opacity-70">EAT OFFER</span>
                        </button>
                        <button onmousedown="Bandar.hajarKiri()" class="py-4 bg-red-600 hover:bg-red-500 text-white font-black text-sm rounded shadow-[0_0_15px_rgba(239,68,68,0.4)] active:scale-95 transition-transform">
                            HKI
                            <span class="block text-[9px] font-normal opacity-70">DUMP BID</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-2 mt-auto">
                    <span class="font-bold text-gray-500 uppercase text-[10px]">Tape Painting</span>
                    <button onclick="Bandar.spamTrade()" class="w-full py-1.5 bg-[#1a1a1d] border border-gray-700 text-gray-400 hover:text-white rounded text-[10px] font-mono">
                        GENERATE FAKE NOISE (CHURNING)
                    </button>
                </div>

            </div>
        </aside>

        <div class="flex flex-col min-w-0 bg-[#09090b] relative">
            <div class="scanlines"></div>
            
            <div class="flex-1 relative border-b border-[#27272a]">
                <canvas id="chart-canvas" class="w-full h-full block"></canvas>
                <div class="absolute top-4 left-4 pointer-events-none opacity-50">
                    <div class="text-[10px] text-gray-500 font-bold">BANDAR ACCUMULATION MAP</div>
                    <div id="status-display" class="text-xs font-mono text-purple-400">STATUS: OBSERVING</div>
                </div>
            </div>

            <div class="h-1/3 flex flex-col bg-[#0c0c0e]">
                <div class="flex justify-between px-3 py-1.5 border-b border-[#27272a] bg-[#121214] text-[10px] font-bold text-gray-500">
                    <div class="flex gap-4">
                        <span class="w-12">TIME</span>
                        <span class="w-16">PRICE</span>
                        <span class="w-16">CHANGE</span>
                    </div>
                    <div class="flex gap-4 pr-4">
                        <span class="w-10 text-center">BUYER</span>
                        <span class="w-10 text-center">SELLER</span>
                        <span class="w-12 text-right">LOT</span>
                    </div>
                </div>
                <div id="tape-container" class="flex-1 overflow-y-auto font-mono text-[11px] relative">
                    </div>
            </div>
        </div>

        <aside class="border-l border-[#27272a] bg-[#0c0c0e] flex flex-col">
            <div class="p-2 bg-[#121214] border-b border-[#27272a] text-center font-bold text-gray-400 text-[10px]">
                DEPTH OF MARKET (ORDERBOOK)
            </div>
            
            <div class="flex-1 flex flex-col overflow-hidden relative">
                <div class="grid grid-cols-4 text-[9px] font-bold text-gray-500 px-1 py-1 border-b border-[#27272a]">
                    <div class="text-left">BID VOL</div>
                    <div class="text-center">BID</div>
                    <div class="text-center">OFFER</div>
                    <div class="text-right">OFF VOL</div>
                </div>

                <div id="ob-asks" class="flex-1 flex flex-col-reverse justify-end overflow-hidden pb-1"></div>
                
                <div class="h-8 bg-[#18181b] border-y border-[#27272a] flex items-center justify-center gap-3 shrink-0 z-10">
                    <span id="spread-val" class="text-xs font-bold text-gray-500">SPREAD: 1</span>
                </div>

                <div id="ob-bids" class="flex-1 flex flex-col justify-start overflow-hidden pt-1"></div>
            </div>

            <div class="h-40 border-t border-[#27272a] flex flex-col bg-[#09090b]">
                <div class="px-2 py-1 bg-[#121214] text-[9px] font-bold text-gray-500 flex justify-between">
                    <span>TOP BUYER</span>
                    <span>TOP SELLER</span>
                </div>
                <div class="flex-1 grid grid-cols-2 text-[10px] mono">
                    <div id="top-buyers" class="p-2 border-r border-[#27272a]"></div>
                    <div id="top-sellers" class="p-2"></div>
                </div>
            </div>
        </aside>

    </main>

    <script>
        // --- CONFIG & UTILS ---
        const BROKERS = {
            RETAIL: ['YP', 'PD', 'NI', 'KK', 'XC', 'XL'],
            BANDAR: ['BK', 'AK', 'CC', 'MG', 'KZ', 'ZP']
        };
        
        const formatNum = (n) => n.toLocaleString('id-ID');
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const getBroker = (type) => pick(type === 'BANDAR' ? BROKERS.BANDAR : BROKERS.RETAIL);

        // --- ENGINE ---
        const Engine = {
            price: 200,
            prevPrice: 200,
            tickSize: 1, // Fraksi harga < 200 = 1, >= 200 = 2, simplified to 1 for generic logic unless handled
            bids: [], // {price, vol, isFake, isGhost}
            asks: [],
            trades: [],
            candles: [],
            
            // Bandar State
            bandarInv: 0,
            bandarAvg: 0,
            
            // Features
            fakeWallActive: false,
            fakeWallSide: 'ASK', // or BID
            fakeWallPrice: 0,
            
            ghostBidActive: false,
            ghostBidPrice: 0,
            
            init() {
                // Initialize Orderbook around price
                this.generateOrderbook(this.price);
                this.startLoop();
                UI.renderChart(); // Start canvas loop
            },

            generateOrderbook(centerPrice) {
                this.bids = [];
                this.asks = [];
                for (let i = 1; i <= 10; i++) {
                    const pBid = centerPrice - i;
                    const pAsk = centerPrice + i;
                    // Volume retail random kecil
                    this.bids.push({ p: pBid, v: rand(500, 5000), type: 'NORMAL' });
                    this.asks.push({ p: pAsk, v: rand(500, 5000), type: 'NORMAL' });
                }
            },

            getTickSize(price) {
                if(price < 200) return 1;
                if(price < 500) return 2;
                if(price < 2000) return 5;
                return 10;
            },

            // Core Logic Loop
            tick() {
                // 1. Check Ghost Bid (Refill)
                if (this.ghostBidActive) {
                    const ghostLevel = this.bids.find(b => b.p === this.ghostBidPrice);
                    if (ghostLevel) {
                        // Jika volume turun di bawah 1000 lot, refill jadi 5000 (tapi terlihat kecil di UI)
                        if (ghostLevel.v < 1000) {
                            ghostLevel.v += rand(3000, 5000);
                            UI.flashRow(this.ghostBidPrice, 'bg-green-500'); // Visual cue
                        }
                        // Visual trick: Di UI nanti kita render volume ini seolah-olah kecil
                    } else if (this.price > this.ghostBidPrice) {
                        // Jika harga naik, pindahkan ghost bid naik pelan2 (Trailing)
                         // Logic omitted for simplicity
                    }
                }

                // 2. Check Fake Wall (Spoofing)
                if (this.fakeWallActive) {
                    // Cek jarak harga. Jika harga mendekat ke fake wall, cabut wallnya.
                    const gap = Math.abs(this.fakeWallPrice - this.price);
                    const wallRow = this.asks.find(a => a.p === this.fakeWallPrice);
                    
                    if (gap <= 2 && wallRow && wallRow.type === 'FAKE') {
                        // Cabut Wall!
                        wallRow.v = rand(100, 500); // Kembali normal
                        wallRow.type = 'NORMAL';
                        UI.toast("FAKE WALL REMOVED (SPOOFING DETECTED)", "text-red-500");
                        this.fakeWallActive = false;
                        UI.updateControls();
                    }
                }
                
                // 3. Random Noise Trade
                if(Math.random() > 0.7) {
                    const side = Math.random() > 0.5 ? 'BUY' : 'SELL';
                    const qty = rand(1, 100);
                    this.executeTrade(this.price, qty, side, 'RETAIL');
                }

                UI.renderOB();
            },

            executeTrade(price, qty, side, actor) {
                // Update Tape
                const time = new Date().toLocaleTimeString('id-ID', { hour12: false });
                const buyer = side === 'BUY' ? (actor === 'BANDAR' ? getBroker('BANDAR') : getBroker('RETAIL')) : getBroker(Math.random() > 0.8 ? 'BANDAR' : 'RETAIL');
                const seller = side === 'SELL' ? (actor === 'BANDAR' ? getBroker('BANDAR') : getBroker('RETAIL')) : getBroker(Math.random() > 0.8 ? 'BANDAR' : 'RETAIL');
                
                const change = price - this.prevPrice;
                
                this.trades.unshift({ time, price, change, buyer, seller, qty, side });
                if (this.trades.length > 50) this.trades.pop();

                // Impact to Price & Orderbook
                if (side === 'BUY') {
                    // Makan Offer
                    let remaining = qty;
                    while (remaining > 0 && this.asks.length > 0) {
                        if (this.asks[0].v > remaining) {
                            this.asks[0].v -= remaining;
                            remaining = 0;
                        } else {
                            remaining -= this.asks[0].v;
                            this.asks.shift(); // Offer habis
                            // Harga naik
                            this.prevPrice = this.price;
                            this.price += this.getTickSize(this.price);
                            this.adjustOrderbookNewLevel();
                        }
                    }
                } else {
                    // Buang Kiri (Hit Bid)
                    let remaining = qty;
                    while (remaining > 0 && this.bids.length > 0) {
                         // GHOST BID LOGIC PROTECTION
                        if (this.ghostBidActive && this.bids[0].p === this.ghostBidPrice) {
                            // Tidak bisa jebol
                            remaining = 0; 
                            // Tapi volume bid berkurang visualnya, nanti di refill di tick()
                            this.bids[0].v -= Math.min(qty, this.bids[0].v - 1); // Sisain 1
                            break;
                        }

                        if (this.bids[0].v > remaining) {
                            this.bids[0].v -= remaining;
                            remaining = 0;
                        } else {
                            remaining -= this.bids[0].v;
                            this.bids.shift(); // Bid jebol
                            // Harga turun
                            this.prevPrice = this.price;
                            this.price -= this.getTickSize(this.price);
                            this.adjustOrderbookNewLevel();
                        }
                    }
                }
                
                // Update Inventory Bandar
                if (actor === 'BANDAR') {
                    if (side === 'BUY') {
                        const totalVal = (this.bandarInv * this.bandarAvg) + (qty * price);
                        this.bandarInv += qty;
                        this.bandarAvg = Math.floor(totalVal / this.bandarInv);
                    } else {
                        this.bandarInv -= qty;
                    }
                    UI.updateBandarInfo();
                }

                // Push Candle Data (Simplified)
                Chart.pushData(this.price);
                
                UI.renderTape();
                UI.renderHeader();
            },

            adjustOrderbookNewLevel() {
                // Kalau harga geser, generate level baru biar tidak kosong
                const tick = this.getTickSize(this.price);
                
                // Ensure Asks exist above price
                const highestAsk = this.asks.length > 0 ? this.asks[this.asks.length-1].p : this.price;
                while(this.asks.length < 10) {
                    this.asks.push({ p: highestAsk + (this.asks.length+1)*tick, v: rand(500, 5000), type: 'NORMAL' });
                }
                
                // Ensure Bids exist below price
                const lowestBid = this.bids.length > 0 ? this.bids[this.bids.length-1].p : this.price;
                while(this.bids.length < 10) {
                    this.bids.push({ p: lowestBid - (this.bids.length+1)*tick, v: rand(500, 5000), type: 'NORMAL' });
                }
            },

            startLoop() {
                setInterval(() => this.tick(), 500); // Game Loop speed
            }
        };

        // --- BANDAR ACTIONS ---
        const Bandar = {
            toggleFakeWall() {
                if (Engine.fakeWallActive) {
                    Engine.fakeWallActive = false;
                    // Reset fake rows
                    Engine.asks.forEach(a => { if(a.type === 'FAKE') { a.v = rand(100,1000); a.type = 'NORMAL'; }});
                } else {
                    Engine.fakeWallActive = true;
                    Engine.fakeWallSide = 'ASK';
                    // Pasang di 3 tick di atas
                    if(Engine.asks.length > 3) {
                        const target = Engine.asks[2];
                        target.v = 500000; // 500k Lot
                        target.type = 'FAKE';
                        Engine.fakeWallPrice = target.p;
                    }
                }
                UI.updateControls();
                UI.renderOB();
            },

            toggleGhostBid() {
                if(Engine.ghostBidActive) {
                    Engine.ghostBidActive = false;
                } else {
                    Engine.ghostBidActive = true;
                    // Kunci di best bid saat ini
                    if(Engine.bids.length > 0) {
                        Engine.ghostBidPrice = Engine.bids[0].p;
                        Engine.bids[0].type = 'GHOST';
                        // Set volume terlihat "lemah" untuk memancing seller
                        Engine.bids[0].v = 150; 
                    }
                }
                UI.updateControls();
                UI.renderOB();
            },

            hajarKanan() {
                // Beli masif
                Engine.executeTrade(Engine.asks[0].p, 15000, 'BUY', 'BANDAR');
            },

            hajarKiri() {
                // Jual masif
                Engine.executeTrade(Engine.bids[0].p, 15000, 'SELL', 'BANDAR');
            },

            spamTrade() {
                // Generate fake noise tape (Churning)
                for(let i=0; i<10; i++) {
                    setTimeout(() => {
                        Engine.executeTrade(Engine.price, rand(10, 50), Math.random()>0.5?'BUY':'SELL', 'BANDAR');
                    }, i * 100);
                }
            }
        };

        // --- UI ---
        const UI = {
            renderHeader() {
                const elP = document.getElementById('header-price');
                const elC = document.getElementById('header-chg');
                const diff = Engine.price - 200; // Base reference
                const pct = (diff / 200) * 100;
                
                elP.innerText = Engine.price;
                elP.className = `font-black text-lg mono ${diff > 0 ? 'text-up' : diff < 0 ? 'text-down' : 'text-white'}`;
                elC.innerText = pct.toFixed(2) + '%';
                elC.className = `font-bold mono ${diff > 0 ? 'text-up' : diff < 0 ? 'text-down' : 'text-gray-400'}`;
            },

            updateBandarInfo() {
                document.getElementById('mm-inventory').innerText = formatNum(Engine.bandarInv);
                document.getElementById('mm-avg').innerText = Engine.bandarAvg;
            },

            updateControls() {
                const fakeInd = document.getElementById('ind-fake');
                const fakeBtn = document.getElementById('btn-fake');
                if(Engine.fakeWallActive) {
                    fakeInd.className = "w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_red]";
                    fakeBtn.innerText = "DEACTIVATE FAKE OFFER";
                    fakeBtn.className = fakeBtn.className.replace('border-gray-600', 'border-red-500 text-red-400');
                } else {
                    fakeInd.className = "w-2 h-2 rounded-full bg-gray-600";
                    fakeBtn.innerText = "ACTIVATE FAKE OFFER";
                    fakeBtn.className = fakeBtn.className.replace('border-red-500 text-red-400', 'border-gray-600 text-gray-300');
                }

                const ghostInd = document.getElementById('ind-ghost');
                const ghostBtn = document.getElementById('btn-ghost');
                if(Engine.ghostBidActive) {
                    ghostInd.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_green]";
                    ghostBtn.innerText = "DEACTIVATE GHOST BID";
                } else {
                    ghostInd.className = "w-2 h-2 rounded-full bg-gray-600";
                    ghostBtn.innerText = "ACTIVATE GHOST BID";
                }
            },

            renderOB() {
                // BIDS
                const bidEl = document.getElementById('ob-bids');
                bidEl.innerHTML = '';
                Engine.bids.forEach(b => {
                    const isGhost = Engine.ghostBidActive && b.p === Engine.ghostBidPrice;
                    // Kalau Ghost, kita tampilkan volume palsu (kecil) di UI, padahal aslinya besar
                    const displayVol = isGhost ? rand(50, 300) : b.v; 
                    const barW = Math.min((displayVol / 10000) * 100, 100);
                    
                    const row = document.createElement('div');
                    row.className = `grid grid-cols-4 px-1 py-0.5 text-[11px] font-mono border-b border-[#1c1c1f] relative group hover:bg-[#1c1c1f] cursor-crosshair ${isGhost ? 'bg-green-900/20' : ''}`;
                    row.innerHTML = `
                        <div class="text-left font-bold text-gray-300 z-10">${formatNum(displayVol)}</div>
                        <div class="text-center font-bold text-up z-10">${b.p}</div>
                        <div class="text-center text-gray-600 z-10">-</div>
                        <div class="text-right text-gray-600 z-10">-</div>
                        <div class="absolute top-0 bottom-0 left-0 bg-up-dim transition-all duration-300" style="width: ${barW}%"></div>
                        ${isGhost ? '<div class="absolute left-0 w-0.5 h-full bg-green-400 animate-pulse"></div>' : ''}
                    `;
                    bidEl.appendChild(row);
                });

                // ASKS
                const askEl = document.getElementById('ob-asks');
                askEl.innerHTML = '';
                // Reverse iterate for Asks
                [...Engine.asks].reverse().forEach(a => {
                    const isFake = a.type === 'FAKE';
                    const barW = Math.min((a.v / 10000) * 100, 100);
                    
                    const row = document.createElement('div');
                    row.className = `grid grid-cols-4 px-1 py-0.5 text-[11px] font-mono border-b border-[#1c1c1f] relative group hover:bg-[#1c1c1f] cursor-crosshair ${isFake ? 'bg-red-900/20' : ''}`;
                    row.innerHTML = `
                        <div class="text-left text-gray-600 z-10">-</div>
                        <div class="text-center text-gray-600 z-10">-</div>
                        <div class="text-center font-bold text-down z-10">${a.p}</div>
                        <div class="text-right font-bold text-gray-300 z-10">${formatNum(a.v)}</div>
                        <div class="absolute top-0 bottom-0 right-0 bg-down-dim transition-all duration-300" style="width: ${barW}%"></div>
                        ${isFake ? '<div class="absolute right-0 w-0.5 h-full bg-red-500 animate-pulse"></div>' : ''}
                    `;
                    askEl.appendChild(row);
                });
            },

            renderTape() {
                const c = document.getElementById('tape-container');
                let h = '';
                Engine.trades.forEach(t => {
                    const color = t.side === 'BUY' ? 'text-up' : 'text-down';
                    // Highlight Bandar
                    const buyerClass = BROKERS.BANDAR.includes(t.buyer) ? 'text-purple-400 font-black' : 'text-gray-400';
                    const sellerClass = BROKERS.BANDAR.includes(t.seller) ? 'text-purple-400 font-black' : 'text-gray-400';

                    h += `
                    <div class="flex justify-between px-3 py-0.5 border-b border-[#1c1c1f] hover:bg-[#1c1c1f]">
                        <div class="flex gap-4">
                            <span class="w-12 text-gray-600">${t.time}</span>
                            <span class="w-16 ${color} font-bold">${t.price}</span>
                            <span class="w-16 ${t.change > 0 ? 'text-up': t.change < 0 ? 'text-down': 'text-gray-500'}">${t.change > 0 ? '+' : ''}${t.change}</span>
                        </div>
                        <div class="flex gap-4 pr-4">
                            <span class="w-10 text-center ${buyerClass}">${t.buyer}</span>
                            <span class="w-10 text-center ${sellerClass}">${t.seller}</span>
                            <span class="w-12 text-right font-bold text-gray-300">${formatNum(t.qty)}</span>
                        </div>
                    </div>`;
                });
                c.innerHTML = h;
            },

            flashRow(price, bgClass) {
                // Simplified visual cue helper
            },
            
            toast(msg, color) {
                const d = document.getElementById('status-display');
                d.innerText = msg;
                d.className = `text-xs font-mono font-bold ${color} animate-pulse`;
                setTimeout(() => {
                    d.innerText = "STATUS: MONITORING";
                    d.className = "text-xs font-mono text-purple-400";
                }, 2000);
            },

            renderChart() {
                requestAnimationFrame(Chart.draw);
            }
        };

        // --- CHARTING (CANVAS) ---
        const Chart = {
            data: Array(200).fill(200),
            canvas: document.getElementById('chart-canvas'),
            ctx: document.getElementById('chart-canvas').getContext('2d'),
            
            pushData(price) {
                this.data.push(price);
                if(this.data.length > 300) this.data.shift();
            },
            
            draw() {
                const ctx = Chart.ctx;
                const canvas = Chart.canvas;
                
                // Resize
                if (canvas.width !== canvas.parentElement.clientWidth) {
                    canvas.width = canvas.parentElement.clientWidth;
                    canvas.height = canvas.parentElement.clientHeight;
                }
                const w = canvas.width;
                const h = canvas.height;

                // Clear
                ctx.fillStyle = '#09090b';
                ctx.fillRect(0,0,w,h);

                // Grid
                ctx.strokeStyle = '#18181b'; ctx.lineWidth = 1;
                ctx.beginPath();
                for(let i=0; i<w; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,h); }
                for(let i=0; i<h; i+=50) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
                ctx.stroke();

                // Line
                const min = Math.min(...Chart.data) - 5;
                const max = Math.max(...Chart.data) + 5;
                const range = max - min;
                
                ctx.beginPath();
                ctx.strokeStyle = '#8b5cf6'; // Bandar Purple
                ctx.lineWidth = 2;
                
                Chart.data.forEach((p, i) => {
                    const x = (i / Chart.data.length) * w;
                    const y = h - ((p - min) / range) * h;
                    if(i===0) ctx.moveTo(x,y);
                    else ctx.lineTo(x,y);
                });
                ctx.stroke();
                
                // Gradient Fill
                ctx.lineTo(w, h);
                ctx.lineTo(0, h);
                const grad = ctx.createLinearGradient(0, 0, 0, h);
                grad.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                grad.addColorStop(1, 'rgba(139, 92, 246, 0)');
                ctx.fillStyle = grad;
                ctx.fill();

                UI.renderChart();
            }
        };

        Engine.init();

    </script>
</body>
</html>
