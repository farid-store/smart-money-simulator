<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSTITUTIONAL TERMINAL [MM_ACCESS]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #161A1E; /* Binance Dark */
            --bg-sec: #0B0E11;  /* Deep Dark */
            --border: #2B3139;
            --green: #0ECB81;
            --red: #F6465D;
            --text-main: #EAECEF;
            --text-muted: #848E9C;
            --accent: #F0B90B; /* Binance Yellow */
        }
        
        * { box-sizing: border-box; }
        body { background-color: var(--bg-sec); color: var(--text-main); font-family: 'Roboto', sans-serif; height: 100vh; overflow: hidden; font-size: 12px; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Utility Colors */
        .c-up { color: var(--green); } .c-down { color: var(--red); } .c-warn { color: var(--accent); } .c-muted { color: var(--text-muted); }
        .bg-up { background-color: var(--green); } .bg-down { background-color: var(--red); }
        .border-c { border-color: var(--border); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-sec); }
        ::-webkit-scrollbar-thumb { background: #474D57; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #5E6673; }

        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-rows: 48px 1fr 250px; /* Header, Main, Bottom Panel */
            height: 100vh;
        }
        .main-section {
            display: grid;
            grid-template-columns: 1fr 320px; /* Chart, OrderPanel */
            overflow: hidden;
        }
        
        /* Custom UI Components */
        .tab-btn { @apply px-4 h-full flex items-center text-xs font-bold text-gray-400 cursor-pointer border-t-2 border-transparent hover:text-white transition; }
        .tab-btn.active { @apply text-[#F0B90B] border-[#F0B90B] bg-[#1E2329]; }
        
        .btn-exec { @apply w-full py-3 rounded text-sm font-bold transition active:scale-95 text-white shadow-lg; }
        
        .input-dark { @apply bg-[#2B3139] border border-transparent focus:border-[#F0B90B] text-white px-2 py-1.5 rounded text-right outline-none w-full font-mono transition; }

        /* Table */
        table { w-full text-left border-collapse; }
        th { @apply text-[10px] text-gray-500 font-normal py-2 border-b border-[#2B3139]; }
        td { @apply py-1.5 text-xs border-b border-[#2B3139]/50 font-mono; }
        
        /* Animations */
        @keyframes flash-green { 0% { background: rgba(14, 203, 129, 0.2); } 100% { background: transparent; } }
        @keyframes flash-red { 0% { background: rgba(246, 70, 93, 0.2); } 100% { background: transparent; } }
        .row-flash-up { animation: flash-green 0.5s; }
        .row-flash-down { animation: flash-red 0.5s; }
    </style>
</head>
<body class="grid-container">

    <header class="bg-[#1E2329] border-b border-c flex items-center justify-between px-4">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-[#F0B90B] rounded-sm flex items-center justify-center text-black font-bold">M</div>
                <span class="font-bold text-lg tracking-tight">MARKET<span class="text-[#F0B90B]">MAKER</span> PRO</span>
            </div>
            <div class="h-6 w-px bg-gray-700 mx-2"></div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400">BTC/USDT</span>
                <span id="header-price" class="text-sm font-mono font-bold c-up">98,240.50</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-400">24h Change</span>
                <span class="text-xs font-mono c-up">+2.45%</span>
            </div>
        </div>

        <div class="flex items-center gap-6 text-right">
            <div>
                <span class="text-[10px] text-gray-400 block">Wallet Balance</span>
                <span class="font-mono text-sm font-bold" id="wallet-bal">100,000.00 USDT</span>
            </div>
            <div>
                <span class="text-[10px] text-gray-400 block">Unrealized PnL</span>
                <span class="font-mono text-sm font-bold" id="header-pnl">0.00</span>
            </div>
            <div>
                <span class="text-[10px] text-gray-400 block">Margin Ratio</span>
                <span class="font-mono text-xs bg-gray-700 px-1 rounded text-white" id="margin-ratio">0.00%</span>
            </div>
        </div>
    </header>

    <div class="main-section bg-[#161A1E]">
        
        <div class="relative flex flex-col border-r border-c">
            <div class="h-10 bg-[#161A1E] border-b border-c flex items-center px-4 gap-4">
                <span class="text-xs font-bold text-[#F0B90B] cursor-pointer">Time</span>
                <span class="text-xs text-gray-400 hover:text-white cursor-pointer">1m</span>
                <span class="text-xs text-gray-400 hover:text-white cursor-pointer">5m</span>
                <span class="text-xs text-gray-400 hover:text-white cursor-pointer">15m</span>
                <div class="flex-1"></div>
                <span class="text-xs text-gray-500">TradingView Mode</span>
            </div>
            
            <div class="flex-1 relative bg-[#161A1E]">
                <canvas id="chartCanvas" class="w-full h-full cursor-crosshair"></canvas>
                
                <div class="absolute top-2 left-2 flex gap-4 text-[10px] font-mono pointer-events-none">
                    <span class="text-white">O: <span class="c-muted" id="c-open">0</span></span>
                    <span class="text-white">H: <span class="c-muted" id="c-high">0</span></span>
                    <span class="text-white">L: <span class="c-muted" id="c-low">0</span></span>
                    <span class="text-white">C: <span class="c-muted" id="c-close">0</span></span>
                </div>

                <div id="liq-overlay" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>

        <div class="flex flex-col bg-[#0B0E11]">
            
            <div class="h-[55%] flex flex-col">
                <div class="px-3 py-2 border-b border-c flex justify-between">
                    <span class="text-xs font-bold text-gray-300">Order Book</span>
                    <span class="text-[10px] text-gray-500">0.1</span>
                </div>
                <div class="flex-1 overflow-hidden relative">
                    <div id="book-asks" class="absolute bottom-0 w-full flex flex-col-reverse"></div>
                </div>
                <div class="py-2 border-y border-c text-center bg-[#161A1E]">
                    <span id="mid-price" class="text-lg font-mono font-bold c-up">98,240.50</span>
                    <span class="text-[10px] text-gray-500 block">Mark Price</span>
                </div>
                <div class="flex-1 overflow-hidden relative">
                    <div id="book-bids" class="absolute top-0 w-full"></div>
                </div>
            </div>

            <div class="flex-1 p-3 border-t border-c bg-[#1E2329] flex flex-col gap-3">
                
                <div class="flex bg-[#0B0E11] p-1 rounded">
                    <div class="flex-1 text-center py-1 text-xs font-bold bg-[#2B3139] text-white rounded cursor-pointer">Market</div>
                    <div class="flex-1 text-center py-1 text-xs font-bold text-gray-500 cursor-pointer">Limit</div>
                </div>

                <div>
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                        <span>Avail: <span class="text-white" id="avail-bal">100,000 USDT</span></span>
                    </div>
                    <div class="flex items-center bg-[#2B3139] rounded overflow-hidden border border-[#2B3139] focus-within:border-[#F0B90B]">
                        <span class="pl-2 text-xs text-gray-400">Size</span>
                        <input type="number" id="input-qty" value="0.5" class="bg-transparent text-white p-2 text-right w-full outline-none font-mono" step="0.01">
                        <span class="pr-2 text-xs text-gray-400">BTC</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-auto">
                    <button onclick="MM.execute('BUY')" class="btn-exec bg-up hover:brightness-110">
                        Buy / Long
                    </button>
                    <button onclick="MM.execute('SELL')" class="btn-exec bg-down hover:brightness-110">
                        Sell / Short
                    </button>
                </div>

                <div class="pt-2 border-t border-gray-700">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-[#F0B90B]">MM ALGO TOOLS</span>
                        <label class="text-[9px] text-gray-500 flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="spoof-toggle" onchange="ALGO.toggleSpoof()"> Spoofing
                        </label>
                    </div>
                    <button onclick="ALGO.huntLiq()" class="w-full py-1 text-[10px] border border-[#F0B90B] text-[#F0B90B] rounded hover:bg-[#F0B90B] hover:text-black font-bold transition">
                        TRIGGER LIQUIDITY HUNT
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="bg-[#161A1E] border-t border-c flex flex-col">
        <div class="h-10 bg-[#1E2329] border-b border-c flex px-2 gap-2">
            <div class="tab-btn active">Positions <span class="ml-1 text-xs bg-gray-700 px-1 rounded-sm text-white" id="pos-count">0</span></div>
            <div class="tab-btn">Open Orders <span class="ml-1 text-xs text-gray-500">(0)</span></div>
            <div class="tab-btn">Order History</div>
            <div class="tab-btn">Trade History</div>
        </div>
        
        <div class="flex-1 overflow-auto bg-[#161A1E] relative">
            <table class="w-full min-w-[800px]">
                <thead class="sticky top-0 bg-[#161A1E] z-10">
                    <tr>
                        <th class="pl-4">Symbol</th>
                        <th>Size (BTC)</th>
                        <th>Entry Price</th>
                        <th>Mark Price</th>
                        <th>Liq. Price</th>
                        <th>Margin (USDT)</th>
                        <th>PnL (ROE%)</th>
                        <th class="pr-4 text-right">Action</th>
                    </tr>
                </thead>
                <tbody id="position-table-body">
                    <tr id="empty-state">
                        <td colspan="8" class="text-center py-10 text-gray-500 italic text-xs">
                            No Open Positions
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

<script>
/**
 * INSTITUTIONAL TERMINAL CORE
 */
const $ = (id) => document.getElementById(id);

// --- STATE ---
const STATE = {
    price: 98240.50,
    balance: 100000.00,
    leverage: 20, // 20x Leverage
    
    // Position Data
    position: {
        size: 0, // Positive = Long, Negative = Short
        entryPrice: 0,
        margin: 0
    },
    
    // Market Data
    candles: [],
    bids: [], asks: [],
    
    // Config
    tick: 5,
    spoofing: false
};

// --- CHART ENGINE ---
const CHART = {
    canvas: $('chartCanvas'),
    ctx: $('chartCanvas').getContext('2d'),
    
    init() {
        this.resize();
        window.onresize = () => this.resize();
        this.genHistory();
        this.loop();
    },
    
    resize() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
    },
    
    genHistory() {
        let p = STATE.price;
        let t = Date.now();
        STATE.candles = [];
        for(let i=120; i>0; i--) {
            let o = p;
            let c = p + (Math.random()-0.5)*100;
            let h = Math.max(o,c) + Math.random()*50;
            let l = Math.min(o,c) - Math.random()*50;
            STATE.candles.push({t: t-(i*60000), o, h, l, c});
            p = c;
        }
        STATE.price = p;
    },

    updateCandle() {
        let last = STATE.candles[STATE.candles.length-1];
        last.c = STATE.price;
        if(STATE.price > last.h) last.h = STATE.price;
        if(STATE.price < last.l) last.l = STATE.price;
        
        // Header OHLC update
        $('c-open').innerText = last.o.toFixed(1);
        $('c-high').innerText = last.h.toFixed(1);
        $('c-low').innerText = last.l.toFixed(1);
        $('c-close').innerText = last.c.toFixed(1);
        $('c-close').className = last.c >= last.o ? 'c-up' : 'c-down';
    },

    draw() {
        const ctx = this.ctx;
        const w = this.canvas.width, h = this.canvas.height;
        ctx.clearRect(0,0,w,h);
        
        // Data Slice
        const data = STATE.candles.slice(-90);
        let prices = data.map(d=>[d.h,d.l]).flat();
        
        // Add Entry Price to scale if exists
        if(STATE.position.size !== 0) prices.push(STATE.position.entryPrice);
        
        let min = Math.min(...prices) - 100;
        let max = Math.max(...prices) + 100;
        const getY = p => h - ((p-min)/(max-min)) * (h-40) - 20;
        const getX = i => i * (w/90);
        const barW = (w/90) * 0.6;

        // 1. Grid
        ctx.strokeStyle = '#2B3139'; ctx.lineWidth = 0.5;
        ctx.beginPath();
        for(let p=Math.floor(min/200)*200; p<max; p+=200) {
            let y = getY(p); ctx.moveTo(0,y); ctx.lineTo(w,y);
        }
        for(let i=0; i<90; i+=10) {
            let x = getX(i); ctx.moveTo(x,0); ctx.lineTo(x,h);
        }
        ctx.stroke();

        // 2. Candles
        data.forEach((d, i) => {
            let x = getX(i);
            let col = d.c >= d.o ? '#0ECB81' : '#F6465D';
            ctx.fillStyle = col; ctx.strokeStyle = col;
            ctx.beginPath(); ctx.moveTo(x+barW/2, getY(d.h)); ctx.lineTo(x+barW/2, getY(d.l)); ctx.stroke();
            ctx.fillRect(x, getY(Math.max(d.o,d.c)), barW, Math.abs(getY(d.o)-getY(d.c))||1);
        });

        // 3. Current Price Line
        let py = getY(STATE.price);
        ctx.strokeStyle = '#F0B90B'; ctx.setLineDash([2,2]); ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(0,py); ctx.lineTo(w,py); ctx.stroke();
        
        // Price Label on Y-Axis
        ctx.fillStyle = '#F0B90B'; ctx.fillRect(w-60, py-10, 60, 20);
        ctx.fillStyle = '#000'; ctx.font = 'bold 10px JetBrains Mono';
        ctx.fillText(STATE.price.toFixed(1), w-55, py+4);

        // 4. POSITION LINE & PNL (THE PRO FEATURE)
        if(STATE.position.size !== 0) {
            let ey = getY(STATE.position.entryPrice);
            
            // Dashed Line
            ctx.strokeStyle = '#F0B90B'; ctx.setLineDash([6,4]); ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(0,ey); ctx.lineTo(w,ey); ctx.stroke();
            
            // Entry Label (Left)
            ctx.fillStyle = '#F0B90B'; ctx.font = '10px Roboto';
            ctx.fillText(STATE.position.size > 0 ? "BUY AVG" : "SELL AVG", 5, ey-5);
            
            // PnL Connector (Elastic Line)
            let pnl = (STATE.price - STATE.position.entryPrice) * STATE.position.size;
            let pnlColor = pnl >= 0 ? '#0ECB81' : '#F6465D';
            
            // Draw a tag connected to current price
            let tagY = py; // Following current price
            
            ctx.fillStyle = pnlColor;
            ctx.beginPath();
            ctx.roundRect(w-140, tagY-12, 75, 24, 4); // Floating tag
            ctx.fill();
            
            ctx.fillStyle = '#fff'; ctx.font = 'bold 11px JetBrains Mono';
            ctx.fillText(`${pnl>=0?'+':''}${pnl.toFixed(2)}`, w-135, tagY+4);
        }
    },

    loop() {
        requestAnimationFrame(()=>this.loop());
        this.draw();
        this.updateCandle();
    }
};

// --- TRADING LOGIC ---
const MM = {
    init() {
        this.fillBook();
        this.simMarket();
    },

    fillBook() {
        STATE.bids = []; STATE.asks = [];
        for(let i=1; i<15; i++) {
            STATE.asks.push({p: STATE.price + i*STATE.tick, v: Math.random()*2});
            STATE.bids.push({p: STATE.price - i*STATE.tick, v: Math.random()*2});
        }
        this.renderBook();
    },

    renderBook() {
        // Asks (Red, Top)
        let ah = STATE.asks.slice(0,10).reverse().map(a => 
            `<div class="flex justify-between px-2 py-0.5 text-xs hover:bg-[#1E2329] cursor-pointer" onclick="$('input-qty').value=${a.v.toFixed(2)}">
                <span class="c-down font-mono">${a.p.toFixed(1)}</span>
                <span class="text-gray-300 font-mono text-right relative z-10">${a.v.toFixed(3)}</span>
                <div class="absolute right-0 top-0 bottom-0 bg-red-900/20" style="width:${Math.min(a.v*20,100)}%"></div>
            </div>`
        ).join('');
        $('book-asks').innerHTML = ah;

        // Bids (Green, Bottom)
        let bh = STATE.bids.slice(0,10).map(b => 
            `<div class="flex justify-between px-2 py-0.5 text-xs hover:bg-[#1E2329] cursor-pointer" onclick="$('input-qty').value=${b.v.toFixed(2)}">
                <span class="c-up font-mono">${b.p.toFixed(1)}</span>
                <span class="text-gray-300 font-mono text-right relative z-10">${b.v.toFixed(3)}</span>
                <div class="absolute right-0 top-0 bottom-0 bg-green-900/20" style="width:${Math.min(b.v*20,100)}%"></div>
            </div>`
        ).join('');
        $('book-bids').innerHTML = bh;
        
        $('mid-price').innerText = STATE.price.toFixed(1);
        $('mid-price').className = `text-lg font-mono font-bold ${STATE.candles.length && STATE.price >= STATE.candles[STATE.candles.length-1].o ? 'c-up' : 'c-down'}`;
    },

    execute(side) {
        let qty = parseFloat($('input-qty').value);
        if(!qty) return;

        // 1. Calculate Avg Entry
        let pos = STATE.position;
        let cost = qty * STATE.price;
        let newSize, newAvg;

        if (side === 'BUY') {
            if (pos.size >= 0) {
                // Averaging Up/Down (Long)
                let totalVal = (pos.size * pos.entryPrice) + cost;
                newSize = pos.size + qty;
                newAvg = totalVal / newSize;
            } else {
                // Closing Short / Flipping
                if (qty > Math.abs(pos.size)) {
                    // Flip to Long
                    let remain = qty - Math.abs(pos.size);
                    newSize = remain;
                    newAvg = STATE.price;
                } else {
                    // Reduce Short
                    newSize = pos.size + qty;
                    newAvg = pos.entryPrice;
                }
            }
        } else { // SELL
            if (pos.size <= 0) {
                // Averaging Short
                let totalVal = (Math.abs(pos.size) * pos.entryPrice) + cost;
                newSize = pos.size - qty;
                newAvg = totalVal / Math.abs(newSize);
            } else {
                // Closing Long / Flipping
                if (qty > pos.size) {
                    // Flip to Short
                    let remain = qty - pos.size;
                    newSize = -remain;
                    newAvg = STATE.price;
                } else {
                    // Reduce Long
                    newSize = pos.size - qty;
                    newAvg = pos.entryPrice;
                }
            }
        }

        // Update State
        STATE.position.size = newSize;
        STATE.position.entryPrice = newAvg;
        
        // Margin Update (Simulated)
        STATE.position.margin = Math.abs(STATE.position.size * STATE.position.entryPrice) / STATE.leverage;
        STATE.balance -= (cost * 0.0005); // Commission fee

        this.updateTable();
    },
    
    closePosition() {
        if(STATE.position.size === 0) return;
        // Logic to close
        let qty = Math.abs(STATE.position.size);
        let side = STATE.position.size > 0 ? 'SELL' : 'BUY';
        
        // Realize PnL
        let pnl = (STATE.price - STATE.position.entryPrice) * STATE.position.size;
        STATE.balance += pnl;
        
        // Reset
        STATE.position.size = 0;
        STATE.position.entryPrice = 0;
        STATE.position.margin = 0;
        
        this.updateTable();
    },

    updateTable() {
        const tbody = $('position-table-body');
        const pos = STATE.position;

        if (Math.abs(pos.size) < 0.0001) {
            tbody.innerHTML = `<tr id="empty-state"><td colspan="8" class="text-center py-10 text-gray-500 italic text-xs">No Open Positions</td></tr>`;
            $('pos-count').innerText = "0";
            return;
        }

        $('pos-count').innerText = "1";
        
        let pnl = (STATE.price - pos.entryPrice) * pos.size;
        let roe = (pnl / pos.margin) * 100;
        let pnlClass = pnl >= 0 ? 'c-up' : 'c-down';
        
        // Liq Price (Simple approx)
        let liqPrice = pos.size > 0 
            ? pos.entryPrice * (1 - (1/STATE.leverage)) 
            : pos.entryPrice * (1 + (1/STATE.leverage));

        tbody.innerHTML = `
            <tr class="bg-[#1E2329]/50 hover:bg-[#1E2329]">
                <td class="pl-4 font-bold flex items-center gap-2">
                    <div class="w-1 h-8 ${pos.size>0?'bg-green-500':'bg-red-500'}"></div>
                    BTC/USDT <span class="text-[9px] bg-gray-700 px-1 rounded text-gray-300">20x</span>
                </td>
                <td class="${pos.size>0?'c-up':'c-down'} font-bold">${pos.size.toFixed(3)} BTC</td>
                <td>${pos.entryPrice.toFixed(2)}</td>
                <td class="text-gray-300">${STATE.price.toFixed(2)}</td>
                <td class="c-warn font-bold">${liqPrice.toFixed(2)}</td>
                <td>${pos.margin.toFixed(2)}</td>
                <td class="${pnlClass} font-bold">
                    ${pnl.toFixed(2)} USDT<br>
                    <span class="text-[10px]">(${roe.toFixed(2)}%)</span>
                </td>
                <td class="pr-4 text-right">
                    <button onclick="MM.closePosition()" class="border border-c px-2 py-1 rounded text-[10px] hover:bg-gray-700 text-white">Market Close</button>
                </td>
            </tr>
        `;
        
        // Update Headers
        $('wallet-bal').innerText = STATE.balance.toLocaleString('en-US', {minimumFractionDigits: 2}) + " USDT";
        $('header-pnl').innerText = pnl.toFixed(2);
        $('header-pnl').className = `text-sm font-mono font-bold ${pnlClass}`;
    },

    simMarket() {
        setInterval(() => {
            // Random Walk
            let move = (Math.random()-0.5) * 10;
            if(STATE.spoofing) move += (Math.random()*5); // Upward bias if spoofing
            
            STATE.price += move;
            
            this.fillBook();
            this.updateTable(); // Live PnL update
        }, 500);
        
        setInterval(() => {
            // New Candle every min (simulated fast)
            let last = STATE.candles[STATE.candles.length-1];
            if(Date.now() - last.t > 3000) { // New candle every 3s for demo
                 STATE.candles.push({t: Date.now(), o:STATE.price, h:STATE.price, l:STATE.price, c:STATE.price});
                 STATE.candles.shift();
            }
        }, 3000);
    }
};

const ALGO = {
    toggleSpoof() {
        STATE.spoofing = $('spoof-toggle').checked;
    },
    huntLiq() {
        // Fast dump then pump
        let startP = STATE.price;
        let i = 0;
        let iv = setInterval(() => {
            STATE.price -= 20; // Crash
            i++;
            if(i>10) {
                clearInterval(iv);
                setTimeout(() => { STATE.price = startP + 50; }, 500); // V-Shape Recovery
            }
        }, 50);
    }
};

window.onload = () => { CHART.init(); MM.init(); };

</script>
</body>
</html>
