<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE BANDAR - Market Maker Simulator</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --green: #00f0b5; /* Stockbit Green-ish */
            --red: #ff3b30;
            --bandar: #9d4edd; /* Warna Ungu untuk Smart Money */
            --border: #333;
            --font-mono: 'Consolas', 'Monaco', monospace;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: var(--font-sans); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        header {
            height: 60px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .ticker { font-weight: bold; font-size: 1.2rem; letter-spacing: 1px; }
        .ticker span { color: var(--bandar); font-size: 0.8rem; background: rgba(157, 78, 221, 0.2); padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        
        .stats-bar { display: flex; gap: 20px; font-family: var(--font-mono); font-size: 0.9rem; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 0.7rem; color: var(--text-sub); }
        .val-cash { color: var(--green); }
        .val-stock { color: var(--text-main); }
        .val-pnl { font-weight: bold; }

        /* MAIN LAYOUT */
        .main-container { flex: 1; display: grid; grid-template-columns: 250px 1fr 300px; height: calc(100vh - 60px); }
        
        /* COLUMN 1: ORDERBOOK (DOM) */
        .col-left { border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-panel); }
        .panel-header { padding: 10px; font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid var(--border); color: var(--text-sub); text-transform: uppercase; }
        
        .orderbook { flex: 1; overflow-y: hidden; font-family: var(--font-mono); font-size: 0.85rem; position: relative; }
        .ob-row { display: flex; justify-content: space-between; padding: 2px 10px; cursor: pointer; }
        .ob-row:hover { background: #2a2a2a; }
        .ob-price { font-weight: bold; }
        .ob-vol { color: var(--text-sub); }
        
        .ask-side .ob-price { color: var(--red); }
        .bid-side .ob-price { color: var(--green); }
        .current-price-marker { background: #333; text-align: center; padding: 5px; font-weight: bold; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }

        /* Ganjalan Visual */
        .bandar-vol { color: var(--bandar) !important; font-weight: bold; text-shadow: 0 0 5px rgba(157, 78, 221, 0.5); }

        /* COLUMN 2: CHART & TOOLS */
        .col-center { display: flex; flex-direction: column; background: var(--bg-dark); }
        .chart-area { flex: 1; position: relative; border-bottom: 1px solid var(--border); }
        #chartCanvas { width: 100%; height: 100%; display: block; }
        
        .bandar-controls { height: 160px; padding: 15px; background: var(--bg-panel); display: flex; gap: 15px; align-items: center; justify-content: center; }
        
        .control-group { display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .control-label { font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        
        .btn {
            border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; color: #fff;
            transition: all 0.1s; font-size: 0.9rem; min-width: 120px;
        }
        .btn:active { transform: scale(0.95); }
        
        .btn-accumulate { background: linear-gradient(to bottom, #2c3e50, #1a252f); border: 1px solid #34495e; } /* Silent buy */
        .btn-pump { background: linear-gradient(to bottom, #27ae60, #2ecc71); box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
        .btn-dump { background: linear-gradient(to bottom, #c0392b, #e74c3c); box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
        .btn-hold { background: linear-gradient(to bottom, #8e44ad, #9b59b6); border: 1px solid #8e44ad; } /* Paint fake wall */

        .desc-text { font-size: 0.7rem; color: var(--text-sub); margin-top: 4px; max-width: 120px; text-align: center; }

        /* COLUMN 3: STREAM & SENTIMENT */
        .col-right { border-left: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-panel); }
        
        .sentiment-meter { padding: 15px; border-bottom: 1px solid var(--border); text-align: center; }
        .meter-label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; }
        .meter-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .meter-fill { height: 100%; width: 50%; transition: width 0.5s ease, background-color 0.5s; }
        .sentiment-text { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }

        .stream-feed { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .stream-msg { font-size: 0.85rem; padding-bottom: 8px; border-bottom: 1px solid #333; animation: fadeIn 0.3s ease; }
        .user-name { font-weight: bold; font-size: 0.8rem; margin-right: 5px; }
        .user-bull { color: var(--green); }
        .user-bear { color: var(--red); }
        .user-neutral { color: var(--text-sub); }
        .msg-content { color: var(--text-main); word-wrap: break-word; }
        .time-stamp { font-size: 0.7rem; color: var(--text-sub); float: right; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* Overlay Notification */
        .toast {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(157, 78, 221, 0.9); color: white; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 100; font-family: var(--font-mono);
        }
    </style>
</head>
<body>

<header>
    <div class="ticker">GORENG <span>BANDAR MODE</span></div>
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">CASH (Buying Power)</span>
            <span class="val-cash" id="cashDisplay">Rp 100.000.000.000</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">INVENTORY (Lot)</span>
            <span class="val-stock" id="inventoryDisplay">0 Lot</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">UNREALIZED P/L</span>
            <span class="val-pnl" id="pnlDisplay">0%</span>
        </div>
    </div>
</header>

<div class="main-container">
    <div class="col-left">
        <div class="panel-header">Order Book (Simulated)</div>
        <div class="orderbook" id="orderbookContainer">
            </div>
    </div>

    <div class="col-center">
        <div class="chart-area">
            <canvas id="chartCanvas"></canvas>
            <div id="toast" class="toast">BANDAR ACTION!</div>
        </div>
        <div class="bandar-controls">
            
            <div class="control-group">
                <div class="control-label">Fase 1: Akumulasi</div>
                <button class="btn btn-accumulate" onclick="bandarAction('accumulate')">SEROK BAWAH</button>
                <div class="desc-text">Beli diam-diam tanpa menaikkan harga drastis.</div>
            </div>

            <div class="control-group">
                <div class="control-label">Fase 2: Mark Up</div>
                <button class="btn btn-pump" onclick="bandarAction('pump')">HAKA (PUMP)</button>
                <div class="desc-text">Makan kanan agresif. Trigger FOMO ritel.</div>
            </div>

            <div class="control-group">
                <div class="control-label">Fase 3: Distribusi</div>
                <button class="btn btn-hold" onclick="bandarAction('fakeWall')">PASANG TEMBOK</button>
                <div class="desc-text">Ganjal Bid tebal untuk jualan di pucuk.</div>
            </div>

            <div class="control-group">
                <div class="control-label">Fase 4: Mark Down</div>
                <button class="btn btn-dump" onclick="bandarAction('dump')">GUYUR (DUMP)</button>
                <div class="desc-text">Banting harga (HAKI). Trigger Panic Selling.</div>
            </div>

        </div>
    </div>

    <div class="col-right">
        <div class="panel-header">Retail Sentiment Radar</div>
        <div class="sentiment-meter">
            <div class="meter-label">Fear vs Greed</div>
            <div class="meter-bar-bg">
                <div class="meter-fill" id="sentimentBar" style="width: 50%; background-color: yellow;"></div>
            </div>
            <div class="sentiment-text" id="sentimentText">NEUTRAL</div>
        </div>
        <div class="panel-header">Stockbit Stream (Retail)</div>
        <div class="stream-feed" id="streamFeed">
            </div>
    </div>
</div>

<script>
    // --- STATE VARIABLES ---
    const CONFIG = {
        startPrice: 200,
        initialCash: 100000000000, // 100 Miliar
        tickSize: 2, // Fraksi harga
        chartInterval: 50 // Kecepatan update chart (ms)
    };

    let state = {
        price: CONFIG.startPrice,
        cash: CONFIG.initialCash,
        inventory: 0, // Dalam Lot
        avgPrice: 0,
        sentiment: 50, // 0 (Extreme Fear) - 100 (Extreme Greed)
        candles: [], // Array of {open, high, low, close}
        currentCandle: null,
        tickCount: 0
    };

    // Data generator untuk nama user stream
    const users = ["CuanHunter", "SangKutia", "InvestorMuda", "NyangkutClub", "HakaTerus", "ScalperSakti", "RetailKecil", "ToTheMoon", "BoncosMan", "SultanSaham"];
    
    // Kamus Chat berdasarkan Sentimen
    const chatTemplates = {
        bullish: [
            "Terbang gaaays! ðŸš€", "HAKA! Jangan kasih kendor!", "Bandar lagi baik nih.", "Menuju 1000!", "Indikator MACD Golden Cross, sikat!", "Yang jual bego wkwk", "Hold keras!", "Arahkan!"
        ],
        bearish: [
            "Waduh longsor ðŸ˜­", "Bandar kejam bgt!", "Cutloss gak ya?", "Jemuran nyangkut di pucuk...", "Tolong ARB!", "Fake breakout nih ati2.", "Kabooorrr!", "Uang susu anak ilang :("
        ],
        neutral: [
            "Sideways mulu bosen.", "Nunggu breakout aja.", "Pantau dulu gan.", "Ada news apa nih?", "Sepi amat.", "Kopi mana kopi â˜•"
        ]
    };

    // --- INITIALIZATION ---
    function init() {
        // Init Chart
        for(let i=0; i<50; i++) {
            state.candles.push({ open: 200, close: 200, high: 200, low: 200 });
        }
        startNewCandle();
        
        // Loops
        setInterval(marketTick, 500); // Gerakan pasar natural
        setInterval(retailLogic, 2000); // Logika reaksi ritel
        setInterval(renderOrderBook, 300); // Render visual
        
        updateUI();
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        addStreamChat("System", "Market Open! Happy Trading.", "neutral");
    }

    // --- CORE LOGIC: THE MARKET ---

    // 1. Gerakan Harga Natural & Reaksi
    function marketTick() {
        let change = 0;
        
        // Random noise based on sentiment
        let sentimentBias = (state.sentiment - 50) / 100; // -0.5 to 0.5
        let randomMove = (Math.random() - 0.5) + (sentimentBias * 0.2); // Sentiment affects price direction slightly

        if(randomMove > 0.3) change = CONFIG.tickSize;
        if(randomMove < -0.3) change = -CONFIG.tickSize;

        updatePrice(change);
        renderChart();
    }

    function updatePrice(change) {
        if(change === 0) return;
        
        state.price += change;
        if(state.price < 50) state.price = 50; // Mentok 50

        // Update Candle
        state.currentCandle.close = state.price;
        if(state.price > state.currentCandle.high) state.currentCandle.high = state.price;
        if(state.price < state.currentCandle.low) state.currentCandle.low = state.price;

        state.tickCount++;
        if(state.tickCount > 20) { // New candle every 20 ticks
            state.candles.push({...state.currentCandle});
            if(state.candles.length > 60) state.candles.shift(); // Keep array small
            startNewCandle();
        }
    }

    function startNewCandle() {
        state.tickCount = 0;
        state.currentCandle = {
            open: state.price,
            close: state.price,
            high: state.price,
            low: state.price
        };
    }

    // 2. Logika Sentimen & Ritel
    function retailLogic() {
        // Sentimen berubah berdasarkan tren candle terakhir
        let lastCandle = state.candles[state.candles.length-1];
        let trend = lastCandle.close - lastCandle.open;

        if (trend > 0) state.sentiment += 2;
        else if (trend < 0) state.sentiment -= 2;

        // Decay to neutral
        if(state.sentiment > 50) state.sentiment -= 0.5;
        if(state.sentiment < 50) state.sentiment += 0.5;

        // Clamp
        state.sentiment = Math.max(0, Math.min(100, state.sentiment));

        updateSentimentMeter();
        
        // Generate Chat
        if(Math.random() > 0.6) {
            generateRetailChat();
        }
    }

    // --- BANDAR ACTIONS (USER INPUT) ---

    window.bandarAction = function(type) {
        let impact = 0;
        let cost = 0;
        let lots = 0;
        let msg = "";

        // Logic sederhana: Beli = Harga Naik, Jual = Harga Turun
        switch(type) {
            case 'accumulate': 
                // Beli perlahan, harga tidak naik banyak, sentiment stabil
                lots = 5000;
                cost = lots * 100 * state.price;
                if(state.cash >= cost) {
                    state.cash -= cost;
                    updateInventory(lots, state.price);
                    impact = CONFIG.tickSize; // Naik dikit
                    msg = "SEROK HALUS...";
                }
                break;
            
            case 'pump':
                // HAKA Agresif, harga terbang, sentiment naik drastis
                lots = 20000;
                cost = lots * 100 * (state.price + (CONFIG.tickSize * 5)); // Beli mahal
                if(state.cash >= cost) {
                    state.cash -= cost;
                    updateInventory(lots, state.price);
                    impact = CONFIG.tickSize * 10; // Terbang
                    state.sentiment += 15; // Trigger FOMO
                    msg = "HAKA!! ðŸš€";
                }
                break;

            case 'fakeWall':
                // Ganjal Bid, harga diam, sentiment slightly up (rasa aman)
                msg = "TEMBOK DIPASANG ðŸ›¡ï¸";
                state.sentiment += 5;
                // Visual only effect logic handled in renderOrderBook
                break;

            case 'dump':
                // Guyur Kiri, harga rontok, sentiment hancur
                if(state.inventory > 0) {
                    lots = Math.min(state.inventory, 20000);
                    let revenue = lots * 100 * (state.price - (CONFIG.tickSize * 5));
                    state.cash += revenue;
                    state.inventory -= lots;
                    impact = -(CONFIG.tickSize * 15); // Longsor
                    state.sentiment -= 25; // Trigger Panic
                    msg = "GUYUR BOS!! ðŸ“‰";
                } else {
                    showToast("Barang abis bos!");
                    return;
                }
                break;
        }

        if(msg) showToast(msg);
        updatePrice(impact);
        updateUI();
        renderChart(); // Force redraw
    };

    function updateInventory(lots, price) {
        // Simple Average Logic
        let currentVal = state.inventory * state.avgPrice;
        let newVal = lots * price;
        state.inventory += lots;
        state.avgPrice = (currentVal + newVal) / state.inventory;
    }

    // --- UI UPDATES & RENDERING ---

    function showToast(text) {
        let el = document.getElementById('toast');
        el.innerText = text;
        el.style.opacity = 1;
        el.style.transform = "translateX(-50%) translateY(-10px)";
        setTimeout(() => {
            el.style.opacity = 0;
            el.style.transform = "translateX(-50%) translateY(0)";
        }, 1500);
    }

    function updateUI() {
        // Format Rupiah
        document.getElementById('cashDisplay').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(state.cash);
        document.getElementById('inventoryDisplay').innerText = new Intl.NumberFormat('id-ID').format(state.inventory) + " Lot";
        
        // Calc PnL
        let marketVal = state.inventory * state.price;
        let costVal = state.inventory * state.avgPrice;
        let pnlPct = 0;
        if(state.inventory > 0) pnlPct = ((marketVal - costVal) / costVal) * 100;
        
        let pnlEl = document.getElementById('pnlDisplay');
        pnlEl.innerText = pnlPct.toFixed(2) + "%";
        pnlEl.style.color = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';
    }

    function updateSentimentMeter() {
        let bar = document.getElementById('sentimentBar');
        let text = document.getElementById('sentimentText');
        
        bar.style.width = state.sentiment + "%";
        
        if(state.sentiment > 70) {
            bar.style.backgroundColor = "var(--green)";
            text.innerText = "GREED / FOMO";
            text.style.color = "var(--green)";
        } else if (state.sentiment < 30) {
            bar.style.backgroundColor = "var(--red)";
            text.innerText = "EXTREME FEAR";
            text.style.color = "var(--red)";
        } else {
            bar.style.backgroundColor = "yellow";
            text.innerText = "NEUTRAL";
            text.style.color = "#e0e0e0";
        }
    }

    // --- GENERATORS (STREAM & ORDERBOOK) ---

    function generateRetailChat() {
        let type = "neutral";
        if(state.sentiment > 60) type = "bullish";
        if(state.sentiment < 40) type = "bearish";

        let msgs = chatTemplates[type];
        let msg = msgs[Math.floor(Math.random() * msgs.length)];
        let user = users[Math.floor(Math.random() * users.length)];

        addStreamChat(user, msg, type);
    }

    function addStreamChat(user, msg, type) {
        let feed = document.getElementById('streamFeed');
        let div = document.createElement('div');
        div.className = "stream-msg";
        
        let colorClass = type === 'bullish' ? 'user-bull' : (type === 'bearish' ? 'user-bear' : 'user-neutral');
        
        div.innerHTML = `
            <div>
                <span class="user-name ${colorClass}">${user}</span>
                <span class="time-stamp">${new Date().toLocaleTimeString('id-ID')}</span>
            </div>
            <div class="msg-content">${msg}</div>
        `;
        
        feed.prepend(div);
        if(feed.children.length > 20) feed.lastChild.remove();
    }

    function renderOrderBook() {
        let container = document.getElementById('orderbookContainer');
        let html = "";
        
        // Generate Fake Offer (Ask) - Upper side
        for(let i=5; i>=1; i--) {
            let p = state.price + (i * CONFIG.tickSize);
            let v = Math.floor(Math.random() * 5000) + 100;
            // Jika Smart Money mau jualan (inventory banyak), offer tebal
            if(state.inventory > 50000 && i === 3) v += 50000; 

            html += `
                <div class="ob-row ask-side">
                    <span class="ob-price">${p}</span>
                    <span class="ob-vol ${v > 20000 ? 'bandar-vol' : ''}">${v}</span>
                </div>
            `;
        }

        // Current Price Indicator
        html += `<div class="current-price-marker">${state.price}</div>`;

        // Generate Fake Bid - Lower side
        for(let i=1; i<=5; i++) {
            let p = state.price - (i * CONFIG.tickSize);
            if(p < 50) continue;
            let v = Math.floor(Math.random() * 5000) + 100;
            
            // Jika Sentimen bagus, bid tebal
            if(state.sentiment > 70 && i === 2) v += 10000;
            // Jika Bandar pasang tembok (Action Fake Wall)
            // Kita simulasikan efek visual tembok tebal di 3 tick bawah
            if(i === 3) v += Math.floor(Math.random() * 20000); 

            html += `
                <div class="ob-row bid-side">
                    <span class="ob-price">${p}</span>
                    <span class="ob-vol ${v > 15000 ? 'bandar-vol' : ''}">${v}</span>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // --- CHART CANVAS RENDERING ---
    let canvas, ctx;
    
    function resizeCanvas() {
        canvas = document.getElementById('chartCanvas');
        let parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        ctx = canvas.getContext('2d');
        renderChart();
    }

    function renderChart() {
        if(!ctx) return;
        let w = canvas.width;
        let h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "#121212";
        ctx.fillRect(0,0,w,h);

        // Find scale
        let allCandles = [...state.candles, state.currentCandle];
        let minPrice = Math.min(...allCandles.map(c => c.low));
        let maxPrice = Math.max(...allCandles.map(c => c.high));
        let padding = (maxPrice - minPrice) * 0.2;
        if(padding === 0) padding = 10;
        
        let range = (maxPrice + padding) - (minPrice - padding);
        let candleWidth = w / 60; 

        // Draw
        allCandles.forEach((c, index) => {
            let x = index * candleWidth;
            let yOpen = h - ((c.open - (minPrice - padding)) / range * h);
            let yClose = h - ((c.close - (minPrice - padding)) / range * h);
            let yHigh = h - ((c.high - (minPrice - padding)) / range * h);
            let yLow = h - ((c.low - (minPrice - padding)) / range * h);

            let isGreen = c.close >= c.open;
            ctx.fillStyle = isGreen ? "#00f0b5" : "#ff3b30";
            ctx.strokeStyle = isGreen ? "#00f0b5" : "#ff3b30";

            // Wick
            ctx.beginPath();
            ctx.moveTo(x + candleWidth/2, yHigh);
            ctx.lineTo(x + candleWidth/2, yLow);
            ctx.stroke();

            // Body
            let bodyHeight = Math.abs(yOpen - yClose);
            if(bodyHeight < 1) bodyHeight = 1;
            ctx.fillRect(x + 2, Math.min(yOpen, yClose), candleWidth - 4, bodyHeight);
        });

        // Price Line
        ctx.strokeStyle = "#ffffff";
        ctx.setLineDash([5, 5]);
        let yCurrent = h - ((state.price - (minPrice - padding)) / range * h);
        ctx.beginPath();
        ctx.moveTo(0, yCurrent);
        ctx.lineTo(w, yCurrent);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Start
    init();

</script>
</body>
</html>
