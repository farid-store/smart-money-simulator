<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANDAR TERMINAL PRO - INSTITUTIONAL GRADE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #000000; 
            --bg-panel: #131722; 
            --border: #2a2e39;
            --up: #26a69a; 
            --down: #ef5350;
            --text-main: #d1d4dc;
            --text-sec: #787b86;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        .mono { font-family: 'Roboto Mono', monospace; }
        .text-up { color: var(--up); } .text-down { color: var(--down); }
        .bg-up { background-color: var(--up); } .bg-down { background-color: var(--down); }
        
        /* Layout Grid */
        .grid-main { display: grid; grid-template-columns: 280px 1fr 320px; grid-template-rows: 50px 1fr 200px; height: 100vh; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Orderbook Animation */
        .flash-bid { animation: flashG 0.2s ease-out; }
        .flash-ask { animation: flashR 0.2s ease-out; }
        @keyframes flashG { 0% { background: rgba(38, 166, 154, 0.5); } 100% { background: transparent; } }
        @keyframes flashR { 0% { background: rgba(239, 83, 80, 0.5); } 100% { background: transparent; } }

        .btn-action { transition: all 0.1s; transform: translateY(0); }
        .btn-action:active { transform: translateY(2px); }
    </style>
</head>
<body>

<div class="grid-main">
    
    <header class="col-span-3 bg-[#131722] border-b border-[#2a2e39] flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-6">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-bold tracking-widest">SYMBOL</span>
                <span class="text-lg font-black tracking-tighter text-yellow-500">GOTO.JK <span class="text-[10px] bg-gray-800 text-gray-300 px-1 rounded ml-1">RG</span></span>
            </div>
            <div class="h-6 w-px bg-[#2a2e39]"></div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-bold">LAST</span>
                <span id="header-price" class="text-xl font-bold mono text-white">82</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-bold">CHANGE</span>
                <span id="header-pct" class="text-sm font-bold mono text-up">+0.00%</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-bold">VOL (LOT)</span>
                <span id="header-vol" class="text-sm font-bold mono text-gray-300">0</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="text-right">
                <div class="text-[9px] uppercase text-purple-400 font-bold">Net Foreign Buy/Sell</div>
                <div id="foreign-flow" class="text-sm font-mono font-bold text-gray-400">0 M</div>
            </div>
            <div class="h-6 w-px bg-[#2a2e39]"></div>
            <div class="flex items-center gap-2 px-3 py-1 bg-[#2a2e39] rounded border border-gray-700">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[10px] font-bold text-gray-300">MARKET OPEN</span>
            </div>
        </div>
    </header>

    <aside class="row-span-2 bg-[#131722] border-r border-[#2a2e39] flex flex-col overflow-hidden">
        <div class="p-3 border-b border-[#2a2e39] bg-[#1e222d]">
            <h2 class="text-[11px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                MM Control Panel
            </h2>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-4">
            
            <div class="bg-[#181c25] p-3 rounded border border-[#2a2e39]">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[11px] font-bold text-purple-400">ICEBERG (ACCUM)</span>
                    <div id="status-iceberg" class="w-1.5 h-1.5 rounded-full bg-gray-600"></div>
                </div>
                <p class="text-[9px] text-gray-500 mb-2 leading-relaxed">
                    Menahan harga Bid. Bid volume terlihat kecil, tapi auto-refill saat dimakan retail.
                </p>
                <button onclick="Engine.toggleAlgo('ICEBERG')" class="btn-action w-full py-1.5 bg-[#2a2e39] hover:bg-gray-600 text-[10px] font-bold text-white rounded border border-gray-600">
                    TOGGLE GHOST BID
                </button>
            </div>

            <div class="bg-[#181c25] p-3 rounded border border-[#2a2e39]">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[11px] font-bold text-red-400">SPOOFING (WALL)</span>
                    <div id="status-spoof" class="w-1.5 h-1.5 rounded-full bg-gray-600"></div>
                </div>
                <p class="text-[9px] text-gray-500 mb-2 leading-relaxed">
                    Memasang tembok Offer 1 Juta Lot palsu. Akan dicabut otomatis jika harga mendekat.
                </p>
                <button onclick="Engine.toggleAlgo('SPOOF')" class="btn-action w-full py-1.5 bg-[#2a2e39] hover:bg-red-900/40 text-[10px] font-bold text-white rounded border border-gray-600 hover:border-red-500">
                    TOGGLE FAKE OFFER
                </button>
            </div>

            <hr class="border-[#2a2e39]">

            <div>
                <span class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Manual Override</span>
                <div class="grid grid-cols-2 gap-2">
                    <button onmousedown="Engine.manualTrade('BUY')" class="btn-action py-3 bg-up hover:brightness-110 text-[#000] font-black text-xs rounded shadow-lg flex flex-col items-center">
                        <span>HAKA (BUY)</span>
                        <span class="text-[8px] opacity-70 font-normal">Markup Price</span>
                    </button>
                    <button onmousedown="Engine.manualTrade('SELL')" class="btn-action py-3 bg-down hover:brightness-110 text-white font-black text-xs rounded shadow-lg flex flex-col items-center">
                        <span>HKI (SELL)</span>
                        <span class="text-[8px] opacity-70 font-normal">Dump Price</span>
                    </button>
                </div>
            </div>

            <div class="mt-4">
                 <span class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Top Broker Action</span>
                 <div id="broker-activity" class="text-[10px] font-mono space-y-1">
                     </div>
            </div>

        </div>
    </aside>

    <main class="relative bg-[#000] flex flex-col overflow-hidden">
        <div id="tv-chart" class="w-full h-full"></div>
        
        <div class="absolute top-2 left-2 pointer-events-none bg-[#131722]/80 p-2 rounded border border-[#2a2e39] backdrop-blur-sm">
            <div class="text-[10px] text-gray-400 font-bold">ALGO STATUS</div>
            <div id="chart-status" class="text-xs font-mono text-up font-bold">NORMAL MARKET</div>
        </div>
    </main>

    <aside class="row-span-2 bg-[#131722] border-l border-[#2a2e39] flex flex-col">
        
        <div class="flex-1 flex flex-col min-h-0 border-b border-[#2a2e39]">
            <div class="px-2 py-1 bg-[#1e222d] border-b border-[#2a2e39] text-[10px] font-bold text-gray-400 flex justify-between">
                <span>ORDER BOOK</span>
                <span class="text-gray-600">L2 DATA</span>
            </div>
            
            <div class="grid grid-cols-3 text-[9px] text-gray-500 px-2 py-1 font-bold">
                <div class="text-right">BID VOL</div>
                <div class="text-center">PRICE</div>
                <div class="text-right">ASK VOL</div>
            </div>

            <div id="orderbook-container" class="flex-1 overflow-hidden relative font-mono text-[11px]">
                </div>
        </div>

        <div class="h-[250px] flex flex-col bg-[#000]">
            <div class="px-2 py-1 bg-[#1e222d] border-y border-[#2a2e39] text-[10px] font-bold text-gray-400 flex justify-between">
                <span>RUNNING TRADE</span>
                <span>REALTIME</span>
            </div>
            <div id="tape-container" class="flex-1 overflow-y-auto font-mono text-[10px] bg-[#131722]">
                </div>
        </div>

    </aside>

    <div class="col-start-2 bg-[#131722] border-t border-[#2a2e39] flex items-center justify-between px-4">
        <div class="flex gap-6 text-[10px] font-mono text-gray-500">
            <span>OPEN: <span class="text-white">80</span></span>
            <span>HIGH: <span class="text-white" id="stat-h">82</span></span>
            <span>LOW: <span class="text-white" id="stat-l">79</span></span>
            <span>VWAP: <span class="text-yellow-500" id="stat-vwap">81.4</span></span>
        </div>
        <div class="text-[10px] text-gray-600 italic">
            Connected to Local Liquidity Provider
        </div>
    </div>

</div>

<script>
    // --- 1. SETUP TRADINGVIEW CHART ---
    const chartContainer = document.getElementById('tv-chart');
    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: chartContainer.clientHeight,
        layout: {
            background: { type: 'solid', color: '#000000' },
            textColor: '#d1d4dc',
        },
        grid: {
            vertLines: { color: '#1f2937' },
            horzLines: { color: '#1f2937' },
        },
        rightPriceScale: {
            borderColor: '#2a2e39',
            scaleMargins: { top: 0.1, bottom: 0.2 }, // Space for volume
        },
        timeScale: {
            borderColor: '#2a2e39',
            timeVisible: true,
            secondsVisible: true,
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
    });

    // Series
    const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        borderUpColor: '#26a69a', borderDownColor: '#ef5350',
        wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    });

    const volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: { type: 'volume' },
        priceScaleId: '', // Overlay mode
    });
    
    // Config volume to sit at bottom
    volumeSeries.priceScale().applyOptions({
        scaleMargins: { top: 0.8, bottom: 0 },
    });

    const vwapSeries = chart.addLineSeries({
        color: '#fbbf24', // Yellow
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        crosshairMarkerVisible: false,
    });

    // Resize Handler
    new ResizeObserver(entries => {
        if (entries.length === 0 || entries[0].target !== chartContainer) { return; }
        const newRect = entries[0].contentRect;
        chart.applyOptions({ width: newRect.width, height: newRect.height });
    }).observe(chartContainer);

    // --- 2. DATA ENGINE ---
    
    // Initial Data Generation
    let currentPrice = 82;
    let initialData = [];
    let volumeData = [];
    let vwapData = [];
    let time = Math.floor(Date.now() / 1000) - 3600; // Start 1 hour ago

    // Generate history
    for(let i=0; i<200; i++) {
        time += 60; // 1 min candles
        const open = currentPrice;
        const close = open + (Math.random() - 0.5) * 2;
        const high = Math.max(open, close) + Math.random();
        const low = Math.min(open, close) - Math.random();
        const vol = Math.floor(Math.random() * 5000) + 500;
        
        currentPrice = close;
        
        initialData.push({ time, open, high, low, close });
        volumeData.push({ 
            time, 
            value: vol, 
            color: close >= open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' 
        });
        vwapData.push({ time, value: (high+low+close)/3 }); // Simple VWAP approx
    }

    candleSeries.setData(initialData);
    volumeSeries.setData(volumeData);
    vwapSeries.setData(vwapData);

    // Live Candle State
    let lastCandle = initialData[initialData.length - 1];
    let lastVol = volumeData[volumeData.length - 1];
    let currentBar = {
        open: lastCandle.close,
        high: lastCandle.close,
        low: lastCandle.close,
        close: lastCandle.close,
        time: lastCandle.time + 60,
    };
    let currentVol = 0;

    // --- 3. MARKET MAKER LOGIC ---
    
    const Engine = {
        price: currentBar.close,
        bids: [],
        asks: [],
        trades: [],
        
        // Algos
        isIceberg: false,
        icebergPrice: 0,
        isSpoof: false,
        spoofPrice: 0,
        
        // Brokers
        bandarCodes: ['MG', 'BK', 'AK', 'ZP', 'CC'],
        retailCodes: ['YP', 'PD', 'NI', 'XL', 'KK'],

        init() {
            this.generateOB();
            this.renderOB();
            setInterval(() => this.tick(), 500); // Game Loop
        },

        generateOB() {
            this.bids = [];
            this.asks = [];
            for(let i=1; i<=10; i++) {
                this.bids.push({ p: Math.floor(this.price - i), v: Math.floor(Math.random()*5000), type: 'NORMAL' });
                this.asks.push({ p: Math.floor(this.price + i), v: Math.floor(Math.random()*5000), type: 'NORMAL' });
            }
        },

        toggleAlgo(type) {
            if(type === 'ICEBERG') {
                this.isIceberg = !this.isIceberg;
                document.getElementById('status-iceberg').className = `w-1.5 h-1.5 rounded-full ${this.isIceberg ? 'bg-green-500 shadow-[0_0_5px_lime]' : 'bg-gray-600'}`;
                if(this.isIceberg) {
                    this.icebergPrice = this.bids[0].p;
                    this.bids[0].v = 112; // Visual small
                    this.bids[0].type = 'ICEBERG';
                    UI.notify("ICEBERG ACTIVE", "text-up");
                } else {
                    this.bids[0].type = 'NORMAL';
                    this.bids[0].v = Math.floor(Math.random()*2000);
                }
            }
            if(type === 'SPOOF') {
                this.isSpoof = !this.isSpoof;
                document.getElementById('status-spoof').className = `w-1.5 h-1.5 rounded-full ${this.isSpoof ? 'bg-red-500 shadow-[0_0_5px_red]' : 'bg-gray-600'}`;
                if(this.isSpoof) {
                    // Create wall at +3 ticks
                    if(this.asks[2]) {
                        this.spoofPrice = this.asks[2].p;
                        this.asks[2].v = 550000; // Big wall
                        this.asks[2].type = 'SPOOF';
                        UI.notify("SPOOF WALL DEPLOYED", "text-down");
                    }
                } else {
                    const wall = this.asks.find(a => a.type === 'SPOOF');
                    if(wall) { wall.type = 'NORMAL'; wall.v = Math.random()*5000; }
                }
            }
            this.renderOB();
        },

        manualTrade(side) {
            const qty = Math.floor(Math.random() * 500) + 1000;
            this.executeTrade(this.price, qty, side, 'BANDAR');
        },

        executeTrade(price, qty, side, aggressor) {
            // Update Price Logic
            if(side === 'BUY') {
                // Eat Ask
                this.price += (qty > 5000 ? 1 : 0.5); // Impact
                if(this.isSpoof && this.price >= this.spoofPrice - 1) {
                    // Pull the wall if price gets close
                    this.toggleAlgo('SPOOF'); // Deactivate
                    UI.notify("ALGO: WALL PULLED (SAFEGUARD)", "text-yellow-500");
                }
            } else {
                // Hit Bid
                // Iceberg Logic
                if(this.isIceberg && this.price <= this.icebergPrice + 0.5) {
                     this.price = this.icebergPrice; // Hold price
                     // Refill volume animation (logic only)
                } else {
                    this.price -= (qty > 5000 ? 1 : 0.5);
                }
            }
            
            // Round price
            this.price = Math.round(this.price * 2) / 2; // Tick size 0.5? Let's assume integer for simpler ID stock
            this.price = Math.round(this.price); 

            // Update Chart
            this.updateCandle(this.price, qty, side);
            
            // Tape & OB
            this.trades.unshift({ 
                t: new Date().toLocaleTimeString(), 
                p: this.price, 
                q: qty, 
                s: side,
                b: aggressor === 'BANDAR' ? this.getRandomBroker(true) : this.getRandomBroker(false),
                sl: this.getRandomBroker(false)
            });
            if(this.trades.length > 50) this.trades.pop();
            
            this.regenerateOBRows();
            this.renderTape();
            this.renderOB();
            UI.updateHeader();
        },

        tick() {
            // Random Market Noise
            if(Math.random() > 0.6) {
                const side = Math.random() > 0.5 ? 'BUY' : 'SELL';
                const qty = Math.floor(Math.random() * 100) + 10;
                this.executeTrade(this.price, qty, side, 'RETAIL');
            }
            // Update timestamp for chart
            if (Date.now()/1000 > currentBar.time + 60) {
                // Close candle
                currentBar = {
                    open: currentBar.close,
                    high: currentBar.close,
                    low: currentBar.close,
                    close: currentBar.close,
                    time: currentBar.time + 60
                };
                currentVol = 0;
            }
        },

        updateCandle(price, vol, side) {
            currentVol += vol;
            currentBar.close = price;
            if(price > currentBar.high) currentBar.high = price;
            if(price < currentBar.low) currentBar.low = price;

            candleSeries.update(currentBar);
            volumeSeries.update({
                time: currentBar.time,
                value: currentVol,
                color: currentBar.close >= currentBar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
            });
        },

        regenerateOBRows() {
            // Keep OB centered around price
            const center = this.price;
            // Update existing or create new
            // Simplified: just regen for demo smoothness
            this.bids = [];
            this.asks = [];
            for(let i=1; i<=8; i++) {
                // Bids
                let bidP = center - i;
                let bidV = Math.floor(Math.random() * 3000) + 100;
                let bidType = 'NORMAL';
                
                if(this.isIceberg && bidP === this.icebergPrice) {
                    bidV = Math.floor(Math.random() * 100) + 50; // Show small
                    bidType = 'ICEBERG';
                }
                this.bids.push({ p: bidP, v: bidV, type: bidType });

                // Asks
                let askP = center + i;
                let askV = Math.floor(Math.random() * 3000) + 100;
                let askType = 'NORMAL';

                if(this.isSpoof && askP === this.spoofPrice) {
                    askV = 500000;
                    askType = 'SPOOF';
                }
                this.asks.push({ p: askP, v: askV, type: askType });
            }
        },

        getRandomBroker(isBandar) {
            const arr = isBandar ? this.bandarCodes : this.retailCodes;
            return arr[Math.floor(Math.random() * arr.length)];
        },

        renderOB() {
            const el = document.getElementById('orderbook-container');
            let html = '<div class="flex flex-col h-full">';
            
            // Asks (Red) - Reverse order (High price on top)
            let asksHtml = '<div class="flex-1 flex flex-col justify-end">';
            [...this.asks].reverse().forEach(a => {
                const barW = Math.min(a.v/5000 * 100, 100);
                const isSpoof = a.type === 'SPOOF';
                asksHtml += `
                <div class="grid grid-cols-3 text-[11px] hover:bg-[#1e222d] relative border-b border-[#1f2937] ${isSpoof ? 'bg-red-900/30 animate-pulse' : ''}">
                    <div class="text-right text-gray-700 py-0.5 z-10">-</div>
                    <div class="text-center text-down font-bold py-0.5 z-10">${a.p}</div>
                    <div class="text-right text-white py-0.5 pr-2 z-10 font-bold">${a.v.toLocaleString()}</div>
                    <div class="absolute right-0 top-0 bottom-0 bg-red-900/20" style="width:${isSpoof ? 100 : barW}%"></div>
                </div>`;
            });
            asksHtml += '</div>';

            // Spread
            let spreadHtml = `<div class="h-6 flex items-center justify-center bg-[#1e222d] border-y border-[#2a2e39] text-[10px] text-gray-500 font-bold">SPREAD</div>`;

            // Bids (Green)
            let bidsHtml = '<div class="flex-1 flex flex-col">';
            this.bids.forEach(b => {
                const barW = Math.min(b.v/5000 * 100, 100);
                const isIce = b.type === 'ICEBERG';
                bidsHtml += `
                <div class="grid grid-cols-3 text-[11px] hover:bg-[#1e222d] relative border-b border-[#1f2937] ${isIce ? 'bg-green-900/30' : ''}">
                    <div class="text-right text-white font-bold py-0.5 z-10">${b.v.toLocaleString()}</div>
                    <div class="text-center text-up font-bold py-0.5 z-10">${b.p}</div>
                    <div class="text-right text-gray-700 py-0.5 pr-2 z-10">-</div>
                    <div class="absolute left-0 top-0 bottom-0 bg-green-900/20" style="width:${barW}%"></div>
                    ${isIce ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-green-500 animate-pulse"></div>' : ''}
                </div>`;
            });
            bidsHtml += '</div>';

            el.innerHTML = asksHtml + spreadHtml + bidsHtml;
        },

        renderTape() {
            const el = document.getElementById('tape-container');
            const html = this.trades.map(t => {
                const color = t.s === 'BUY' ? 'text-up' : 'text-down';
                // Highlight Bandar Broker
                const bCol = this.bandarCodes.includes(t.b) ? 'text-purple-400 font-black' : 'text-gray-500';
                return `
                <div class="grid grid-cols-4 px-2 py-0.5 border-b border-[#1f2937] hover:bg-[#1e222d]">
                    <span class="text-gray-500">${t.t}</span>
                    <span class="${color} font-bold text-center">${t.p}</span>
                    <span class="text-white text-right font-mono">${t.q}</span>
                    <span class="${bCol} text-right">${t.b}</span>
                </div>`;
            }).join('');
            el.innerHTML = html;
        }
    };

    const UI = {
        updateHeader() {
            document.getElementById('header-price').innerText = Engine.price;
            // Simplified stat update
            document.getElementById('header-vol').innerText = Engine.trades.reduce((acc, t) => acc + t.q, 0).toLocaleString();
        },
        notify(msg, colorClass) {
            const el = document.getElementById('chart-status');
            el.innerText = msg;
            el.className = `text-xs font-mono font-bold ${colorClass} animate-pulse`;
            setTimeout(() => {
                el.innerText = "NORMAL MARKET";
                el.className = "text-xs font-mono text-up font-bold";
            }, 3000);
        }
    };

    Engine.init();

</script>
</body>
</html>
